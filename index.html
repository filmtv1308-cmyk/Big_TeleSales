<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Big TeleSales ‚Äî –õ–æ–∫–∞–ª—å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#4f46e5" />

  <!-- Tailwind via CDN (per requirements of this environment) -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <!-- Bootstrap 5 (UX/UI layer) + Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- SheetJS (XLSX) for Excel operations -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      /* Sidebar: always collapsed, max ~7% of viewport width */
      --sidebar-w-collapsed: clamp(72px, 7vw, 96px);
      --sidebar-w: var(--sidebar-w-collapsed);

      --catalog-sidebar-w: 270px;

      /* Brand tokens */
      --brand: #4f46e5; /* indigo-600 */
      --brand-700: #4338ca;
      --bg: #f6f8fc;
      --card: #ffffff;
      --border: rgba(15, 23, 42, .10);
      --text: #0f172a;
      --muted: rgba(15, 23, 42, .65);
      --shadow: 0 10px 24px rgba(15, 23, 42, .06);
    }

    html, body { height: 100%; }

    /* --- Global look --- */
    body{
      background: radial-gradient(1200px 500px at 10% 0%, rgba(79,70,229,.08), transparent 60%),
                  radial-gradient(900px 400px at 90% 10%, rgba(16,185,129,.06), transparent 55%),
                  var(--bg);
      color: var(--text);
    }

    /* Improve text rendering */
    *{ -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

    /* Focus ring (accessible) */
    :focus-visible{ outline: none; box-shadow: 0 0 0 3px rgba(79,70,229,.25) !important; }

    /* --- Sidebar --- */
    .sidebar { width: var(--sidebar-w); }
    .sidebar.collapsed { width: var(--sidebar-w-collapsed); }
    .sidebar .label { transition: opacity .18s ease; }
    .sidebar.collapsed .label { opacity: 0; pointer-events: none; }
    .sidebar.collapsed .if-expanded { display: none; }
    .sidebar:not(.collapsed) .if-collapsed { display: none; }

    /* Always-collapsed sidebar behavior */
    #sidebar{ width: var(--sidebar-w-collapsed) !important; }
    #sidebar .label{ opacity: 0 !important; pointer-events: none !important; }
    #toggleSidebar{ display:none !important; }

    /* Tooltip on hover for sidebar menu items (uses title attribute on <a>) */
    #sidebar .menu-link{ position: relative; }
    #sidebar .menu-link::after{
      content: attr(title);
      position: absolute;
      left: calc(100% + 10px);
      top: 50%;
      transform: translateY(-50%);
      background: rgba(15,23,42,.92);
      color: #fff;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 10px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity .12s ease, transform .12s ease;
      box-shadow: 0 14px 28px rgba(2,6,23,.22);
      z-index: 80;
    }
    #sidebar .menu-link:hover::after{ opacity: 1; transform: translateY(-50%) translateX(2px); }

    /* Sidebar visual polish */
    #sidebar{
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.98));
      border-right: 1px solid var(--border);
      backdrop-filter: blur(8px);
    }

    /* Scrollbars */
    ::-webkit-scrollbar { width: 10px; height: 10px; }

    /* Safety: ensure .hidden always hides elements (prevents grid/table split-screen issues) */
    .hidden{ display: none !important; }
    ::-webkit-scrollbar-track { background: rgba(148,163,184,.15); }
    ::-webkit-scrollbar-thumb { background: rgba(148,163,184,.55); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(100,116,139,.7); }

    /* Simple icon circle */
    .icon-circle {
      width: 38px; height: 38px;
      border-radius: 9999px;
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 8px 16px rgba(79,70,229,.10);
    }

    /* Menu links: add subtle micro-interactions */
    .menu-link{
      transition: background-color .15s ease, color .15s ease, transform .15s ease, box-shadow .15s ease;
      position: relative;
    }
    .menu-link:hover{ transform: translateX(1px); }
    .menu-link.bg-indigo-100{
      background: rgba(79,70,229,.10) !important;
      color: var(--brand) !important;
      box-shadow: 0 8px 18px rgba(79,70,229,.08);
    }
    .menu-link.bg-indigo-100::before{
      content:'';
      position:absolute;
      left:6px;
      top:10px;
      bottom:10px;
      width:3px;
      border-radius: 999px;
      background: var(--brand);
    }

    /* Header visual polish */
    header{ background: rgba(255,255,255,.86) !important; backdrop-filter: blur(10px); border-bottom: 1px solid var(--border) !important; }
    header a, header button{ transition: background-color .15s ease, color .15s ease; }

    /* Cards style normalization (works with existing Tailwind classes) */
    .bg-white.border.rounded-xl.shadow-sm{ box-shadow: var(--shadow) !important; border-color: var(--border) !important; }

    /* Toasts */
    #toast-container { position: fixed; bottom: 16px; right: 16px; z-index: 60; display: flex; flex-direction: column; gap: 10px; }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(2,6,23,.55); display: flex; align-items: center; justify-content: center; z-index: 70; padding: 16px; }
    .modal-card {
      width: 95vw;
      max-width: 860px;
      max-height: 92vh;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 30px 80px rgba(2,6,23,.28);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .modal-card #modalContent{
      overflow: auto;
      min-height: 0;
      -webkit-overflow-scrolling: touch;
    }
    /* Product modal: compact size (narrow + shorter). Requested: reduce height ~35% */
    .modal-card.modal-product{ max-width: 330px; max-height: 65vh; }
    .modal-card.modal-product #modalContent{ max-height: calc(65vh - 120px); overflow: auto; }

    /* Badge */
    .badge { font-size: 11px; line-height: 1; padding: 3px 8px; border-radius: 9999px; }

    /* Inputs & buttons global polish (without changing markup) */
    input[type="text"], input[type="email"], input[type="password"], input[type="date"], input[type="search"], input[type="number"], select{
      border-color: rgba(15,23,42,.14) !important;
      box-shadow: none !important;
    }
    input:focus, select:focus{ border-color: rgba(79,70,229,.50) !important; }

    /* Offcanvas Cart */
    #cartOverlay { position: fixed; inset: 0; background: rgba(2,6,23,.55); z-index: 60; opacity: 0; pointer-events: none; transition: opacity .18s; }
    #cartPanel { position: fixed; top: 0; right: 0; height: 100%; width: min(460px, 92vw); background: #fff; box-shadow: -18px 0 60px rgba(2,6,23,.22); z-index: 61; transform: translateX(100%); transition: transform .22s ease; display: flex; flex-direction: column; }
    #cartOverlay.open { opacity: 1; pointer-events: auto; }
    #cartPanel.open { transform: translateX(0); }

    /* Catalog page */
    .catalog-layout { display: grid; grid-template-columns: var(--catalog-sidebar-w) 1fr; gap: 16px; }
    @media (max-width: 1024px){ .catalog-layout { grid-template-columns: 1fr; } }

    /* Catalog: sticky left filters (so it doesn't scroll away) */
    #catLayout > aside{
      position: sticky;
      top: 76px; /* below the sticky top bar */
      align-self: start;
      max-height: calc(100vh - 96px);
      overflow: auto;
    }
    @media (max-width: 1024px){
      #catLayout > aside{
        position: relative;
        top: auto;
        max-height: none;
        overflow: visible;
      }
    }

    /* Catalog: filters hidden by default (toggle via JS) */
    .catalog-layout.filters-hidden{ grid-template-columns: 1fr; }
    .catalog-layout.filters-hidden > aside{ display: none !important; }

    /* Grid and product images moved to external CSS (css/components.css) */

    /* Removed "–£–∂–µ —Å–∫–æ—Ä–æ" badge overlay per new requirements */

    .carousel-dots { display:flex; gap:6px; justify-content:center; }
    .carousel-dot { width:8px; height:8px; border-radius:9999px; background: rgba(148,163,184,.65); }
    .carousel-dot.active { background: var(--brand); }

    /* Promo cards moved to external CSS (css/components.css) */

    /* Catalog: sticky top controls (search/sort/top sku) */
    .catalog-sticky-bar{
      position: sticky;
      top: 0;
      z-index: 55;
      background: rgba(255,255,255,.72) !important;
      backdrop-filter: blur(14px);
      border-color: var(--border) !important;
      box-shadow: 0 10px 22px rgba(15,23,42,.08);
    }

    /* Subtle glass helper (optional use) */
    .glass{ background: rgba(255,255,255,.78); backdrop-filter: blur(10px); border: 1px solid var(--border); }

    /* --- UX/UI helpers (borrowed from provided reference) --- */
    html{ font-size: 15px; }
    body{ font-size: .95rem; }

    .scrollbar-thin{ scrollbar-width: thin; }
    .scrollbar-thin::-webkit-scrollbar{ height: 8px; width: 8px; }
    .scrollbar-thin::-webkit-scrollbar-thumb{ background: rgba(148,163,184,.75); border-radius: 999px; }

    mark{ background: #fef3c7; color: inherit; padding: 0 2px; border-radius: 4px; }

    /* Skeleton shimmer for lazy images */
    .skeleton{
      background: linear-gradient(90deg, rgba(0,0,0,0.06), rgba(0,0,0,0.12), rgba(0,0,0,0.06));
      background-size: 200% 100%;
      animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer{ 0%{ background-position: 200% 0; } 100%{ background-position: -200% 0; } }

    /* Title clamp for product cards/table */
    .two-line-title{
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 13px;
      line-height: 1.3;
      min-height: calc(1.3em * 3);
      max-height: calc(1.3em * 3);
    }
    .title-3lines{
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.3;
      max-height: calc(1.3em * 3);
    }

    /* Global soft rounded theme */
    :root{
      --radius-sm: 10px;
      --radius-md: 14px;
      --radius-lg: 18px;
    }

    .soft-rounded .btn,
    .soft-rounded input,
    .soft-rounded select,
    .soft-rounded textarea,
    .soft-rounded .rounded,
    .soft-rounded .rounded-lg,
    .soft-rounded .rounded-xl,
    .soft-rounded .rounded-2xl,
    .soft-rounded .dropdown-menu,
    .soft-rounded .modal-card,
    .soft-rounded .toast,
    .soft-rounded .border,
    .soft-rounded .shadow-sm{
      border-radius: var(--radius-md) !important;
    }
    .soft-rounded .badge{ border-radius: 9999px !important; }

    /* Catalog: make filters look more premium */
    #catFilters details{ border: 1px solid var(--border); border-radius: var(--radius-md); padding: 8px 10px; background: rgba(248,250,252,.8); }
    #catFilters details + details{ margin-top: 10px; }
    #catFilters summary{ list-style: none; font-weight: 600; color: rgba(15,23,42,.85); }
    #catFilters summary::-webkit-details-marker{ display: none; }
    #catFilters summary::after{ content: '‚ñæ'; float: right; color: rgba(100,116,139,.9); transition: transform .15s ease; }
    #catFilters details[open] summary::after{ transform: rotate(180deg); }
    #catFilters input[type="checkbox"]{ width: 16px; height: 16px; }

    /* Catalog cards hover */
    .product-card{ transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease; }
    .product-card:hover{ transform: translateY(-1px); box-shadow: 0 16px 34px rgba(2,6,23,.10); }

    /* Keep header compact */
    header{ max-height: 20vh; }
  </style>

  <!-- Pastel iOS-like theme overrides (external CSS) -->
  <link rel="stylesheet" href="css/theme.css" />
  <link rel="stylesheet" href="css/components.css" />
</head>
<body class="text-gray-900 soft-rounded">
  <div id="app-root"></div>
  <div id="toast-container"></div>

  <!-- Offline indicator (PWA/Offline UX) -->
  <div id="offline-indicator" class="d-none position-fixed top-0 start-50 translate-middle-x mt-2 badge bg-warning text-dark" style="z-index:80">
    ‚ö†Ô∏è Offline —Ä–µ–∂–∏–º
  </div>

  <!-- LOGIN TEMPLATE -->
  <template id="tpl-login">
    <div class="min-h-screen grid place-items-center px-4">
      <div class="w-full max-w-md bg-white rounded-2xl shadow-sm border p-6">
        <div class="flex items-start gap-3 mb-4">
          <div class="icon-circle bg-indigo-50 text-indigo-700"><i class="bi bi-telephone"></i></div>
          <div class="min-w-0">
            <div class="text-xl font-semibold leading-tight">Big TeleSales</div>
            <div class="text-gray-500 text-sm">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</div>
          </div>
        </div>

        <div class="rounded-xl border bg-indigo-50/40 p-3 mb-4 text-sm text-indigo-900">
          <div class="flex gap-2 items-center">
            <i class="bi bi-shield-lock"></i>
            <div class="min-w-0">
              <div class="font-medium">–î–æ—Å—Ç—É–ø –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É</div>
              <div class="text-xs text-indigo-900/70">–ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥: <b>admin@bigtelesales.local</b> / <b>admin123</b></div>
            </div>
          </div>
        </div>

        <form id="loginForm" class="space-y-4">
          <div>
            <label class="block text-sm mb-1 text-gray-700">Email</label>
            <div class="relative">
              <i class="bi bi-envelope absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
              <input type="email" id="loginEmail" class="w-full border rounded-lg pl-10 pr-3 py-2 focus:outline-none" placeholder="user@bigtelesales.local" required />
            </div>
          </div>
          <div>
            <label class="block text-sm mb-1 text-gray-700">–ü–∞—Ä–æ–ª—å</label>
            <div class="relative">
              <i class="bi bi-key absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
              <input type="password" id="loginPassword" class="w-full border rounded-lg pl-10 pr-10 py-2 focus:outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
              <button type="button" id="togglePwd" class="absolute inset-y-0 right-0 px-3 text-gray-500 hover:text-gray-700" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å"><i class="bi bi-eye"></i></button>
            </div>
          </div>
          <button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium">–í–æ–π—Ç–∏</button>
        </form>

        <div class="mt-5 border-t pt-4">
          <div class="text-sm text-gray-700 font-medium mb-2">–ü—Ä–æ–±–ª–µ–º—ã —Å–æ –≤—Ö–æ–¥–æ–º?</div>
          <div class="flex flex-wrap gap-2">
            <button id="loginResetAdmin" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50"><i class="bi bi-arrow-counterclockwise"></i> –°–±—Ä–æ—Å–∏—Ç—å admin</button>
            <button id="loginClearSession" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50"><i class="bi bi-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å —Å–µ—Å—Å–∏—é</button>
            <button id="loginReinitDB" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50 text-red-600"><i class="bi bi-exclamation-triangle"></i> –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ë–î</button>
          </div>
        </div>
      </div>

      <div class="mt-6 text-xs text-gray-500 text-center max-w-md">
        –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ Excel.
      </div>
    </div>
  </template>

  <!-- APP TEMPLATE -->
  <template id="tpl-app">
    <div class="h-screen flex">
      <!-- Sidebar -->
      <aside id="sidebar" class="sidebar flex flex-col transition-all duration-200">
        <div class="p-4 flex items-center justify-between border-b" style="border-color: var(--border)">
          <div class="flex items-center gap-3 min-w-0">
            <div class="icon-circle bg-indigo-50 text-indigo-700"><i class="bi bi-telephone"></i></div>
            <div class="label min-w-0">
              <div class="text-lg font-semibold leading-tight truncate">Big TeleSales</div>
              <div class="text-xs text-gray-500 -mt-0.5 truncate">–õ–æ–∫–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>
            </div>
          </div>
          <button id="toggleSidebar" class="text-gray-500 hover:text-gray-700" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å"><i class="bi bi-layout-sidebar-inset"></i></button>
        </div>

        <nav class="flex-1 overflow-auto py-2">
          <ul id="menu" class="px-2 space-y-1">
            <li>
              <a data-page="analytics" title="–ê–Ω–∞–ª–∏—Ç–∏–∫–∞" class="menu-link flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-indigo-50 text-gray-700">
                <span class="text-lg"><i class="bi bi-bar-chart"></i></span>
                <span class="label">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
              </a>
            </li>
            <li>
              <a data-page="televisits" class="menu-link flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-indigo-50 text-gray-700">
                <span class="text-lg"><i class="bi bi-headset"></i></span>
                <span class="label">–¢–µ–ª–µ–≤–∏–∑–∏—Ç—ã</span>
              </a>
            </li>
            <li>
              <a data-page="catalog" class="menu-link flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-indigo-50 text-gray-700">
                <span class="text-lg"><i class="bi bi-box-seam"></i></span>
                <span class="label">–ö–∞—Ç–∞–ª–æ–≥</span>
              </a>
            </li>
            <li>
              <a data-page="orders" class="menu-link flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-indigo-50 text-gray-700">
                <span class="text-lg"><i class="bi bi-receipt"></i></span>
                <span class="label">–ó–∞–∫–∞–∑—ã</span>
              </a>
            </li>
            <li class="admin-only">
              <a data-page="admin" class="menu-link flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-indigo-50 text-gray-700">
                <span class="text-lg"><i class="bi bi-gear"></i></span>
                <span class="label">–ê–¥–º–∏–Ω. –ø–∞–Ω–µ–ª—å</span>
              </a>
            </li>
          </ul>
        </nav>

        <div class="border-t p-3 flex items-center justify-between" style="border-color: var(--border)">
          <div class="label text-sm text-gray-600 min-w-0">
            <div id="userNameLabel" class="font-medium truncate">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
            <div id="userRoleLabel" class="text-xs text-gray-500 truncate">—Ä–æ–ª—å</div>
          </div>
          <button id="logoutBtn" class="text-red-600 hover:text-red-700 text-sm" title="–í—ã–π—Ç–∏"><i class="bi bi-box-arrow-right"></i> <span class="label">–í—ã–π—Ç–∏</span></button>
        </div>
      </aside>

      <!-- Main -->
      <div class="flex-1 min-w-0 flex flex-col">
        <header>
          <div class="h-14 px-4 flex items-center justify-between gap-4">
            <div class="flex items-center gap-2 min-w-0">
              <button id="openSidebarBtn" class="md:hidden text-gray-600" title="–ú–µ–Ω—é"><i class="bi bi-list"></i></button>
              <h1 id="pageTitle" class="font-semibold truncate">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
            </div>
            <div class="flex items-center gap-2">
              <div id="visitTimerWrap" class="hidden border rounded-lg px-2 py-1 text-sm text-indigo-700 bg-indigo-50 flex items-center gap-2">
                <i class="bi bi-stopwatch"></i> <span id="visitTimerText">00:00:00</span>
                <button id="visitEndBtn" class="ml-1 text-indigo-700 hover:text-indigo-900" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å –≤–∏–∑–∏—Ç"><i class="bi bi-x"></i></button>
              </div>
              <div class="relative">
                <button id="notifBtn" class="relative px-3 py-1 rounded-lg hover:bg-gray-100" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
                  <i class="bi bi-bell"></i>
                  <span id="notifBadge" class="badge bg-danger text-white position-absolute top-0 start-100 translate-middle hidden">0</span>
                </button>
                <div id="notifMenu" class="hidden absolute right-0 mt-2 bg-white border rounded-xl shadow z-10" style="min-width: 360px; max-width: 92vw;">
                  <div class="px-3 py-2 d-flex align-items-center justify-content-between gap-2">
                    <div class="text-sm fw-semibold">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                    <button id="notifMarkAll" class="border px-2 py-1 rounded-lg text-xs hover:bg-gray-50">–ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ</button>
                  </div>
                  <div class="border-top"></div>
                  <div id="notifList" class="max-h-80 overflow-auto"></div>
                  <div class="border-top"></div>
                  <button id="notifAllBtn" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50">–í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
                </div>
              </div>
              <div class="relative" id="materialsWrap">
                <button id="materialsBtn" class="px-3 py-1 rounded-lg hover:bg-gray-100"><i class="bi bi-paperclip"></i> –ú–∞—Ç–µ—Ä–∏–∞–ª—ã</button>
                <div id="materialsMenu" class="hidden absolute right-0 mt-2 bg-white border rounded-xl shadow z-10 min-w-64">
                  <div class="px-3 py-2 text-xs text-gray-500">–§–∞–π–ª—ã</div>
                  <div id="materialsList" class="max-h-64 overflow-auto"></div>
                </div>
              </div>
              <a href="mailto:support@bigtelesales.local" class="px-3 py-1 rounded-lg hover:bg-gray-100" title="–ü–æ–¥–¥–µ—Ä–∂–∫–∞"><i class="bi bi-chat-dots"></i> –ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
            </div>
          </div>
        </header>
        <main id="main-content" class="flex-1 overflow-auto p-4"></main>
      </div>
    </div>
  </template>

  <!-- PAGES TEMPLATES (simulating pages/*.html) -->
  <script type="text/html" id="page-analytics">
    <div class="space-y-4">
      <!-- Range selector -->
      <div class="bg-white border rounded-xl p-3 shadow-sm flex flex-wrap items-center gap-2">
        <button data-range="today" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">–°–µ–≥–æ–¥–Ω—è ‚úì</button>
        <button data-range="week" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">–ù–µ–¥–µ–ª—è</button>
        <button data-range="month" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">–ú–µ—Å—è—Ü</button>
        <div class="flex items-center gap-2">
          <span>üìÖ</span>
          <input id="anStart" type="date" class="border rounded-lg px-3 py-1.5" />
          <span>‚Äî</span>
          <input id="anEnd" type="date" class="border rounded-lg px-3 py-1.5" />
          <button id="anApply" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div class="text-xs text-gray-500">–ú–∞–∫—Å. –ø–µ—Ä–∏–æ–¥: 3 –º–µ—Å—è—Ü–∞</div>
      </div>

      <!-- Visits cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-white border rounded-xl p-4 shadow-sm">
          <div class="text-sm text-gray-500">üìä –í—Å–µ–≥–æ –≤–∏–∑–∏—Ç–æ–≤</div>
          <div class="text-2xl font-semibold" id="anVisitsTotal">‚Äî</div>
        </div>
        <div class="bg-white border rounded-xl p-4 shadow-sm">
          <div class="text-sm text-gray-500">üìÖ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</div>
          <div class="text-2xl font-semibold" id="anVisitsPlanned">‚Äî</div>
        </div>
        <div class="bg-white border rounded-xl p-4 shadow-sm">
          <div class="text-sm text-gray-500">‚ö° –í–Ω–µ–ø–ª–∞–Ω–æ–≤—ã–µ</div>
          <div class="text-2xl font-semibold" id="anVisitsAdhoc">‚Äî</div>
        </div>
      </div>

      <!-- Results distribution -->
      <div class="bg-white border rounded-xl p-4 shadow-sm">
        <div class="font-medium mb-2">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –≤–∏–∑–∏—Ç—ã ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
        <div id="anResults" class="space-y-2 text-sm"></div>
      </div>

      <!-- Orders sums -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-white border rounded-xl p-4 shadow-sm">
          <div class="font-medium">üí∞ –ó–∞–∫–∞–∑—ã</div>
          <div class="mt-2 text-sm space-y-1">
            <div>–û–±—â–∞—è —Å—É–º–º–∞: <b id="anOrdersTotal">‚Äî</b></div>
            <div>–°—Ä–µ–¥–Ω—è—è —Å—É–º–º–∞: <b id="anOrdersAvg">‚Äî</b></div>
            <div>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: <b id="anOrdersCount">‚Äî</b></div>
          </div>
        </div>
        <div class="bg-white border rounded-xl p-4 shadow-sm">
          <div class="font-medium">üè™ –î–∏—Å—Ç—Ä–∏–±—É—Ü–∏—è</div>
          <div class="mt-2 text-sm space-y-1">
            <div>–û—Ö–≤–∞—á–µ–Ω–æ —Ç–æ—á–µ–∫: <b id="anOutletsCovered">‚Äî</b></div>
            <div>–°—Ä–µ–¥–Ω–µ–µ –Ω–∞ —Ç–æ—á–∫—É: <b id="anAvgPerOutlet">‚Äî</b></div>
          </div>
        </div>
      </div>

      <!-- Top SKU block -->
      <div class="bg-white border rounded-xl p-4 shadow-sm">
        <div class="font-medium">‚≠ê –ü—Ä–æ–¥–∞–∂–∞ –¢–û–ü SKU</div>
        <div class="mt-2 text-sm space-y-1">
          <div>–ü—Ä–æ–¥–∞–Ω–æ –µ–¥–∏–Ω–∏—Ü: <b id="anTopSkuTotal">‚Äî</b></div>
          <div>–°—Ä–µ–¥–Ω–µ–µ –Ω–∞ –∑–∞–∫–∞–∑: <b id="anTopSkuAvg">‚Äî</b></div>
          <div class="border-t my-2"></div>
          <div id="anTop5" class="text-sm"></div>
        </div>
      </div>

      <!-- Simple trend chart -->
      <div class="bg-white border rounded-xl p-4 shadow-sm">
        <div class="font-medium">–î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ–¥–∞–∂ –ø–æ –¥–Ω—è–º</div>
        <canvas id="anChart" height="140" class="mt-2 w-full"></canvas>
      </div>
    </div>
  </script>

  <script type="text/html" id="page-televisits">
    <div class="space-y-3">
      <!-- Top bar -->
      <div class="bg-white border rounded-xl p-3 shadow-sm">
        <div class="flex flex-wrap items-center gap-2">
          <div class="flex items-center gap-2">
            <button id="tvPrev" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">‚óÄ –í—á–µ—Ä–∞</button>
            <input id="tvDate" type="date" class="border rounded-lg px-3 py-1.5" />
            <button id="tvNext" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">–ó–∞–≤—Ç—Ä–∞ ‚ñ∂</button>
            <button id="tvRange" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üìÖ –ü–µ—Ä–∏–æ–¥</button>
            <button id="tvPrint" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50"><i class="bi bi-printer"></i> –ü–µ—á–∞—Ç—å –ø–ª–∞–Ω–∞</button>
            <button id="tvAddVisit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg text-sm">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∏–∑–∏—Ç</button>
          </div>
          <div class="flex items-center gap-2 flex-1 min-w-[220px]">
            <span>üîç</span>
            <input id="tvSearch" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∫–æ–¥—É, –∞–¥—Ä–µ—Å—É, –ò–ù–ù..." class="border rounded-lg px-3 py-1.5 w-full focus:outline-none focus:ring focus:ring-indigo-200" />
          </div>
        </div>
      </div>

      <!-- Range panel (toggle) -->
      <div id="tvRangePanel" class="hidden bg-white border rounded-xl p-3 shadow-sm">
        <div class="flex flex-wrap items-center gap-2">
          <div class="text-sm text-gray-600">–ü–µ—Ä–∏–æ–¥:</div>
          <input id="tvRangeStart" type="date" class="border rounded-lg px-3 py-1.5" />
          <span class="text-gray-400">‚Äî</span>
          <input id="tvRangeEnd" type="date" class="border rounded-lg px-3 py-1.5" />
          <button id="tvRangeApply" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <button id="tvRangeClear" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50 text-gray-700">–°–±—Ä–æ—Å–∏—Ç—å –ø–µ—Ä–∏–æ–¥</button>
          <div class="text-xs text-gray-500">–ú–∞–∫—Å. –ø–µ—Ä–∏–æ–¥: 3 –º–µ—Å—è—Ü–∞</div>
        </div>
      </div>

      <!-- Calendar info (auto-updating) -->
      <div class="bg-white border rounded-xl p-3 shadow-sm">
        <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-gray-700">
          <div class="text-gray-500">–ë–∞–∑–æ–≤–∞—è –¥–∞—Ç–∞: <b id="tvCalendarBase">‚Äî</b></div>
          <div>–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏: <b id="tvDayName">‚Äî</b></div>
          <div>–ù–æ–º–µ—Ä –Ω–µ–¥–µ–ª–∏ (ISO): <b id="tvWeekNo">‚Äî</b></div>
          <div>–ù–µ–¥–µ–ª—è: <b id="tvWeekParity">‚Äî</b></div>
        </div>
        <div class="text-xs text-gray-500 mt-1">–†–∞—Å—á–µ—Ç –ø–æ ISO 8601 (–ø–µ—Ä–≤–∞—è –Ω–µ–¥–µ–ª—è –≥–æ–¥–∞ –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É, –Ω–µ–¥–µ–ª—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ü–Ω).</div>
      </div>

      <!-- Stats -->
      <div class="bg-white border rounded-xl p-3 shadow-sm">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
          <div class="border rounded-lg p-3"><div class="text-gray-500">–í—Å–µ–≥–æ</div><div id="tvStatTotal" class="text-xl font-semibold">0</div></div>
          <div class="border rounded-lg p-3"><div class="text-indigo-600">üìÖ –ü–ª–∞–Ω–æ–≤—ã–µ</div><div id="tvStatPlanned" class="text-xl font-semibold">0</div></div>
          <div class="border rounded-lg p-3"><div class="text-amber-600">‚ö° –í–Ω–µ–ø–ª–∞–Ω–æ–≤—ã–µ</div><div id="tvStatAdhoc" class="text-xl font-semibold">0</div></div>
          <div class="border rounded-lg p-3"><div class="text-[#28a745]">üü¢ –í—ã–ø–æ–ª–Ω–µ–Ω–æ</div><div id="tvStatDone" class="text-xl font-semibold">0</div></div>
        </div>
      </div>

      <!-- List -->
      <div id="tvList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3"></div>
    </div>
  </script>

  <script type="text/html" id="page-catalog">
    <div class="space-y-3">
      <!-- Promo Cards (replaces old carousel) -->
      <div id="promoCardsWrap" class="hidden bg-white border rounded-xl p-3 shadow-sm">
        <div class="flex items-center gap-2">
          <button id="promoPrev" class="border px-2 py-1 rounded-lg text-xs hover:bg-gray-50" title="–ù–∞–∑–∞–¥">‚óÄ</button>
          <div class="flex-1 overflow-hidden">
            <div id="promoCardsTrack" class="flex transition-transform duration-300 ease-out" style="gap:8px;"></div>
          </div>
          <button id="promoNext" class="border px-2 py-1 rounded-lg text-xs hover:bg-gray-50" title="–í–ø–µ—Ä–µ–¥">‚ñ∂</button>
        </div>
      </div>

      <!-- Top Filters Bar (sticky) -->
      <div class="bg-white border rounded-xl p-3 shadow-sm catalog-sticky-bar">
        <div class="flex flex-wrap items-center gap-2">
          <div class="flex items-center gap-2 flex-1 min-w-[220px]">
            <div class="relative w-full">
              <i class="bi bi-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
              <input id="catSearch" type="search" placeholder="–ü–æ–∏—Å–∫: –Ω–∞–∑–≤–∞–Ω–∏–µ, –∞—Ä—Ç–∏–∫—É–ª, —à—Ç—Ä–∏—Ö–∫–æ–¥, –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å, –ø–æ—Å—Ç–∞–≤—â–∏–∫" class="border rounded-lg pl-10 pr-3 py-2 w-full focus:outline-none focus:ring focus:ring-indigo-200" />
            </div>
          </div>

          <div class="flex items-center gap-1">
            <button id="viewGridBtn" class="border px-3 py-2 rounded-lg text-sm hover:bg-gray-50" title="–ü–ª–∏—Ç–∫–∞"><i class="bi bi-grid"></i></button>
            <button id="viewTableBtn" class="border px-3 py-2 rounded-lg text-sm hover:bg-gray-50" title="–¢–∞–±–ª–∏—Ü–∞"><i class="bi bi-list"></i></button>
            <button id="toggleFiltersBtn" class="border px-3 py-2 rounded-lg text-sm hover:bg-gray-50" title="–§–∏–ª—å—Ç—Ä—ã"><i class="bi bi-funnel"></i></button>
          </div>

          <button id="topSkuBtn" class="border px-3 py-2 rounded-lg text-sm hover:bg-gray-50"><i class="bi bi-star"></i> –¢–û–ü SKU</button>

          <label class="border px-3 py-2 rounded-lg text-sm hover:bg-gray-50 inline-flex items-center gap-2 cursor-pointer select-none" title="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤–µ—Å—å —Å–ø–∏—Å–æ–∫ –±–µ–∑ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏">
            <input id="catInfinite" type="checkbox" class="accent-indigo-600" style="width:16px;height:16px" />
            –ë–µ—Å–∫. –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
          </label>

          <button id="resetFiltersBtn" class="border px-3 py-2 rounded-lg text-sm hover:bg-gray-50"><i class="bi bi-arrow-counterclockwise"></i> –°–±—Ä–æ—Å–∏—Ç—å</button>

          <button id="cartOpenBtn" class="border px-3 py-2 rounded-lg text-sm hover:bg-gray-50">
            <i class="bi bi-cart"></i> –ö–æ—Ä–∑–∏–Ω–∞ <span id="cartBadge" class="badge bg-indigo-600 text-white ml-1">0</span>
          </button>

          <div class="text-sm text-gray-700">–ò—Ç–æ–≥–æ: <b id="cartTotal">0 ‚ÇΩ</b></div>

          <div class="relative">
            <button id="sortBtn" class="border px-3 py-2 rounded-lg text-sm hover:bg-gray-50"><i class="bi bi-sort-down"></i> –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</button>
            <div id="sortMenu" class="hidden absolute right-0 mt-1 bg-white border rounded-lg shadow z-10 w-56 text-sm">
              <a data-sort="name-asc" class="block px-3 py-2 hover:bg-gray-50" href="#">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é ‚Üë</a>
              <a data-sort="name-desc" class="block px-3 py-2 hover:bg-gray-50" href="#">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é ‚Üì</a>
              <a data-sort="price-asc" class="block px-3 py-2 hover:bg-gray-50" href="#">–ü–æ —Ü–µ–Ω–µ ‚Üë</a>
              <a data-sort="price-desc" class="block px-3 py-2 hover:bg-gray-50" href="#">–ü–æ —Ü–µ–Ω–µ ‚Üì</a>
              <a data-sort="category" class="block px-3 py-2 hover:bg-gray-50" href="#">–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</a>
              <a data-sort="sortOrder" class="block px-3 py-2 hover:bg-gray-50" href="#">–ü–æ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ (—Ñ–∞–π–ª)</a>
            </div>
          </div>
        </div>
      </div>

      <div id="catLayout" class="catalog-layout">
        <!-- Left Filters Sidebar -->
        <aside class="bg-white border rounded-xl p-3 shadow-sm glass scrollbar-thin">
          <div class="font-medium mb-2">–§–∏–ª—å—Ç—Ä—ã</div>
          <div class="space-y-3 text-sm" id="catFilters">
            <details>
              <summary class="cursor-pointer select-none py-1">–ü–æ—Å—Ç–∞–≤—â–∏–∫</summary>
              <div id="filterVendor" class="space-y-1 pl-3"></div>
            </details>
            <details>
              <summary class="cursor-pointer select-none py-1">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</summary>
              <div id="filterManufacturer" class="space-y-1 pl-3"></div>
            </details>
            <details>
              <summary class="cursor-pointer select-none py-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</summary>
              <div id="filterCategory" class="space-y-1 pl-3"></div>
            </details>
            <details>
              <summary class="cursor-pointer select-none py-1">–°—É–±–∫–∞—Ç–µ–≥–æ—Ä–∏—è</summary>
              <div id="filterSubcategory" class="space-y-1 pl-3"></div>
            </details>
          </div>
        </aside>

        <!-- Main list -->
        <section>
          <div id="catStats" class="text-sm text-gray-600 mb-2">–ù–∞–π–¥–µ–Ω–æ: 0</div>
          <div id="catGrid" class="grid-cards"></div>
          <div id="catTableWrap" class="hidden overflow-auto scrollbar-thin">
            <table class="w-full text-sm">
              <thead><tr class="text-left text-gray-500">
                <th class="py-2 pr-2">–§–æ—Ç–æ</th>
                <th class="py-2 pr-2">–ê—Ä—Ç–∏–∫—É–ª</th>
                <th class="py-2 pr-2">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th class="py-2 pr-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                <th class="py-2 pr-2">–¶–µ–Ω–∞</th>
                <th class="py-2 pr-2">–ü–†–û–ú–û</th>
                <th class="py-2 pr-2">–í –±–ª–æ–∫–µ</th>
                <th class="py-2 pr-2">–ö–æ—Ä–∑–∏–Ω–∞</th>
              </tr></thead>
              <tbody id="catTable"></tbody>
            </table>
          </div>
          <div class="mt-3 flex justify-center">
            <button id="loadMoreBtn" class="border px-4 py-2 rounded-lg text-sm hover:bg-gray-50">–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë</button>
          </div>
        </section>
      </div>
    </div>

    <!-- Offcanvas Cart -->
    <div id="cartOverlay"></div>
    <div id="cartPanel">
      <div class="p-3 border-b flex items-center justify-between">
        <div class="font-medium">üõí –ö–æ—Ä–∑–∏–Ω–∞</div>
        <button id="cartCloseBtn" class="text-gray-500 hover:text-gray-700">‚úï</button>
      </div>
      <div id="cartBody" class="flex-1 overflow-auto p-3 space-y-2 scrollbar-thin"></div>
      <div class="p-3 border-t space-y-2">
        <div class="flex items-center justify-between text-sm"><div>–ò–¢–û–ì–û:</div><div id="cartTotalBottom" class="font-medium">0 ‚ÇΩ</div></div>
        <div class="flex items-center gap-2 flex-wrap">
          <button id="cartExportBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üì• –°–∫–∞—á–∞—Ç—å Excel</button>
          <button id="cartClearBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50 text-red-600">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å—ë</button>
          <button id="cartCheckoutBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg text-sm">‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
      </div>
    </div>
  </script>

  <script type="text/html" id="page-orders">
    <div class="space-y-3">
      <!-- Top bar -->
      <div class="bg-white border rounded-xl p-3 shadow-sm">
        <div class="flex flex-wrap items-center gap-2">
          <button id="ordExportAll" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üì• –°–∫–∞—á–∞—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã</button>
          <button id="ordDeleteAll" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50 text-red-600">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ</button>
          <div class="flex items-center gap-2 flex-1 min-w-[220px]">
            <span>üîç</span>
            <input id="ordSearch" type="search" placeholder="–ü–æ–∏—Å–∫..." class="border rounded-lg px-3 py-1.5 w-full focus:outline-none focus:ring focus:ring-indigo-200" />
          </div>
        </div>
      </div>

      <!-- List -->
      <div id="ordList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3"></div>
    </div>
  </script>

  <script type="text/html" id="page-admin">
    <div class="space-y-4">
      <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
      <div class="bg-white border rounded-xl p-4 shadow-sm flex flex-wrap items-center justify-between gap-2">
        <div class="min-w-0">
          <div class="font-medium">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
          <div class="text-xs text-gray-500">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ –∏ –∏–º–ø–æ—Ä—Ç/—ç–∫—Å–ø–æ—Ä—Ç</div>
        </div>
        <div class="flex items-center gap-2 flex-wrap justify-end">
          <span id="xlsxStatus" class="text-xs px-2 py-1 rounded-lg border bg-gray-50 text-gray-600">Excel: –ø—Ä–æ–≤–µ—Ä–∫–∞‚Ä¶</span>
          <button id="btnSchema" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üìã –°—Ö–µ–º–∞</button>
          <button id="btnInfo" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</button>
          <button id="btnTimezone" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50"><i class="bi bi-clock"></i> –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å</button>
          <button id="btnResetAll" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-red-50 text-red-600"><i class="bi bi-trash3"></i> –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
        </div>
      </div>

      <!-- Tiles grid (2 per row) -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
        <div class="bg-white border rounded-xl p-4 shadow-sm order-last" style="order:9999">
          <div class="flex items-start justify-between gap-2 mb-3">
            <div class="min-w-0">
              <div class="font-medium">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</div>
              <div class="text-xs text-gray-500">–°–æ–∑–¥–∞–Ω–∏–µ, –ø—Ä–æ—Å–º–æ—Ç—Ä –ø–∞—Ä–æ–ª—è, —É–¥–∞–ª–µ–Ω–∏–µ</div>
            </div>
            <div class="flex items-center gap-2">
              <button type="button" class="border px-2 py-1 rounded-lg text-xs hover:bg-gray-50" data-admin-help="users" title="–ü–æ–¥—Å–∫–∞–∑–∫–∞"><i class="bi bi-info-circle"></i></button>
              <button id="resetAdminBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">–°–±—Ä–æ—Å–∏—Ç—å admin</button>
              <button id="addUserBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg text-sm">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
          </div>
          <div class="overflow-auto" style="max-height:340px">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-left text-gray-500">
                  <th class="py-2 pr-2">Email</th>
                  <th class="py-2 pr-2">–†–æ–ª—å</th>
                  <th class="py-2 pr-2">–î–∞—Ç–∞</th>
                  <th class="py-2 pr-2">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody id="usersTable"></tbody>
            </table>
          </div>
        </div>

        <!-- –ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä–æ–≤ -->
        <div class="bg-white border rounded-xl p-4 shadow-sm">
          <div class="flex items-start justify-between gap-2 mb-3">
            <div class="min-w-0">
              <div class="font-medium">–¢–æ–≤–∞—Ä—ã</div>
              <div class="text-xs text-gray-500">–ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç Excel + —à–∞–±–ª–æ–Ω</div>
            </div>
            <div class="flex items-center gap-2">
              <button type="button" class="border px-2 py-1 rounded-lg text-xs hover:bg-gray-50" data-admin-help="products" title="–ü–æ–¥—Å–∫–∞–∑–∫–∞"><i class="bi bi-info-circle"></i></button>
            </div>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <button id="prodImportBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üì• –ò–º–ø–æ—Ä—Ç</button>
            <button id="prodTemplateBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üì• –®–∞–±–ª–æ–Ω</button>
            <button id="prodExportBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
            <button id="prodClearBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50 text-red-600">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
          <div class="flex items-center gap-3 mt-3">
            <div id="prodSpinner" class="hidden flex items-center gap-2 text-sm text-gray-600"><span class="inline-block w-4 h-4 border-2 border-gray-300 border-t-indigo-600 rounded-full animate-spin"></span> –û–±—Ä–∞–±–æ—Ç–∫–∞...</div>
            <div class="flex-1">
              <div id="prodProgressWrap" class="hidden w-full bg-gray-100 rounded-full h-2">
                <div id="prodProgress" class="bg-indigo-600 h-2 rounded-full" style="width:0%"></div>
              </div>
            </div>
            <div class="text-sm text-gray-600">–í –±–∞–∑–µ: <span id="prodCount">0</span></div>
          </div>
          <div class="text-xs text-gray-500 mt-2">–ê—Ä—Ç–∏–∫—É–ª –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω. –¢–û–ü SKU: 1/–¥–∞/true ‚Üí –±—É–¥–µ—Ç –ø–æ–º–µ—á–µ–Ω –∑–Ω–∞—á–∫–æ–º üëç –≤ –∫–∞—Ç–∞–ª–æ–≥–µ.</div>
        </div>

        <!-- –ò–º–ø–æ—Ä—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
        <div class="bg-white border rounded-xl p-4 shadow-sm">
          <div class="flex items-start justify-between gap-2 mb-3">
            <div class="min-w-0">
              <div class="font-medium">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
              <div class="text-xs text-gray-500">–ò–º–ø–æ—Ä—Ç —Ñ–æ—Ç–æ, —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É/—à—Ç—Ä–∏—Ö–∫–æ–¥—É</div>
            </div>
            <div class="flex items-center gap-2">
              <button type="button" class="border px-2 py-1 rounded-lg text-xs hover:bg-gray-50" data-admin-help="images" title="–ü–æ–¥—Å–∫–∞–∑–∫–∞"><i class="bi bi-info-circle"></i></button>
              <button id="imgSelectBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ</button>
              <input id="imgFiles" type="file" accept="image/*" multiple class="hidden" />
            </div>
          </div>
          <div class="text-xs text-gray-500 mb-3">
            –ò–º—è —Ñ–∞–π–ª–∞ = <b>–∞—Ä—Ç–∏–∫—É–ª</b> –∏–ª–∏ <b>—à—Ç—Ä–∏—Ö–∫–æ–¥</b>. –°—É—Ñ—Ñ–∏–∫—Å—ã <b>(1)</b>, <b>(2)</b> ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ. –ó–∞–≥–ª—É—à–∫–∞: <b>1111111111.jpg</b>.
          </div>
          <div class="flex items-center gap-3">
            <div id="imgSpinner" class="hidden flex items-center gap-2 text-sm text-gray-600"><span class="inline-block w-4 h-4 border-2 border-gray-300 border-t-indigo-600 rounded-full animate-spin"></span> –ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="flex-1">
              <div id="imgProgressWrap" class="hidden w-full bg-gray-100 rounded-full h-2">
                <div id="imgProgress" class="bg-indigo-600 h-2 rounded-full" style="width:0%"></div>
              </div>
            </div>
            <div id="imgSummary" class="text-sm text-gray-600"></div>
          </div>
        </div>

        <!-- –¢–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ -->
        <div class="bg-white border rounded-xl p-4 shadow-sm">
          <div class="flex items-start justify-between gap-2 mb-3">
            <div class="min-w-0">
              <div class="font-medium">–¢–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏</div>
              <div class="text-xs text-gray-500">–ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç Excel + —à–∞–±–ª–æ–Ω</div>
            </div>
            <div class="flex items-center gap-2">
              <button type="button" class="border px-2 py-1 rounded-lg text-xs hover:bg-gray-50" data-admin-help="outlets" title="–ü–æ–¥—Å–∫–∞–∑–∫–∞"><i class="bi bi-info-circle"></i></button>
            </div>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <button id="outImportBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üì• –ò–º–ø–æ—Ä—Ç</button>
            <button id="outTemplateBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üì• –®–∞–±–ª–æ–Ω</button>
            <button id="outExportBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
            <button id="outClearBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50 text-red-600">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
          <div class="flex items-center gap-3 mt-3">
            <div id="outSpinner" class="hidden flex items-center gap-2 text-sm text-gray-600"><span class="inline-block w-4 h-4 border-2 border-gray-300 border-t-indigo-600 rounded-full animate-spin"></span> –û–±—Ä–∞–±–æ—Ç–∫–∞...</div>
            <div class="flex-1">
              <div id="outProgressWrap" class="hidden w-full bg-gray-100 rounded-full h-2">
                <div id="outProgress" class="bg-indigo-600 h-2 rounded-full" style="width:0%"></div>
              </div>
            </div>
            <div class="text-sm text-gray-600">–í –±–∞–∑–µ: <span id="outCount">0</span></div>
          </div>
        </div>

        <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
        <div class="bg-white border rounded-xl p-4 shadow-sm">
          <div class="flex items-start justify-between gap-2 mb-3">
            <div class="min-w-0">
              <div class="font-medium">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
              <div class="text-xs text-gray-500">–ò–º–ø–æ—Ä—Ç Excel + –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–æ–¥—É —Ç–æ—á–∫–∏</div>
            </div>
            <div class="flex items-center gap-2">
              <button type="button" class="border px-2 py-1 rounded-lg text-xs hover:bg-gray-50" data-admin-help="contacts" title="–ü–æ–¥—Å–∫–∞–∑–∫–∞"><i class="bi bi-info-circle"></i></button>
            </div>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <button id="contImportBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üì• –ò–º–ø–æ—Ä—Ç</button>
            <button id="contTemplateBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üì• –®–∞–±–ª–æ–Ω</button>
            <button id="contClearBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50 text-red-600">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
          <div class="flex items-center gap-3 mt-3">
            <div id="contSpinner" class="hidden flex items-center gap-2 text-sm text-gray-600"><span class="inline-block w-4 h-4 border-2 border-gray-300 border-t-indigo-600 rounded-full animate-spin"></span> –û–±—Ä–∞–±–æ—Ç–∫–∞...</div>
            <div class="flex-1">
              <div id="contProgressWrap" class="hidden w-full bg-gray-100 rounded-full h-2">
                <div id="contProgress" class="bg-indigo-600 h-2 rounded-full" style="width:0%"></div>
              </div>
            </div>
            <div class="text-sm text-gray-600">–í –±–∞–∑–µ: <span id="contCount">0</span></div>
          </div>
        </div>

        <!-- –ü–†–û–ú–û -->
        <div class="bg-white border rounded-xl p-4 shadow-sm">
          <div class="flex items-start justify-between gap-2 mb-3">
            <div class="min-w-0">
              <div class="font-medium">–ü–†–û–ú–û (–∞–∫—Ü–∏–∏)</div>
              <div class="text-xs text-gray-500">–ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç Excel + –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–∏–¥–æ–∫ –≤ –∫–æ—Ä–∑–∏–Ω–µ</div>
            </div>
            <div class="flex items-center gap-2">
              <button type="button" class="border px-2 py-1 rounded-lg text-xs hover:bg-gray-50" data-admin-help="promos" title="–ü–æ–¥—Å–∫–∞–∑–∫–∞"><i class="bi bi-info-circle"></i></button>
              <button id="promoHelpBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">‚ÑπÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç</button>
            </div>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <button id="promoImportBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üì• –ò–º–ø–æ—Ä—Ç</button>
            <button id="promoTemplateBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üì• –®–∞–±–ª–æ–Ω</button>
            <button id="promoExportBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
            <button id="promoClearBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50 text-red-600">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
          <div class="flex items-center gap-3 mt-3">
            <div id="promoSpinner" class="hidden flex items-center gap-2 text-sm text-gray-600"><span class="inline-block w-4 h-4 border-2 border-gray-300 border-t-indigo-600 rounded-full animate-spin"></span> –û–±—Ä–∞–±–æ—Ç–∫–∞...</div>
            <div class="text-sm text-gray-600">–ê–∫—Ç–∏–≤–Ω—ã—Ö: <span id="promoCount">0</span></div>
          </div>
        </div>

        <!-- –ú–∞—Ä—à—Ä—É—Ç—ã -->
        <div class="bg-white border rounded-xl p-4 shadow-sm">
          <div class="flex items-start justify-between gap-2 mb-3">
            <div class="min-w-0">
              <div class="font-medium">–ú–∞—Ä—à—Ä—É—Ç—ã</div>
              <div class="text-xs text-gray-500">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∏–∑–∏—Ç–æ–≤ –ø–æ –¥–Ω—è–º –∏ —Ü–∏–∫–ª–∞–º –Ω–µ–¥–µ–ª—å</div>
            </div>
            <div class="flex items-center gap-2">
              <button type="button" class="border px-2 py-1 rounded-lg text-xs hover:bg-gray-50" data-admin-help="routes" title="–ü–æ–¥—Å–∫–∞–∑–∫–∞"><i class="bi bi-info-circle"></i></button>
            </div>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <button id="routesImportBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üì• –ò–º–ø–æ—Ä—Ç</button>
            <button id="routesTemplateBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üì• –®–∞–±–ª–æ–Ω</button>
            <button id="routesExportBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
            <button id="routesViewBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üìã –ü—Ä–æ—Å–º–æ—Ç—Ä</button>
            <button id="routesClearBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50 text-red-600">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            <button id="routesClearVisitsBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50 text-red-600">üßπ –û—á–∏—Å—Ç–∏—Ç—å –≤–∏–∑–∏—Ç—ã</button>
          </div>
          <div class="flex items-center gap-3 mt-3">
            <div id="routesSpinner" class="hidden flex items-center gap-2 text-sm text-gray-600"><span class="inline-block w-4 h-4 border-2 border-gray-300 border-t-indigo-600 rounded-full animate-spin"></span> –û–±—Ä–∞–±–æ—Ç–∫–∞...</div>
            <div class="flex-1">
              <div id="routesProgressWrap" class="hidden w-full bg-gray-100 rounded-full h-2">
                <div id="routesProgress" class="bg-indigo-600 h-2 rounded-full" style="width:0%"></div>
              </div>
            </div>
            <div class="text-sm text-gray-600">–í –±–∞–∑–µ: <span id="routesCount">0</span></div>
          </div>
          <div class="text-xs text-gray-500 mt-2">–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏: 1=–ü–Ω ‚Ä¶ 7=–í—Å. –¶–∏–∫–ª: 1 / 2.1 / 2.2 / 4.1..4.4 (ISO‚Äë–Ω–µ–¥–µ–ª–∏).</div>
        </div>

        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã -->
        <div class="bg-white border rounded-xl p-4 shadow-sm">
          <div class="flex items-start justify-between gap-2 mb-3">
            <div class="min-w-0">
              <div class="font-medium">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</div>
              <div class="text-xs text-gray-500">–§–∞–π–ª—ã –≤ —à–∞–ø–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (dropdown)</div>
            </div>
            <div class="flex items-center gap-2">
              <button type="button" class="border px-2 py-1 rounded-lg text-xs hover:bg-gray-50" data-admin-help="materials" title="–ü–æ–¥—Å–∫–∞–∑–∫–∞"><i class="bi bi-info-circle"></i></button>
              <button id="addFileBtn" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üìé –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
              <input id="addFileInput" type="file" class="hidden" />
              <button class="border px-3 py-1.5 rounded-lg text-sm text-gray-400 cursor-not-allowed" disabled>–Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫</button>
            </div>
          </div>
          <div class="overflow-auto" style="max-height:320px">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-left text-gray-500">
                  <th class="py-2 pr-2">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                  <th class="py-2 pr-2">–†–∞–∑–º–µ—Ä</th>
                  <th class="py-2 pr-2">–î–∞—Ç–∞</th>
                  <th class="py-2 pr-2">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody id="materialsTableBody"></tbody>
            </table>
          </div>
        </div>

        <!-- –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ -->
        <div class="bg-white border rounded-xl p-4 shadow-sm">
          <div class="flex items-start justify-between gap-2 mb-3">
            <div class="min-w-0">
              <div class="font-medium">–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
              <div class="text-xs text-gray-500">JSON + –∞–≤—Ç–æ–±—ç–∫–∞–ø (3 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö)</div>
            </div>
            <div class="flex items-center gap-2">
              <button type="button" class="border px-2 py-1 rounded-lg text-xs hover:bg-gray-50" data-admin-help="backup" title="–ü–æ–¥—Å–∫–∞–∑–∫–∞"><i class="bi bi-info-circle"></i></button>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
            <button id="backupExportBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-lg text-sm">üì• –°–∫–∞—á–∞—Ç—å –±—ç–∫–∞–ø (JSON)</button>
            <button id="backupImportBtn" class="border px-3 py-2 rounded-lg text-sm hover:bg-gray-50">üì§ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            <input id="backupImportInput" type="file" accept=".json" class="hidden" />
          </div>
          <div class="mt-3 border-t pt-3">
            <div class="font-medium text-sm mb-2">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
            <div class="flex items-center gap-3 flex-wrap">
              <label class="inline-flex items-center gap-2 text-sm">
                <input type="checkbox" id="autoBackupEnabled" class="accent-indigo-600" />
                –í–∫–ª—é—á–∏—Ç—å
              </label>
              <div class="flex items-center gap-2 text-sm">
                <span class="text-gray-600">–ò–Ω—Ç–µ—Ä–≤–∞–ª:</span>
                <select id="autoBackupInterval" class="border rounded-lg px-3 py-1.5 text-sm">
                  <option value="1">–ö–∞–∂–¥—ã–π –¥–µ–Ω—å</option>
                  <option value="3">–ö–∞–∂–¥—ã–µ 3 –¥–Ω—è</option>
                  <option value="7" selected>–ö–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é</option>
                </select>
              </div>
            </div>
            <div class="mt-3" id="autoBackupsList"></div>
          </div>
        </div>
      </div>
    </div>
  </script>

  <!-- TimeZone (global) -->
  <script>
    /**
     * TZ ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Å–æ–≤—ã–º –ø–æ—è—Å–æ–º –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ.
     * –•—Ä–∞–Ω–µ–Ω–∏–µ: localStorage (–∫–ª—é—á bts_tz), –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å settings.timezone.
     * –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: Europe/Moscow.
     *
     * –í–∞–∂–Ω–æ: JS Date –≤—Å–µ–≥–¥–∞ —Ö—Ä–∞–Ω–∏—Ç –≤—Ä–µ–º—è –≤ UTC, –∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ/–≤—ã—á–∏—Å–ª–µ–Ω–∏–µ "–¥–Ω—è" –∑–∞–≤–∏—Å–∏—Ç –æ—Ç TZ.
     * –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º Intl.DateTimeFormat(timeZone) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.
     * @namespace TZ
     */
    const TZ = (()=>{
      const LS_KEY = 'bts_tz';
      const DEFAULT_TZ = 'Europe/Moscow';

      /** @returns {string} IANA timezone */
      function getTimeZone(){
        return String(localStorage.getItem(LS_KEY) || DEFAULT_TZ);
      }

      /**
       * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å.
       * @param {string} tz
       */
      function setTimeZone(tz){
        const val = String(tz || DEFAULT_TZ);
        localStorage.setItem(LS_KEY, val);
      }

      /**
       * –°–ø–∏—Å–æ–∫ TZ –¥–ª—è –≤—ã–±–æ—Ä–∞ (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å).
       * @returns {Array<{value:string,label:string}>}
       */
      function list(){
        return [
          { value:'Europe/Moscow', label:'–ú–æ—Å–∫–≤–∞ (Europe/Moscow) ‚Äî UTC+3' },
          { value:'UTC', label:'UTC (–±–µ–∑ —Å–º–µ—â–µ–Ω–∏—è)' },
          { value:'Europe/Kaliningrad', label:'–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥ (Europe/Kaliningrad) ‚Äî UTC+2' },
          { value:'Europe/Samara', label:'–°–∞–º–∞—Ä–∞ (Europe/Samara) ‚Äî UTC+4' },
          { value:'Asia/Yekaterinburg', label:'–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ (Asia/Yekaterinburg) ‚Äî UTC+5' },
          { value:'Asia/Omsk', label:'–û–º—Å–∫ (Asia/Omsk) ‚Äî UTC+6' },
          { value:'Asia/Krasnoyarsk', label:'–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫ (Asia/Krasnoyarsk) ‚Äî UTC+7' },
          { value:'Asia/Irkutsk', label:'–ò—Ä–∫—É—Ç—Å–∫ (Asia/Irkutsk) ‚Äî UTC+8' },
          { value:'Asia/Yakutsk', label:'–Ø–∫—É—Ç—Å–∫ (Asia/Yakutsk) ‚Äî UTC+9' },
          { value:'Asia/Vladivostok', label:'–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫ (Asia/Vladivostok) ‚Äî UTC+10' },
          { value:'Asia/Magadan', label:'–ú–∞–≥–∞–¥–∞–Ω (Asia/Magadan) ‚Äî UTC+11' },
          { value:'Asia/Kamchatka', label:'–ö–∞–º—á–∞—Ç–∫–∞ (Asia/Kamchatka) ‚Äî UTC+12' }
        ];
      }

      /**
       * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç YYYY-MM-DD (–∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–∞—è –¥–∞—Ç–∞) –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º TZ.
       * @param {Date|number|string} date
       * @param {string} [tz]
       * @returns {string}
       */
      function isoDate(date, tz){
        const zone = tz || getTimeZone();
        const d = date instanceof Date ? date : new Date(date);
        const parts = new Intl.DateTimeFormat('ru-RU', { timeZone: zone, year:'numeric', month:'2-digit', day:'2-digit' }).formatToParts(d);
        const get = (type)=> parts.find(p=>p.type===type)?.value || '';
        return `${get('year')}-${get('month')}-${get('day')}`;
      }

      /** @returns {string} */
      function todayISO(){
        return isoDate(new Date());
      }

      /**
       * –ü–∞—Ä—Å–∏—Ç YYYY-MM-DD –≤ Date (–ª–æ–∫–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞) ‚Äî —É–¥–æ–±–Ω–æ –¥–ª—è —Ü–∏–∫–ª–æ–≤/–∏—Ç–µ—Ä–∞—Ü–∏–π.
       * –í–∞–∂–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–∞–∫ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–∞—è –¥–∞—Ç–∞ (Y/M/D), –Ω–µ –∫–∞–∫ –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –≤—Ä–µ–º—è.
       * @param {string} iso
       * @returns {Date|null}
       */
      function parseISODate(iso){
        const s = String(iso||'').trim();
        const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (!m) return null;
        const y = Number(m[1]), mo = Number(m[2])-1, d = Number(m[3]);
        const dt = new Date(y, mo, d);
        dt.setHours(0,0,0,0);
        return dt;
      }

      return { LS_KEY, DEFAULT_TZ, getTimeZone, setTimeZone, list, isoDate, todayISO, parseISODate };
    })();
  </script>

  <!-- Utils -->
  <script>
    const Utils = (() => {
      function pad(n){ return n < 10 ? '0'+n : ''+n; }
      function formatDate(date, format = 'dd.MM.yyyy HH:mm'){
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç —Å —É—á–µ—Ç–æ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: –ú–æ—Å–∫–≤–∞)
        // –í–∞–∂–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–µ–º Intl.DateTimeFormat, —á—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –¥–∞—Ç—ã –≤–æ –≤—Å–µ—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä—è—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.
        const tz = (globalThis.TZ && typeof globalThis.TZ.getTimeZone === 'function') ? globalThis.TZ.getTimeZone() : 'Europe/Moscow';
        const d = date instanceof Date ? date : new Date(date);

        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏ –≤ –∑–∞–¥–∞–Ω–Ω–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ
        const parts = new Intl.DateTimeFormat('ru-RU', {
          timeZone: tz,
          year: 'numeric', month: '2-digit', day: '2-digit',
          hour: '2-digit', minute: '2-digit', second: '2-digit',
          hour12: false
        }).formatToParts(d);
        const get = (type)=> parts.find(p=>p.type===type)?.value || '';
        const map = {
          dd: get('day'),
          MM: get('month'),
          yyyy: get('year'),
          HH: get('hour'),
          mm: get('minute'),
          ss: get('second')
        };
        return format.replace(/dd|MM|yyyy|HH|mm|ss/g, k => map[k]);
      }
      function formatCurrency(number, currency = 'RUB', locale = 'ru-RU'){
        try { return new Intl.NumberFormat(locale, { style: 'currency', currency }).format(Number(number||0)); }
        catch(e){ return (Number(number||0).toFixed(2)) + ' ' + currency; }
      }
      function humanFileSize(bytes){
        const thresh = 1024; if (Math.abs(bytes) < thresh) return bytes + ' B';
        const units = ['KB','MB','GB','TB']; let u = -1; do { bytes /= thresh; ++u; } while (Math.abs(bytes) >= thresh && u < units.length - 1);
        return bytes.toFixed(1) + ' ' + units[u];
      }
      function generateId(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2, 10) + Date.now().toString(36).slice(-4); }
      function generatePassword(length=12){
        const lowers='abcdefghijklmnopqrstuvwxyz'; const uppers=lowers.toUpperCase(); const nums='0123456789'; const syms='!@#$%^&*()_+'; const all = lowers+uppers+nums+syms;
        let p=''; for(let i=0;i<length;i++){ p += all[Math.floor(Math.random()*all.length)]; } return p;
      }
      async function copyToClipboard(text){ try { await navigator.clipboard.writeText(text); showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success'); } catch(e){ showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 'error'); } }
      function showToast(message, type='info'){
        const map = {
          info: { cls:'text-bg-primary', icon:'bi-info-circle' },
          success: { cls:'text-bg-success', icon:'bi-check-circle' },
          warning: { cls:'text-bg-warning', icon:'bi-exclamation-triangle' },
          error: { cls:'text-bg-danger', icon:'bi-x-circle' }
        };
        const meta = map[type] || map.info;
        const el = document.createElement('div');
        el.className = `toast show align-items-center ${meta.cls} border-0 shadow`;
        el.setAttribute('role','alert');
        el.setAttribute('aria-live','assertive');
        el.setAttribute('aria-atomic','true');
        el.innerHTML = `
          <div class="d-flex">
            <div class="toast-body d-flex align-items-start gap-2">
              <i class="bi ${meta.icon}"></i>
              <div style="line-height:1.2">${String(message||'')}</div>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Close"></button>
          </div>
        `;
        const wrap = document.getElementById('toast-container');
        wrap.appendChild(el);
        el.querySelector('.btn-close')?.addEventListener('click', ()=>{ try{ el.remove(); }catch(_){} });
        setTimeout(() => {
          el.classList.remove('show');
          el.classList.add('hide');
          setTimeout(()=>{ try{ el.remove(); }catch(_){} }, 350);
        }, 3200);
      }
      function showModal(title, content, buttons=[{label:'OK'}], opts={}){
        return new Promise(resolve => {
          const overlay = document.createElement('div');
          overlay.className='modal-overlay';
          overlay.tabIndex = -1;

          const card = document.createElement('div');
          card.className = 'modal-card' + (opts?.variant === 'product' ? ' modal-product' : '');
          card.innerHTML = `
            <div class="px-4 py-3 border-bottom d-flex align-items-center justify-content-between" style="border-color: var(--border)">
              <div class="fw-semibold" style="max-width:80%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${title}</div>
              <button class="btn btn-sm btn-light" data-close title="–ó–∞–∫—Ä—ã—Ç—å"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="p-4" id="modalContent" style="flex:1 1 auto;"></div>
            <div class="px-4 py-3 border-top d-flex align-items-center justify-content-end gap-2" id="modalButtons" style="border-color: var(--border)"></div>
          `;
          overlay.appendChild(card);
          document.body.appendChild(overlay);

          const contentEl = card.querySelector('#modalContent');
          if (typeof content === 'string') contentEl.innerHTML = content; else contentEl.appendChild(content);

          const close = (val=false) => {
            try { document.removeEventListener('keydown', onKey); } catch(_){ }
            try { overlay.remove(); } catch(_){ }
            resolve(val);
          };

          const btnsEl = card.querySelector('#modalButtons');
          buttons.forEach((b, i) => {
            const btn = document.createElement('button');
            // Preserve custom classes passed by existing code; otherwise map to Bootstrap-like styles
            const fallbackClass = i===0 ? 'btn btn-primary' : 'btn btn-outline-secondary';
            btn.className = (b.class && b.class.trim()) ? b.class : fallbackClass;
            btn.textContent = b.label;
            btn.addEventListener('click', () => close(b.value ?? true));
            btnsEl.appendChild(btn);
          });

          card.querySelector('[data-close]').addEventListener('click', () => close(false));

          // Close on backdrop click (but not when clicking inside the card)
          overlay.addEventListener('mousedown', (e)=>{
            if (e.target === overlay) close(false);
          });

          // Close on ESC
          function onKey(e){
            if (e.key === 'Escape') close(false);
          }
          document.addEventListener('keydown', onKey);
        });
      }
      function debounce(fn, delay=300){ let t; return (...args) => { clearTimeout(t); t=setTimeout(()=>fn(...args), delay); }; }
      function downloadFile(filename, content, type='text/plain'){
        // –í–∞–∂–Ω–æ: —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –≤–Ω—É—Ç—Ä–∏ user-gesture (click), –∏–Ω–∞—á–µ –±—Ä–∞—É–∑–µ—Ä –º–æ–∂–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å.
        try {
          const blob = content instanceof Blob ? content : new Blob([content], { type });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          a.rel = 'noopener';
          a.style.position = 'fixed';
          a.style.left = '-9999px';
          a.style.top = '-9999px';
          document.body.appendChild(a);
          // –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–ª–∏–∫ ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
          a.click();
          // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞
          setTimeout(() => {
            try { URL.revokeObjectURL(url); } catch(_){ }
            try { a.remove(); } catch(_){ }
          }, 4000);
        } catch(e){
          try {
            // Fallback: –æ—Ç–∫—Ä—ã—Ç—å blob –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ (–µ—Å–ª–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ)
            const blob = content instanceof Blob ? content : new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank', 'noopener');
            setTimeout(()=>{ try { URL.revokeObjectURL(url); } catch(_){} }, 4000);
          } catch(err){ console.error('downloadFile error', err); }
        }
      }
      /**
       * –ù–∞–¥–µ–∂–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ XLSX –∫–Ω–∏–≥–∏ –Ω–∞ –¥–∏—Å–∫.
       * –í—Å–µ–≥–¥–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç ArrayBuffer –∏ —Å–∫–∞—á–∏–≤–∞–µ—Ç —á–µ—Ä–µ–∑ Blob —Å—Å—ã–ª–∫—É.
       * @param {XLSX.WorkBook} wb
       * @param {string} filename
       */
      function saveWorkbookXLSX(wb, filename){
        // –ï—Å–ª–∏ XLSX –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω ‚Äî –ø—Ä–æ–±—É–µ–º –¥–æ–≥—Ä—É–∑–∏—Ç—å (best-effort).
        // –í–∞–∂–Ω–æ: —Ñ—É–Ω–∫—Ü–∏—è –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –∏–∑ user-gesture; –¥–æ–≥—Ä—É–∑–∫–∞ –º–æ–∂–µ—Ç –Ω–µ —É—Å–ø–µ—Ç—å ‚Äî —Ç–æ–≥–¥–∞ –ø–æ–π–¥—É—Ç fallback-–≤–µ—Ç–∫–∏.
        try {
          if (typeof XLSX === 'undefined' && typeof XLSXLoader !== 'undefined'){
            XLSXLoader.ensure().catch(()=>{});
          }
        } catch(_){ }
        // Primary path: ArrayBuffer -> Blob -> object URL (most reliable across environments)
        try {
          const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
          downloadFile(filename, wbout, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
          return;
        } catch(err){ console.warn('saveWorkbookXLSX array write failed:', err); }
        // Fallback 1: binary string -> Uint8Array -> Blob
        try {
          const bin = XLSX.write(wb, {bookType:'xlsx', type:'binary'});
          const buf = new Uint8Array(bin.length);
          for (let i=0;i<bin.length;i++) buf[i] = bin.charCodeAt(i) & 0xFF;
          downloadFile(filename, new Blob([buf], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}));
          return;
        } catch(err2){ console.warn('saveWorkbookXLSX binary fallback failed:', err2); }
        // Fallback 2: use writeFile as last resort
        try {
          if (typeof XLSX !== 'undefined' && typeof XLSX.writeFile === 'function'){
            XLSX.writeFile(wb, filename);
            return;
          }
        } catch(err3){ console.warn('saveWorkbookXLSX writeFile fallback failed:', err3); }
        // Fallback 3: base64 data URL (least reliable but sometimes works)
        try {
          const b64 = XLSX.write(wb, {bookType:'xlsx', type:'base64'});
          const href = 'data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,' + b64;
          const a = document.createElement('a');
          a.href = href; a.download = filename; a.style.position='fixed'; a.style.left='-9999px'; document.body.appendChild(a);
          a.click(); setTimeout(()=>a.remove(), 2000);
        } catch(err4){ console.error('saveWorkbookXLSX all strategies failed:', err4); Utils?.showToast?.('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª', 'error'); }
      }
      function toCSV(rows){ if (!rows || !rows.length) return ''; const keys = Object.keys(rows[0]); const esc = v => '"'+String(v??'').replace(/"/g,'""')+'"'; const header = keys.map(esc).join(','); const lines = rows.map(r => keys.map(k => esc(r[k])).join(',')); return [header, ...lines].join('\n'); }
      function parseCSV(text, delimiter=','){
        // –ü—Ä–æ—Å—Ç—ã–π CSV-–ø–∞—Ä—Å–µ—Ä —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–∞–≤—ã—á–µ–∫
        const rows = []; let i=0, cur='', inQuotes=false, row=[];
        const pushCell=()=>{ row.push(cur); cur=''; };
        while(i < text.length){ const ch=text[i++];
          if (inQuotes){ if (ch==='"'){ if (text[i]==='"'){ cur+='"'; i++; } else { inQuotes=false; } } else { cur+=ch; } }
          else { if (ch==='"'){ inQuotes=true; } else if (ch===delimiter){ pushCell(); } else if (ch==='\n'){ pushCell(); rows.push(row); row=[]; } else if (ch==='\r'){ /* ignore */ } else { cur+=ch; } }
        }
        pushCell(); if (row.length) rows.push(row);
        if (!rows.length) return [];
        const headers = rows.shift().map(h=>String(h||'').trim());
        return rows.filter(r=>r.some(v=>String(v).trim()!=='')).map(r=>{
          const obj={}; headers.forEach((h,idx)=>{ obj[h]=r[idx]!==undefined?r[idx]:''; }); return obj;
        });
      }
      function escapeXml(str){
        return String(str ?? '')
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;')
          .replace(/'/g,'&apos;');
      }
      /**
       * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç Excel-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π XML (SpreadsheetML 2003) –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —à–∞–±–ª–æ–Ω–∞.
       * –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ XLSX –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.
       * @param {string[]} headers
       * @param {string} sheetName
       * @returns {string} xml
       */
      function buildExcelXml(headers, sheetName='Sheet1'){
        return buildExcelXmlTable(headers, [], sheetName);
      }

      /**
       * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç Excel-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π XML (SpreadsheetML 2003) –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã (–∑–∞–≥–æ–ª–æ–≤–∫–∏ + —Å—Ç—Ä–æ–∫–∏).
       * –ü–æ–¥—Ö–æ–¥–∏—Ç –∫–∞–∫ fallback –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞/—à–∞–±–ª–æ–Ω–æ–≤, –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ Microsoft Excel.
       * @param {string[]} headers
       * @param {Array<Array<any>>} rows
       * @param {string} sheetName
       * @returns {string} xml
       */
      function buildExcelXmlTable(headers, rows = [], sheetName='Sheet1'){
        const rowXml = (arr)=>{
          const cells = (arr||[]).map(v => `<Cell><Data ss:Type="String">${escapeXml(v)}</Data></Cell>`).join('');
          return `<Row>${cells}</Row>`;
        };
        const headerRow = rowXml(headers||[]);
        const dataRows = (rows||[]).map(r => rowXml(r)).join('');
        return `<?xml version="1.0"?>\n<?mso-application progid="Excel.Sheet"?>\n`+
          `<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">`+
          `<Worksheet ss:Name="${escapeXml(sheetName)}"><Table>${headerRow}${dataRows}</Table></Worksheet>`+
          `</Workbook>`;
      }

      /**
       * –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–µ—Ä Excel 2003 XML (SpreadsheetML) –¥–ª—è fallback-–∏–º–ø–æ—Ä—Ç–∞ –∏–∑ .xls.
       * @param {string} xmlText
       * @returns {Array<Object>} –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏
       */
      function parseSpreadsheetML(xmlText){
        try {
          const doc = new DOMParser().parseFromString(String(xmlText||''), 'application/xml');
          const rows = Array.from(doc.getElementsByTagName('Row'));
          const matrix = rows.map(r => Array.from(r.getElementsByTagName('Cell')).map(c => c.getElementsByTagName('Data')[0]?.textContent ?? ''));
          if (!matrix.length) return [];
          const headers = (matrix.shift()||[]).map(h => String(h||'').trim());
          return matrix
            .filter(r => r.some(v => String(v).trim() !== ''))
            .map(r => {
              const obj = {};
              headers.forEach((h, i) => { if (h) obj[h] = (r[i] ?? ''); });
              return obj;
            });
        } catch(e){
          console.error('parseSpreadsheetML error', e);
          return [];
        }
      }

      function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
      return { formatDate, formatCurrency, humanFileSize, generateId, generatePassword, copyToClipboard, showToast, showModal, debounce, downloadFile, saveWorkbookXLSX, toCSV, parseCSV, buildExcelXml, buildExcelXmlTable, parseSpreadsheetML, clamp };
    })();
  </script>

  <!-- XLSX Loader (fallback CDNs) -->
  <script>
    /**
     * XLSXLoader ‚Äî –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–ª–∏—á–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ SheetJS (XLSX).
     * –ï—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π CDN –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–±—É–µ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏.
     * –í–∞–∂–Ω–æ: –∑–∞–≥—Ä—É–∑–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–æ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–Ω–æ–ø–∫–∞–º —ç–∫—Å–ø–æ—Ä—Ç–∞/—à–∞–±–ª–æ–Ω–æ–≤.
     * @namespace XLSXLoader
     */
    const XLSXLoader = (() => {
      const sources = [
        'https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js',
        'https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js'
      ];
      let loading = null;

      /** @returns {boolean} */
      function isReady(){
        return typeof window.XLSX !== 'undefined' && !!window.XLSX?.utils && typeof window.XLSX?.write === 'function';
      }

      /**
       * @param {string} src
       * @returns {Promise<void>}
       */
      function loadScript(src){
        return new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = src;
          s.async = true;
          s.onload = () => resolve();
          s.onerror = () => { try { s.remove(); } catch(_){}; reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å XLSX: ' + src)); };
          document.head.appendChild(s);
        });
      }

      /**
       * –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –Ω–∞–ª–∏—á–∏–µ XLSX.
       * @returns {Promise<boolean>}
       */
      async function ensure(){
        if (isReady()) return true;
        if (loading) return loading;
        loading = (async()=>{
          for (const src of sources){
            try {
              await loadScript(src);
              if (isReady()) return true;
            } catch(e){
              // –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫
              console.warn(e);
            }
          }
          return isReady();
        })();
        return loading;
      }

      /** –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –≤ —Ñ–æ–Ω–µ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç UI). */
      function preload(){
        ensure().then(ok => { if (!ok) console.warn('XLSXLoader: XLSX –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∏ —Å –æ–¥–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞'); });
      }

      return { isReady, ensure, preload };
    })();
  </script>

  <!-- Promo Engine (JSDoc) -->
  <script>
    /**
     * PromoEngine ‚Äî —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞–∫—Ü–∏—è–º–∏.
     * –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥—ã (barcode) –≤–º–µ—Å—Ç–æ –∞—Ä—Ç–∏–∫—É–ª–æ–≤ (sku) —Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é.
     * @namespace PromoEngine
     */
    const PromoEngine = (()=>{
      /**
       * –ü—Ä–∏–≤–æ–¥–∏—Ç —Ç–∏–ø –∞–∫—Ü–∏–∏ –∫ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é.
       * –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω–∏–π: ¬´–∫—É–ø–∏ –ø–æ–ª—É—á–∏¬ª, ¬´–∫—É–ø–∏- –ø–æ–ª—É—á–∏¬ª, ¬´–∫—É–ø–∏–ø–æ–ª—É—á–∏¬ª, ¬´–Ω–∞–±–æ—Ä¬ª/¬´set¬ª/¬´bundle¬ª.
       * @param {any} v
       * @returns {string}
       */
      function normalizeType(v){
        const s = String(v||'').toLowerCase().trim();
        const x = s.replace(/[\s-]+/g, '_');
        // –ö—É–ø–∏-–ø–æ–ª—É—á–∏
        if (x.includes('–∫—É–ø–∏') && (x.includes('–ø–æ–ª—É—á–∏') || x.includes('2'))) return '–∫—É–ø–∏_–ø–æ–ª—É—á–∏';
        if (x.includes('kup') || x.includes('get')) return '–∫—É–ø–∏_–ø–æ–ª—É—á–∏';
        // –ù–∞–±–æ—Ä
        if (x.includes('–Ω–∞–±–æ—Ä') || x.includes('bundle') || x.includes('set')) return '–Ω–∞–±–æ—Ä';
        return x;
      }

      /**
       * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫—Ü–∏–∏ –Ω–∞ —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É.
       * @param {Array<Object>} promos - —Å–ø–∏—Å–æ–∫ –∞–∫—Ü–∏–π
       * @returns {Array<Object>} –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫—Ü–∏–∏
       */
      function getActive(promos){
        const now = new Date().setHours(0,0,0,0);
        return (promos||[]).filter(p=>{
          if (p.active===false) return false;
          const s = p.startDate? (new Date(p.startDate)).setHours(0,0,0,0) : null;
          const e = p.endDate? (new Date(p.endDate)).setHours(23,59,59,999) : null;
          if (s && now < s) return false; if (e && now > e) return false; return true;
        });
      }
      /**
       * –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–∑–∏—Ü–∏—é –∫–æ—Ä–∑–∏–Ω—ã –ø–æ –ø—Ä–æ–º–æ-–ø–æ–∑–∏—Ü–∏–∏ (barcode –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ, –∑–∞—Ç–µ–º sku ‚Äî –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏).
       * @param {Array<Object>} cart
       * @param {{barcode?:string, sku?:string}} promoItem
       */
      function findCartItem(cart, promoItem){
        const byBarcode = (cart||[]).find(c => String(c.barcode||'').trim() && String(c.barcode).trim() === String(promoItem.barcode||'').trim());
        if (byBarcode) return byBarcode;
        return (cart||[]).find(c => String(c.sku||'').trim() && String(c.sku).trim() === String(promoItem.sku||'').trim()) || null;
      }
      /**
       * –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Å–∫–∏–¥–∫–∏ –∫ –ø–æ–∑–∏—Ü–∏—è–º –∫–æ—Ä–∑–∏–Ω—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∞–∫—Ü–∏—è–º–∏.
       * –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –∫–æ—Ä–∑–∏–Ω—ã, –ø—Ä–æ—Å—Ç–∞–≤–ª—è—è _discountPercent, _discountAmount, _promoApplied.
       * @param {Array<Object>} cart - –ø–æ–∑–∏—Ü–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã { sku, barcode, price, qty, ... }
       * @param {Array<Object>} activePromos - –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫—Ü–∏–∏
       */
      function applyPromos(cart, activePromos){
        (cart||[]).forEach(it=>{ it._discountPercent=0; it._discountAmount=0; it._promoApplied=null; });
        const apply=(item, percent, name)=>{
          percent = Number(percent)||0; if (!item||percent<=0) return;
          const disc = (item.price||0)*(item.qty||0)*percent/100;
          if ((item._discountAmount||0) < disc){ item._discountAmount=disc; item._discountPercent=percent; item._promoApplied=name||'–ê–ö–¶–ò–Ø'; }
        };
        for (const p of (activePromos||[])){
          const t = normalizeType(p.type);
          if (t==='–∫—É–ø–∏_–ø–æ–ª—É—á–∏'){
            const it=p.items?.[0]; if (!it) continue;
            const item = findCartItem(cart, it);
            if (item && Number(item.qty||0) >= Number(it.requiredQty||1)) apply(item, p.discountPercent, p.name);
          } else if (t==='–Ω–∞–±–æ—Ä'){
            const all=p.items||[];
            const ok = all.length && all.every(x=>{ const i=findCartItem(cart, x); return i && Number(i.qty||0) >= Number(x.requiredQty||1); });
            if (ok){ all.forEach(x=> { const i=findCartItem(cart, x); apply(i, p.discountPercent, p.name); }); }
          }
        }
      }
      /**
       * –°—Ç—Ä–æ–∏—Ç –∫–∞—Ä—Ç—É BARCODE ‚Üí [–∞–∫—Ü–∏–∏] (—Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é: –µ—Å–ª–∏ —É –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ—Ç barcode, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω sku)
       * @param {Array<Object>} activePromos
       * @returns {Map<string, Array<Object>>}
       */
      function skusMap(activePromos){
        const map = new Map();
        (activePromos||[]).forEach(p=> (p.items||[]).forEach(i=>{
          const key = String(i.barcode||i.sku||'').trim(); if (!key) return;
          const arr = map.get(key)||[]; arr.push(p); map.set(key, arr);
        }));
        return map;
      }
      return { getActive, applyPromos, skusMap };
    })();
  </script>

  <!-- Analytics Precalc (JSDoc) -->
  <script>
    /**
     * –ü—Ä–µ–¥—Ä–∞—Å—á–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–Ω–æ–π –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
     * @namespace AnalyticsPrecalc
     */
    const AnalyticsPrecalc = (function(){
      let cache=null;
      /**
       * –í—ã—á–∏—Å–ª—è–µ—Ç –∏ –∫–µ—à–∏—Ä—É–µ—Ç —Å—ã—Ä—å–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.
       * @returns {Promise<{orders:Array, visits:Array}>}
       */
      async function compute(){
        try {
          const [orders, visits] = await Promise.all([
            Storage.getAll('orders'),
            Storage.getAll('visits')
          ]);
          cache = { orders, visits, computedAt: Date.now() };
        } catch(e){ cache = { orders:[], visits:[], computedAt: Date.now() }; }
        return cache;
      }
      /** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–µ—à –∏–ª–∏ null. */
      function get(){ return cache; }
      /** –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫–µ—à –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞. */
      function invalidate(){ cache=null; }
      return { compute, get, invalidate };
    })();
  </script>

  <!-- Storage (IndexedDB + localStorage helpers) -->
  <script>
    const Storage = (() => {
      const DB_NAME = 'BigTeleSalesDB';
      // –í–ê–ñ–ù–û: —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏—é –ë–î, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ö–µ–º—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã –≤ —Å—Ç–∞—Ä—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–∫–∞—Ö).
      const DB_VERSION = 6;
      let dbPromise;

      function openDB(){
        if (dbPromise) return dbPromise;
        dbPromise = new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, DB_VERSION);
          req.onupgradeneeded = (e) => {
            const db = req.result;
            // users
            if (!db.objectStoreNames.contains('users')){
              const store = db.createObjectStore('users', { keyPath: 'id', autoIncrement: true });
              store.createIndex('by_email', 'email', { unique: true });
            } else {
              // –°—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –º–æ–≥–ª–∏ —Å–æ–∑–¥–∞—Ç—å store users –±–µ–∑ –∏–Ω–¥–µ–∫—Å–∞ by_email.
              // –≠—Ç–æ –ª–æ–º–∞–µ—Ç –≤—Ö–æ–¥ –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ (NotFoundError –ø–æ –∏–Ω–¥–µ–∫—Å—É) –∏ —á–∞—Å—Ç–æ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ ¬´—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ¬ª.
              const store = req.transaction.objectStore('users');
              if (!store.indexNames.contains('by_email')){
                // –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å; –µ—Å–ª–∏ –≤ –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å –¥—É–±–ª–∏, unique –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å ‚Äî —Ç–æ–≥–¥–∞ —Å–æ–∑–¥–∞–µ–º –Ω–µ—É–Ω–∏–∫–∞–ª—å–Ω—ã–π,
                // –∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é –¥–µ–ª–∞–µ–º –ø–æ–∑–∂–µ –≤ migrateIfNeeded().
                try { store.createIndex('by_email', 'email', { unique: true }); }
                catch(e){
                  try { store.createIndex('by_email', 'email', { unique: false }); }
                  catch(_){ /* ignore */ }
                }
              }
            }
            // products
            if (!db.objectStoreNames.contains('products')){
              db.createObjectStore('products', { keyPath: 'sku' });
            }
            // productImages
            if (!db.objectStoreNames.contains('productImages')){
              db.createObjectStore('productImages', { keyPath: 'sku' });
            }
            // outlets
            if (!db.objectStoreNames.contains('outlets')){
              db.createObjectStore('outlets', { keyPath: 'code' });
            }
            // contacts
            if (!db.objectStoreNames.contains('contacts')){
              db.createObjectStore('contacts', { keyPath: 'code' });
            }
            // orders
            if (!db.objectStoreNames.contains('orders')){
              const store = db.createObjectStore('orders', { keyPath: 'id' });
              store.createIndex('by_date', 'date');
              store.createIndex('by_operator', 'operator');
            }
            // visits
            if (!db.objectStoreNames.contains('visits')){
              const store = db.createObjectStore('visits', { keyPath: 'id' });
              store.createIndex('by_date', 'date');
              store.createIndex('by_operator', 'operator');
              // –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: –∏–Ω–¥–µ–∫—Å—ã –ø–æ –ø–ª–∞–Ω–æ–≤–æ–π –¥–∞—Ç–µ –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
              store.createIndex('plannedDate', 'plannedDate', { unique: false });
              store.createIndex('operatorEmail_plannedDate', ['operatorEmail', 'plannedDate'], { unique: false });
            } else {
              // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ store visits (–ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤–µ—Ä—Å–∏–∏ –ë–î)
              const store = req.transaction.objectStore('visits');
              if (!store.indexNames.contains('plannedDate')){
                store.createIndex('plannedDate', 'plannedDate', { unique: false });
              }
              if (!store.indexNames.contains('operatorEmail_plannedDate')){
                store.createIndex('operatorEmail_plannedDate', ['operatorEmail', 'plannedDate'], { unique: false });
              }
            }
            // settings
            if (!db.objectStoreNames.contains('settings')){
              db.createObjectStore('settings', { keyPath: 'key' });
            }
            // promos (dedicated store for promo records)
            if (!db.objectStoreNames.contains('promos')){
              const store = db.createObjectStore('promos', { keyPath: 'id' });
              store.createIndex('by_active', 'active');
            }
            // routes (–º–∞—Ä—à—Ä—É—Ç—ã –æ–±–∑–≤–æ–Ω–∞)
            if (!db.objectStoreNames.contains('routes')){
              const store = db.createObjectStore('routes', { keyPath: 'outletCode' });
              store.createIndex('operatorEmail', 'operatorEmail', { unique: false });
              store.createIndex('priority', 'priority', { unique: false });
            }
            // notifications
            if (!db.objectStoreNames.contains('notifications')){
              const store = db.createObjectStore('notifications', { keyPath: 'id' });
              store.createIndex('read', 'read', { unique: false });
              store.createIndex('createdAt', 'createdAt', { unique: false });
            }
            // activityLog (–∂—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π)
            if (!db.objectStoreNames.contains('activityLog')){
              const store = db.createObjectStore('activityLog', { keyPath: 'id' });
              store.createIndex('timestamp', 'timestamp', { unique: false });
              store.createIndex('userEmail', 'userEmail', { unique: false });
              store.createIndex('action', 'action', { unique: false });
            }
          };
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
        return dbPromise;
      }

      function tx(storeName, mode='readonly'){ return openDB().then(db => db.transaction(storeName, mode)); }
      async function add(storeName, value){ const t = await tx(storeName, 'readwrite'); return reqToPromise(t.objectStore(storeName).add(value)); }
      async function put(storeName, value){ const t = await tx(storeName, 'readwrite'); return reqToPromise(t.objectStore(storeName).put(value)); }
      async function get(storeName, key){ const t = await tx(storeName); return reqToPromise(t.objectStore(storeName).get(key)); }
      async function getAll(storeName){ const t = await tx(storeName); return reqToPromise(t.objectStore(storeName).getAll()); }
      async function del(storeName, key){ const t = await tx(storeName, 'readwrite'); return reqToPromise(t.objectStore(storeName).delete(key)); }
      async function clearStore(storeName){ const t = await tx(storeName, 'readwrite'); return reqToPromise(t.objectStore(storeName).clear()); }
      async function getByIndex(storeName, indexName, value){ const t = await tx(storeName); return reqToPromise(t.objectStore(storeName).index(indexName).get(value)); }
      async function exportStore(storeName){ return getAll(storeName); }

      function reqToPromise(req){ return new Promise((res, rej)=>{ req.onsuccess = () => res(req.result); req.onerror = () => rej(req.error); }); }

      // localStorage helpers
      function setSession(session){ localStorage.setItem('bts_session', JSON.stringify(session)); }
      function getSession(){ try { return JSON.parse(localStorage.getItem('bts_session')||'null'); } catch(e){ return null; } }
      function clearSession(){ localStorage.removeItem('bts_session'); }

      async function seedIfEmpty(){
        // Ensure default users
        const users = await getAll('users').catch(()=>[]);
        if (!users || users.length === 0){
          await add('users', { email: 'admin@bigtelesales.local', password: 'admin123', role: 'admin', createdAt: Date.now() });
          await add('users', { email: 'operator@bigtelesales.local', password: 'operator', role: 'operator', createdAt: Date.now() });
        } else {
          // Ensure admin exists
          const admin = await getByIndex('users', 'by_email', 'admin@bigtelesales.local').catch(()=>null);
          if (!admin){
            await add('users', { email: 'admin@bigtelesales.local', password: 'admin123', role: 'admin', createdAt: Date.now() });
          }
        }
        // Settings defaults
        const mat = await get('settings', 'materials');
        if (!mat){
          await put('settings', { key: 'materials', value: [
            { name: '–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (PDF)', url: 'data:application/pdf;base64,' },
            { name: '–ü—Ä–∞–π—Å-–ª–∏—Å—Ç (CSV)', url: 'data:text/csv;base64,' }
          ]});
        }
        // Seed some products
        const prods = await getAll('products');
        if (!prods || prods.length === 0){
          await put('products', { sku: 'SKU-1001', name: '–ù–∞—É—à–Ω–∏–∫–∏ SuperSound', price: 2490, stock: 51, priceBase:2490, sortOrder:1, topSku: 1 });
          await put('products', { sku: 'SKU-1002', name: '–í–µ–±-–∫–∞–º–µ—Ä–∞ HD Pro', price: 3990, stock: 27, priceBase:3990, sortOrder:2 });
          await put('products', { sku: 'SKU-1003', name: '–ú–∏–∫—Ä–æ—Ñ–æ–Ω Studio', price: 5490, stock: 13, priceBase:5490, sortOrder:3 });
        }
        // Seed outlets
        const outlets = await getAll('outlets');
        if (!outlets || outlets.length === 0){
          await put('outlets', { code: 'OUT-001', name: '–ú–∞–≥–∞–∑–∏–Ω –¢–µ—Ö–Ω–∏–∫–∞ ‚Ññ1', city: '–ú–æ—Å–∫–≤–∞', inn:'7701000000', address:'–≥. –ú–æ—Å–∫–≤–∞', paymentTerms:'–ë–∞–Ω–∫ 14 –¥–Ω–µ–π', direction:'–†–æ–∑–Ω–∏—Ü–∞', creditLimit:50000, debt:12000 });
          await put('outlets', { code: 'OUT-002', name: '–≠–ª–µ–∫—Ç—Ä–æ–ú–∞—Ä–∫–µ—Ç', city: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', inn:'7801000000', address:'–≥. –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', paymentTerms:'–ù–∞–ª–∏—á–Ω—ã–µ –ø–æ —Ñ–∞–∫—Ç—É', direction:'–†–æ–∑–Ω–∏—Ü–∞', creditLimit:80000, debt:0 });
        }

        // Seed routes (demo)
        const routes = await getAll('routes').catch(()=>[]);
        if (!routes || routes.length === 0){
          // OUT-001: –ü–Ω/–°—Ä/–ü—Ç, –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é (–∫–æ–¥ "1")
          await put('routes', {
            outletCode:'OUT-001',
            daysOfWeek:[1,3,5], // 1=–ü–Ω..7=–í—Å
            operatorEmail:'operator@bigtelesales.local',
            // –ù–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –Ω–µ–¥–µ–ª–∏: 1 / 2.1 / 2.2 / 4.1..4.4
            frequency:'1',
            priority:1,
            lastVisitDate:null,
            nextPlannedDate:null,
            updatedAt: Date.now()
          });
          // OUT-002: –í—Ç/–ß—Ç, —Ä–∞–∑ –≤ 2 –Ω–µ–¥–µ–ª–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ—á–µ—Ç–Ω—ã–µ –Ω–µ–¥–µ–ª–∏ ‚Äî –∫–æ–¥ "2.1")
          await put('routes', {
            outletCode:'OUT-002',
            daysOfWeek:[2,4],
            operatorEmail:'operator@bigtelesales.local',
            frequency:'2.1',
            priority:2,
            lastVisitDate:null,
            nextPlannedDate:null,
            updatedAt: Date.now()
          });
        }
      }

      // –ú–∏–≥—Ä–∞—Ü–∏—è/–æ–∑–¥–æ—Ä–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–µ–±–æ–≤–∞–ª–æ—Å—å —Ä—É—á–Ω–æ–µ –æ—á–∏—â–µ–Ω–∏–µ –∫—ç—à–∞
      async function migrateIfNeeded(){
        try {
          await openDB();
          // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è email –≤ –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä –∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
          const users = await getAll('users').catch(()=>[]);
          const seen = new Map(); // email(lower) -> id
          const toDelete = [];
          for (const u of users){
            const norm = String(u.email||'').trim().toLowerCase();
            if (!norm){ toDelete.push(u.id); continue; }
            if (u.email !== norm){
              u.email = norm;
              try { await put('users', u); } catch(e){}
            }
            if (seen.has(norm)){
              // –¥—É–±–ª–∏–∫–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø–æ–º–µ—á–∞–µ–º –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
              toDelete.push(u.id);
            } else {
              seen.set(norm, u.id);
            }
          }
          for (const id of toDelete){ try { await del('users', id); } catch(e){} }
          // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ admin
          let admin = await getByIndex('users', 'by_email', 'admin@bigtelesales.local').catch(()=>null);
          if (!admin){
            await add('users', { email: 'admin@bigtelesales.local', password: 'admin123', role: 'admin', createdAt: Date.now() });
          }
          // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ materials
          const mat = await get('settings', 'materials').catch(()=>null);
          if (!mat){
            await put('settings', { key:'materials', value:[
              { name:'–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (PDF)', url:'data:application/pdf;base64,' },
              { name:'–ü—Ä–∞–π—Å-–ª–∏—Å—Ç (CSV)', url:'data:text/csv;base64,' }
            ]});
          }
          // PROMO migrate from settings.promos -> promos store, idempotent
          const promosSetting = await get('settings','promos').catch(()=>null);
          try {
            const promosStoreAll = await getAll('promos').catch(()=>[]);
            if ((!promosStoreAll || promosStoreAll.length===0) && promosSetting && Array.isArray(promosSetting.value)){
              for (const p of promosSetting.value){
                if (!p || !p.id) p.id = (p && p.name? 'promo_'+p.name : Utils?.generateId?.('promo') || 'promo_'+Date.now());
                await put('promos', p);
              }
            }
          } catch(e) { /* promos store might not exist on very old DB */ }

          // ROUTES migrate legacy format -> new format (daysOfWeek + week-code)
          try {
            const routes = await getAll('routes').catch(()=>[]);
            for (const r of (routes||[])){
              if (!r || !r.outletCode) continue;

              // Normalize operatorEmail
              if (r.operatorEmail) r.operatorEmail = String(r.operatorEmail).trim().toLowerCase();

              // Convert frequency words -> week code
              const sched = globalThis.Scheduler;
              if (r.frequency){
                r.frequency = (sched && typeof sched.normalizeWeekCode === 'function') ? sched.normalizeWeekCode(r.frequency) : String(r.frequency);
              } else {
                r.frequency = '1';
              }

              // Convert legacy schedule{mon..sun} -> daysOfWeek [1..7]
              if (!Array.isArray(r.daysOfWeek) || !r.daysOfWeek.length){
                const s = r.schedule || {};
                const days = [];
                if (s.mon) days.push(1);
                if (s.tue) days.push(2);
                if (s.wed) days.push(3);
                if (s.thu) days.push(4);
                if (s.fri) days.push(5);
                if (s.sat) days.push(6);
                if (s.sun) days.push(7);
                if (days.length) r.daysOfWeek = days;
              }

              // If single dayOfWeek existed, merge into daysOfWeek
              if (r.dayOfWeek){
                const d = Number(r.dayOfWeek);
                if (isFinite(d) && d>=1 && d<=7){
                  const set = new Set([...(r.daysOfWeek||[]).map(Number), d]);
                  r.daysOfWeek = Array.from(set).sort((a,b)=>a-b);
                }
                delete r.dayOfWeek;
              }

              r.updatedAt = Date.now();
              await put('routes', r);
            }
          } catch(e){ /* routes store might not exist on very old DB */ }

          // –û—Ç–º–µ—Ç–∫–∞ –æ –º–∏–≥—Ä–∞—Ü–∏–∏ (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ)
          await put('settings', { key:'migrated_v1', value: Date.now() });
        } catch(e){ console.warn('Migration skipped', e); }
      }

      // –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –ë–î —Å –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
      async function resetAndSeed(){
        const stores = ['users','products','productImages','outlets','contacts','orders','visits','settings','promos','routes','notifications','activityLog'];
        for (const s of stores){ try { await clearStore(s); } catch(e){} }
        await seedIfEmpty();
      }

      return { openDB, add, put, get, getAll, del, clearStore, getByIndex, exportStore, seedIfEmpty, migrateIfNeeded, resetAndSeed, setSession, getSession, clearSession };
    })();
  </script>

  <!-- Auth -->
  <script>
    const Auth = (() => {
      async function login(email, password){
        const emailNorm = String(email||'').trim().toLowerCase();

        /**
         * –ù–∞–¥–µ–∂–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email:
         * 1) —á–µ—Ä–µ–∑ –∏–Ω–¥–µ–∫—Å by_email (–±—ã—Å—Ç—Ä–æ)
         * 2) fallback —á–µ—Ä–µ–∑ –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ users (–µ—Å–ª–∏ –∏–Ω–¥–µ–∫—Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç/—Å–ª–æ–º–∞–ª—Å—è –≤ —Å—Ç–∞—Ä–æ–π –ë–î)
         * @param {string} em
         * @returns {Promise<any|null>}
         */
        async function findUserByEmail(em){
          try {
            const u = await Storage.getByIndex('users', 'by_email', em);
            if (u) return u;
          } catch(e){
            // –Ω–∞–ø—Ä–∏–º–µ—Ä NotFoundError: –∏–Ω–¥–µ–∫—Å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Å—Ç–∞—Ä–æ–π –ë–î
          }
          const all = await Storage.getAll('users').catch(()=>[]);
          return (all||[]).find(u => String(u.email||'').trim().toLowerCase() === em) || null;
        }

        // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É email
        let user = await findUserByEmail(emailNorm);

        // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –∏ –ø—ã—Ç–∞–µ–º—Å—è —Å–Ω–æ–≤–∞ (—Å–ø–∞—Å–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π/—Å—Ç–∞—Ä—ã—Ö —Å—Ö–µ–º)
        if (!user){
          await Storage.migrateIfNeeded();
          user = await findUserByEmail(emailNorm);
        }

        // –ï—Å–ª–∏ —ç—Ç–æ admin –∏ –µ–≥–æ –Ω–µ—Ç ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–¥–∏–º
        if (!user && emailNorm === 'admin@bigtelesales.local'){
          // –î–æ–ø. –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π: –¥–∞–∂–µ –µ—Å–ª–∏ –∏–Ω–¥–µ–∫—Å —Å–ª–æ–º–∞–Ω ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º getAll
          const all = await Storage.getAll('users').catch(()=>[]);
          const exists = (all||[]).some(u => String(u.email||'').trim().toLowerCase() === emailNorm);
          if (!exists){
            await Storage.add('users', { email: emailNorm, password: 'admin123', role: 'admin', createdAt: Date.now() });
          }
          user = await findUserByEmail(emailNorm);
        }

        if (user && String(user.password) === String(password)){
          const session = { userId: user.id, email: String(user.email||'').trim().toLowerCase(), role: user.role, loginTime: Date.now() };
          Storage.setSession(session);
          try { await window.ActivityLog?.logActivity?.(window.ActivityLog.LOG_ACTIONS.LOGIN, 'users', String(user.id), { email: user.email, role: user.role }); } catch(_){ }
          return { ok: true, user, session };
        }
        return { ok: false, message: '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å' };
      }
      function logout(){ Storage.clearSession(); }
      async function getCurrentUser(){
        const sess = Storage.getSession();
        if (!sess) return null;
        const user = await Storage.get('users', sess.userId).catch(()=>null);
        if (!user){
          Storage.clearSession();
          return null;
        }
        return { ...user };
      }
      return { login, logout, getCurrentUser };
    })();
  </script>

  <!-- Router -->
  <script>
    const Router = (() => {
      let current = null;
      const listeners = { before: [], after: [] };
      function onBeforeNavigate(fn){ listeners.before.push(fn); }
      function onAfterNavigate(fn){ listeners.after.push(fn); }
      function emit(list, detail){ list.forEach(fn => { try{ fn(detail); }catch(e){ console.error(e); } }); }

      function loadTemplate(page){
        const tpl = document.getElementById('page-' + page);
        return tpl ? tpl.innerHTML : `<div class="text-red-600">–°—Ç—Ä–∞–Ω–∏—Ü–∞ "${page}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</div>`;
        }

      function navigate(page, params={}){
        const main = document.getElementById('main-content');
        if (!main) return;
        const prev = current;
        const detail = { from: prev, to: page, params };
        emit(listeners.before, detail);
        main.innerHTML = loadTemplate(page);
        current = page;
        history.pushState({ page, params }, '', '#' + page);
        document.getElementById('pageTitle')?.replaceChildren(document.createTextNode(titleFor(page)));
        setActiveMenu(page);
        const afterDetail = { page, params };
        emit(listeners.after, afterDetail);
      }

      function titleFor(page){
        switch(page){
          case 'analytics': return '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞';
          case 'televisits': return '–¢–µ–ª–µ–≤–∏–∑–∏—Ç—ã';
          case 'catalog': return '–ö–∞—Ç–∞–ª–æ–≥';
          case 'orders': return '–ó–∞–∫–∞–∑—ã';
          case 'admin': return '–ê–¥–º–∏–Ω. –ø–∞–Ω–µ–ª—å';
          default: return '–°—Ç—Ä–∞–Ω–∏—Ü–∞';
        }
      }
      function setActiveMenu(page){
        document.querySelectorAll('.menu-link').forEach(a => {
          if (a.getAttribute('data-page') === page){ a.classList.add('bg-indigo-100', 'text-indigo-700'); }
          else { a.classList.remove('bg-indigo-100', 'text-indigo-700'); }
        });
      }

      window.addEventListener('popstate', (e) => {
        const st = e.state;
        if (st?.page){
          const main = document.getElementById('main-content');
          emit(listeners.before, { from: current, to: st.page, params: st.params||{} });
          main.innerHTML = loadTemplate(st.page);
          current = st.page;
          document.getElementById('pageTitle')?.replaceChildren(document.createTextNode(titleFor(st.page)));
          setActiveMenu(st.page);
          emit(listeners.after, { page: st.page, params: st.params||{} });
        }
      });

      return { navigate, onBeforeNavigate, onAfterNavigate, titleFor };
    })();
  </script>

  <!-- Scheduler (Routes -> Planned visits) -->
  <script>
    /**
     * Scheduler ‚Äî –∞–≤—Ç–æ–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∏–∑–∏—Ç–æ–≤ –ø–æ –º–∞—Ä—à—Ä—É—Ç–∞–º.
     *
     * –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å –º–∞—Ä—à—Ä—É—Ç–æ–≤:
     * - route.dayOfWeek: number (1=–ü–Ω ... 7=–í—Å)
     * - route.frequency: string ‚Äî –Ω–µ–¥–µ–ª—å–Ω—ã–π —Ü–∏–∫–ª: "1", "2.1", "2.2", "4.1".."4.4"
     *   –û—Ç—Å—á–µ—Ç –Ω–µ–¥–µ–ª—å ‚Äî –ø–æ ISO 8601 (–ø–µ—Ä–≤–∞—è –Ω–µ–¥–µ–ª—è –≥–æ–¥–∞ –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É, –Ω–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ ‚Äî –ü–Ω).
     *
     * Backward compatibility:
     * - –ï—Å–ª–∏ route.dayOfWeek –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –Ω–æ –µ—Å—Ç—å route.schedule{mon..sun} ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞.
     * - –ï—Å–ª–∏ frequency –∑–∞–¥–∞–Ω–∞ —Å–ª–æ–≤–∞–º–∏ ("–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ"/"—Ä–∞–∑ –≤ 2 –Ω–µ–¥–µ–ª–∏"/"—Ä–∞–∑ –≤ –º–µ—Å—è—Ü") ‚Äî –º–∞–ø–ø–∏–º –≤ –∫–æ–¥—ã.
     *
     * –•—Ä–∞–Ω–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤: IndexedDB.routes
     * –ü–ª–∞–Ω–æ–≤—ã–µ –≤–∏–∑–∏—Ç—ã: IndexedDB.visits (plannedDate/type/priority/operatorEmail)
     * @namespace Scheduler
     */
    const Scheduler = (()=>{
      /**
       * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –¥–∞—Ç—É –≤ ISO-—Å—Ç—Ä–æ–∫—É YYYY-MM-DD –≤ –õ–û–ö–ê–õ–¨–ù–û–ú —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ.
       * –í–∞–∂–Ω–æ: –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º toISOString(), —á—Ç–æ–±—ã –Ω–µ –ª–æ–≤–∏—Ç—å —Å–º–µ—â–µ–Ω–∏–µ –¥–∞—Ç—ã –≤ —Ä–∞–∑–Ω—ã—Ö TZ.
       * @param {Date} d
       */
      function toISODate(d){
        const x = new Date(d);
        const yyyy = x.getFullYear();
        const mm = String(x.getMonth()+1).padStart(2,'0');
        const dd = String(x.getDate()).padStart(2,'0');
        return `${yyyy}-${mm}-${dd}`;
      }
      /**
       * –ü–∞—Ä—Å–∏—Ç ISO YYYY-MM-DD –≤ Date (–ª–æ–∫–∞–ª—å–Ω–∞—è –ø–æ–ª–Ω–æ—á—å).
       * @param {string} iso
       * @returns {Date|null}
       */
      function fromISODate(iso){
        const s = String(iso||'').trim();
        const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (!m) return null;
        const y = Number(m[1]), mo = Number(m[2]) - 1, d = Number(m[3]);
        const dt = new Date(y, mo, d);
        dt.setHours(0,0,0,0);
        return dt;
      }
      /** @param {Date} d @param {number} days */
      function addDays(d, days){ const x=new Date(d); x.setDate(x.getDate()+days); return x; }

      /**
       * ISO day-of-week as number: 1=Mon..7=Sun.
       * @param {Date} date
       * @returns {number}
       */
      function getISODayNumber(date){
        const d = new Date(date);
        const js = d.getDay(); // 0=Sun..6=Sat
        return ((js + 6) % 7) + 1; // 1=Mon..7=Sun
      }

      /**
       * Legacy: –∫–ª—é—á –¥–Ω—è –Ω–µ–¥–µ–ª–∏ –ø–æ–¥ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ route.schedule: mon..sun.
       * @param {Date} date
       * @returns {'mon'|'tue'|'wed'|'thu'|'fri'|'sat'|'sun'}
       */
      function getLegacyDayKey(date){
        const n = new Date(date).getDay();
        return ['sun','mon','tue','wed','thu','fri','sat'][n];
      }

      /**
       * ISO week number (1..53) based on ISO 8601.
       * @param {Date} date
       * @returns {{week:number, year:number}}
       */
      function getISOWeek(date){
        // Use UTC-based algorithm to avoid TZ drift
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7; // Mon=1..Sun=7
        d.setUTCDate(d.getUTCDate() + 4 - dayNum); // nearest Thursday
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        const week = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        return { week, year: d.getUTCFullYear() };
      }

      /**
       * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã/—Ü–∏–∫–ª–∞ –≤ —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞.
       * –ü–æ–¥–¥–µ—Ä–∂–∫–∞:
       * - "1" | "2.1" | "2.2" | "4.1".."4.4"
       * - "–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ" ‚Üí "1"
       * - "—Ä–∞–∑ –≤ 2 –Ω–µ–¥–µ–ª–∏" ‚Üí "2.1" (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –Ω–µ—á–µ—Ç–Ω—ã–µ –Ω–µ–¥–µ–ª–∏)
       * - "—Ä–∞–∑ –≤ –º–µ—Å—è—Ü" ‚Üí "4.1" (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –ø–µ—Ä–≤–∞—è –Ω–µ–¥–µ–ª—è —Ü–∏–∫–ª–∞)
       * @param {any} v
       * @returns {string}
       */
      function normalizeWeekCode(v){
        const s0 = String(v ?? '').trim().toLowerCase().replace(',', '.');
        if (!s0) return '1';
        if (/^(1|2\.[12]|4\.[1-4])$/.test(s0)) return s0;
        if (s0.includes('–µ–∂')) return '1';
        if (s0.includes('2')) return '2.1';
        if (s0.includes('–º–µ—Å—è—Ü') || s0.includes('4')) return '4.1';
        return '1';
      }

      /**
       * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø–æ–¥—Ö–æ–¥–∏—Ç –ª–∏ –Ω–µ–¥–µ–ª—è –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞ –ø–æ –∫–æ–¥—É (1, 2.1/2.2, 4.1..4.4).
       * @param {number} isoWeekNumber
       * @param {string} weekCode
       * @returns {boolean}
       */
      function matchWeekCode(isoWeekNumber, weekCode){
        const code = normalizeWeekCode(weekCode);
        if (code === '1') return true;
        if (code.startsWith('2.')){
          const part = code.split('.')[1];
          const isOdd = (isoWeekNumber % 2) === 1;
          return (part === '1' && isOdd) || (part === '2' && !isOdd);
        }
        if (code.startsWith('4.')){
          const part = Number(code.split('.')[1] || 1);
          const cycleWeek = ((isoWeekNumber - 1) % 4) + 1;
          return cycleWeek === part;
        }
        return true;
      }

      /**
       * –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω—É–∂–Ω–æ –ª–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤–∏–∑–∏—Ç –ø–æ –º–∞—Ä—à—Ä—É—Ç—É –Ω–∞ targetDate.
       * @param {any} route
       * @param {Date} targetDate
       * @returns {boolean}
       */
      function shouldVisitByFrequency(route, targetDate){
        const { week } = getISOWeek(targetDate);
        // new model: frequency is a week code
        const weekCode = route?.frequency ?? route?.weekCode ?? '1';
        return matchWeekCode(week, weekCode);
      }

      /**
       * –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–Ω—è –≤–∏–∑–∏—Ç–∞ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É.
       * @param {any} route
       * @param {Date} targetDate
       * @returns {boolean}
       */
      function matchesDay(route, targetDate){
        // New model (single day)
        if (route && route.dayOfWeek){
          return Number(route.dayOfWeek) === getISODayNumber(targetDate);
        }
        // New model (multiple days in one route)
        if (route && Array.isArray(route.daysOfWeek) && route.daysOfWeek.length){
          return route.daysOfWeek.map(Number).includes(getISODayNumber(targetDate));
        }
        // Legacy model
        const key = getLegacyDayKey(targetDate);
        return !!route?.schedule?.[key];
      }

      /**
       * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–ª–∞–Ω–æ–≤—ã–µ –≤–∏–∑–∏—Ç—ã –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É.
       * –£—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (–¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏), —Ü–∏–∫–ª –Ω–µ–¥–µ–ª—å, –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∏ –∑–∞—â–∏—Ç—É –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤.
       * @param {Date} date
       */
      async function generatePlannedVisits(date){
        const user = await Auth.getCurrentUser();
        if (!user) return;

        const plannedDate = toISODate(date);
        const plannedDt = fromISODate(plannedDate) || new Date(date);
        plannedDt.setHours(0,0,0,0);
        const routes = await Storage.getAll('routes').catch(()=>[]);

        // NOTE: –ú–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ –∏–Ω–¥–µ–∫—Å operatorEmail_plannedDate, –Ω–æ –≤ —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
        const visits = await Storage.getAll('visits').catch(()=>[]);

        for (const route of (routes||[])){
          if (!matchesDay(route, date)) continue;

          // –û–ø–µ—Ä–∞—Ç–æ—Ä –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –º–∞—Ä—à—Ä—É—Ç—ã, –∞–¥–º–∏–Ω ‚Äî –≤—Å–µ
          if (user.role !== 'admin' && String(route.operatorEmail||'').toLowerCase() !== String(user.email||'').toLowerCase()) continue;

          if (!shouldVisitByFrequency(route, date)) continue;

          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –≤–∏–∑–∏—Ç–∞ (–ø–æ plannedDate –∏ outlet)
          const exists = (visits||[]).some(v => String(v.plannedDate||'')===plannedDate && String(v.outlet||v.outletCode||'')===String(route.outletCode));
          if (exists) continue;

          const outlet = await Storage.get('outlets', route.outletCode).catch(()=>null) || {};
          const rec = {
            id: Utils.generateId('visit'),
            date: plannedDt.getTime(),
            plannedDate,
            outlet: route.outletCode,
            outletCode: route.outletCode,
            outletName: outlet.name||'',
            inn: outlet.inn||'',
            address: outlet.address||'',
            payment: outlet.paymentTerms||'',
            direction: outlet.direction||'',
            creditLimit: outlet.creditLimit||'',
            debt: outlet.debt||'',
            status: '–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω',
            type: 'scheduled',
            priority: Number(route.priority||3) || 3,
            operator: route.operatorEmail||user.email,
            operatorEmail: route.operatorEmail||user.email,
            duration: '-',
            createdAt: Date.now()
          };
          await Storage.put('visits', rec);
        }
      }

      /**
       * –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø–ª–∞–Ω –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ N –¥–Ω–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 7).
       * @param {number} days
       */
      async function recalculatePlannedVisits(days=7){
        const start = new Date();
        start.setHours(0,0,0,0);
        for (let i=0;i<days;i++){
          await generatePlannedVisits(addDays(start, i));
        }
      }

      /**
       * –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –≤–∏–∑–∏—Ç–æ–≤ (planned/–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω) —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π.
       */
      async function cleanupOldVisits(){
        const cutoff = addDays(new Date(), -30);
        cutoff.setHours(0,0,0,0);
        const visits = await Storage.getAll('visits').catch(()=>[]);
        const toDel = (visits||[]).filter(v => (v.status==='–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω' || v.status==='planned') && (v.plannedDate ? (new Date(v.plannedDate).getTime() < cutoff.getTime()) : (v.date < cutoff.getTime())));
        for (const v of toDel){
          try { await Storage.del('visits', v.id); } catch(e){}
        }
        if (toDel.length) Utils.showToast(`–£–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä—ã—Ö –ø–ª–∞–Ω–æ–≤—ã—Ö –≤–∏–∑–∏—Ç–æ–≤: ${toDel.length}`, 'info');
      }

      return {
        toISODate,
        addDays,
        getISODayNumber,
        getLegacyDayKey,
        getISOWeek,
        normalizeWeekCode,
        matchWeekCode,
        matchesDay,
        shouldVisitByFrequency,
        generatePlannedVisits,
        recalculatePlannedVisits,
        cleanupOldVisits
      };
    })();
  </script>

  <!-- Visit Manager (Active visit context, header timer, finish prompt) -->
  <script>
    const VisitManager = (() => {
      const KEY = 'bts_visit';
      let tId = null;
      function get(){ try { return JSON.parse(localStorage.getItem(KEY)||'null'); } catch(e){ return null; } }
      function isActive(){ const v=get(); return v && v.active; }
      function save(v){ localStorage.setItem(KEY, JSON.stringify(v)); updateHeader(); }
      function clear(){ localStorage.removeItem(KEY); stopTimer(); updateHeader(); }
      /**
       * –°—Ç–∞—Ä—Ç –≤–∏–∑–∏—Ç–∞ (—Ç–∞–π–º–µ—Ä) —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
       * @param {Object} outlet
       * @param {Object} [meta]
       * @param {string} [meta.plannedDate] - YYYY-MM-DD
       * @param {'scheduled'|'unscheduled'} [meta.type]
       * @param {number} [meta.priority]
       * @param {string} [meta.operatorEmail]
       */
      function start(outlet, meta={}){
        const v = {
          active:true,
          id: Utils.generateId('visit'),
          start: Date.now(),
          outletCode: outlet.code,
          outletName: outlet.name||'',
          inn: outlet.inn||'',
          address: outlet.address||'',
          payment: outlet.paymentTerms||'',
          plannedDate: meta.plannedDate || null,
          type: meta.type || 'scheduled',
          priority: meta.priority ?? null,
          operatorEmail: meta.operatorEmail || (Storage.getSession()?.email||'')
        };
        save(v); startTimer(); return v;
      }
      function formatElapsed(ms){ const s=Math.floor(ms/1000); const hh=String(Math.floor(s/3600)).padStart(2,'0'); const mm=String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${hh}:${mm}:${ss}`; }
      function updateHeader(){ const wrap=document.getElementById('visitTimerWrap'); const txt=document.getElementById('visitTimerText'); if(!wrap||!txt) return; const v=get(); if(v&&v.active){ wrap.classList.remove('hidden'); txt.textContent = formatElapsed(Date.now()-v.start); } else { wrap.classList.add('hidden'); } }
      function tick(){ const v=get(); if(!v||!v.active) return; const txt=document.getElementById('visitTimerText'); if(txt) txt.textContent = formatElapsed(Date.now()-v.start); }
      function startTimer(){ if(tId) return; tId = setInterval(tick, 1000); }
      function stopTimer(){ if(tId){ clearInterval(tId); tId=null; } }
      async function promptFinish(){
        const v=get(); if(!v||!v.active) return; const duration = formatElapsed(Date.now()-v.start);
        const c=document.createElement('div');
        c.innerHTML = `
          <div class="space-y-3">
            <div class="text-sm text-gray-600">‚è±Ô∏è –í—Ä–µ–º—è –≤–∏–∑–∏—Ç–∞: <b>${duration}</b></div>
            <div>
              <label class="block text-sm mb-1">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç</label>
              <div class="space-y-1">
                <label class="inline-flex items-center gap-2"><input type="radio" name="vm_res" value="order" class="accent-indigo-600" checked/> –ó–∞–∫–∞–∑ —Å–¥–µ–ª–∞–Ω</label>
                <label class="inline-flex items-center gap-2"><input type="radio" name="vm_res" value="noorder" class="accent-indigo-600"/> –ë–µ–∑ –∑–∞–∫–∞–∑–∞</label>
                <label class="inline-flex items-center gap-2"><input type="radio" name="vm_res" value="wrong" class="accent-indigo-600"/> –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä</label>
                <label class="inline-flex items-center gap-2"><input type="radio" name="vm_res" value="noanswer" class="accent-indigo-600"/> –ù–µ—Ç –æ—Ç–≤–µ—Ç–∞</label>
                <div class="mt-1">
                  <label class="block text-sm">–ü—Ä–æ—á–µ–µ</label>
                  <input id="vm_note" class="w-full border rounded-lg px-3 py-2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"/>
                </div>
              </div>
            </div>
            <div class="space-y-1">
              <label class="inline-flex items-center gap-2"><input id="vm_move" type="checkbox" class="accent-indigo-600"/> –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤–∏–∑–∏—Ç</label>
              <input id="vm_date" type="date" class="w-full border rounded-lg px-3 py-2" />
            </div>
          </div>`;
        const ok = await Utils.showModal('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–∏–∑–∏—Ç–∞', c, [
          { label:'–û—Ç–º–µ–Ω–∞', value:false, class:'border px-3 py-1.5 rounded-lg hover:bg-gray-50' },
          { label:'‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å', value:true, class:'bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg' }
        ]);
        if(!ok) return;
        const resVal = c.querySelector('input[name="vm_res"]:checked')?.value || 'noorder';
        const note = c.querySelector('#vm_note').value.trim();
        const move = c.querySelector('#vm_move').checked; const moveDate = c.querySelector('#vm_date').value;
        const status = resVal==='order' ? '—Å–æ–≤–µ—Ä—à–µ–Ω' : (move ? '–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω' : '—Å–æ–≤–µ—Ä—à–µ–Ω');

        // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–ª–∞–Ω–æ–≤—ã–π –≤–∏–∑–∏—Ç –¥–ª—è —ç—Ç–æ–π —Ç–æ—á–∫–∏ –Ω–∞ plannedDate.
        // –≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã "—Ç–æ—á–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∞—Å—å –æ–¥–∏–Ω —Ä–∞–∑" –∏ –º–µ–Ω—è–ª–∞ —Å—Ç–∞—Ç—É—Å –±–µ–∑ –¥—É–±–ª–µ–π.
        const plannedISO = v.plannedDate || (()=>{ const d=new Date(v.start); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; })();
        const all = await Storage.getAll('visits').catch(()=>[]);
        const existing = (all||[]).find(x => String(x.outlet||x.outletCode||'')===String(v.outletCode) && String(x.plannedDate||'')===String(plannedISO));
        const base = existing || {
          id: existing?.id || v.id,
          outlet: v.outletCode,
          outletCode: v.outletCode,
          outletName: v.outletName,
          inn: v.inn,
          address: v.address,
          payment: v.payment,
          operatorEmail: v.operatorEmail || (Storage.getSession()?.email||''),
          operator: v.operatorEmail || (Storage.getSession()?.email||''),
          plannedDate: plannedISO,
          type: v.type || 'scheduled',
          priority: v.priority ?? 3,
          direction: existing?.direction,
          creditLimit: existing?.creditLimit,
          debt: existing?.debt,
          createdAt: existing?.createdAt || Date.now()
        };

        if (move && moveDate){
          // –ü–µ—Ä–µ–Ω–æ—Å: –æ–±–Ω–æ–≤–ª—è–µ–º —Ç—É –∂–µ –∑–∞–ø–∏—Å—å, –º–µ–Ω—è—è plannedDate –∏ date
          const m = String(moveDate||'').match(/^(\d{4})-(\d{2})-(\d{2})$/);
          const dt = m ? new Date(Number(m[1]), Number(m[2])-1, Number(m[3])) : new Date(moveDate);
          dt.setHours(0,0,0,0);
          await Storage.put('visits', {
            ...base,
            plannedDate: moveDate,
            date: dt.getTime(),
            status: '–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω',
            duration,
            result: resVal,
            note
          });
        } else {
          // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
          await Storage.put('visits', {
            ...base,
            date: base.date || v.start,
            status,
            duration,
            result: resVal,
            note
          });
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º lastVisitDate –º–∞—Ä—à—Ä—É—Ç–∞ (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
        try {
          const route = await Storage.get('routes', v.outletCode).catch(()=>null);
          if (route){
            route.lastVisitDate = new Date().toISOString().slice(0,10);
            route.updatedAt = Date.now();
            await Storage.put('routes', route);
          }
        } catch(e){}

        clear();
        Utils.showToast('–í–∏–∑–∏—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
      }
      function init(){ updateHeader(); if(isActive()) startTimer(); document.getElementById('visitEndBtn')?.addEventListener('click', ()=> promptFinish()); }
      return { start, isActive, get, clear, promptFinish, init, formatElapsed, updateHeader };
    })();
  </script>

  <!-- Notifications & Backup modules -->
  <script src="notifications.js"></script>
  <script src="backup.js"></script>
  <script src="charts.js"></script>
  <script src="activityLog.js"></script>
  <script src="print.js"></script>

  <!-- Application & Pages -->
  <script>
    const App = (() => {
      let notifCount = 2; // demo

      function setupLogin(){
        const root = document.getElementById('app-root');
        root.innerHTML = document.getElementById('tpl-login').innerHTML;
        const form = document.getElementById('loginForm');
        const emailEl = document.getElementById('loginEmail');
        const pwdEl = document.getElementById('loginPassword');
        const togglePwd = document.getElementById('togglePwd');
        togglePwd.addEventListener('click', () => {
          const t = pwdEl.getAttribute('type') === 'password' ? 'text' : 'password';
          pwdEl.setAttribute('type', t);
        });
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const email = emailEl.value.trim().toLowerCase();
          const password = pwdEl.value;
          const res = await Auth.login(email, password);
          if (res.ok){
            Utils.showToast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ' + res.user.email, 'success');
            setupApp();
            Router.navigate('analytics');
          } else {
            Utils.showToast(res.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', 'error');
          }
        });

        // –ö–Ω–æ–ø–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞
        document.getElementById('loginResetAdmin').addEventListener('click', async () => {
          try {
            await Storage.openDB();
            const u = await Storage.getByIndex('users', 'by_email', 'admin@bigtelesales.local').catch(()=>null);
            if (u){ u.password = 'admin123'; await Storage.put('users', u); }
            else { await Storage.add('users', { email: 'admin@bigtelesales.local', password: 'admin123', role: 'admin', createdAt: Date.now() }); }
            Utils.showToast('–ü–∞—Ä–æ–ª—å admin —Å–±—Ä–æ—à–µ–Ω: admin123', 'success');
          } catch(e){ Utils.showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ admin', 'error'); }
        });
        document.getElementById('loginClearSession').addEventListener('click', () => {
          Storage.clearSession(); Utils.showToast('–°–µ—Å—Å–∏—è –æ—á–∏—â–µ–Ω–∞', 'info');
        });
        document.getElementById('loginReinitDB').addEventListener('click', async () => {
          const ok = await Utils.showModal('–ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è', '–û—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (admin –∏ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ)?', [
            { label:'–û—Ç–º–µ–Ω–∞', value:false, class:'border px-3 py-1.5 rounded-lg hover:bg-gray-50' },
            { label:'–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å', value:true, class:'bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg' }
          ]);
          if (ok){
            try { await Storage.resetAndSeed(); Utils.showToast('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞', 'success'); }
            catch(e){ Utils.showToast('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏', 'error'); }
          }
        });
      }

      function setupApp(){
        const root = document.getElementById('app-root');
        root.innerHTML = document.getElementById('tpl-app').innerHTML;
        initHeader();
        initSidebar();
        initMenu();
        initMaterialsMenu();
        updateUserInfo();
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–π–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–∏–∑–∏—Ç–∞ –≤ —Ö–µ–¥–µ—Ä–µ
        try { VisitManager.init(); } catch(e){}
        // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–æ–¥–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º –≤–∏–∑–∏—Ç–µ
        try {
          Router.onBeforeNavigate((detail)=>{
            if (detail?.from === 'catalog' && detail?.to !== 'catalog' && VisitManager.isActive()){
              setTimeout(()=>VisitManager.promptFinish(), 0);
            }
          });
        } catch(e){}
      }

      async function updateUserInfo(){
        const user = await Auth.getCurrentUser();
        const nameEl = document.getElementById('userNameLabel');
        const roleEl = document.getElementById('userRoleLabel');
        if (user){
          nameEl.textContent = user.email;
          roleEl.textContent = user.role;
          // Admin visibility
          document.querySelectorAll('.admin-only').forEach(el => {
            el.style.display = (user.role === 'admin') ? '' : 'none';
          });
        }
      }

      function initSidebar(){
        const sidebar = document.getElementById('sidebar');
        const toggle = document.getElementById('toggleSidebar');
        toggle.addEventListener('click', () => {
          sidebar.classList.toggle('collapsed');
        });
        document.getElementById('logoutBtn').addEventListener('click', async () => {
          const ok = await Utils.showModal('–í—ã—Ö–æ–¥', '–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?', [
            { label:'–û—Ç–º–µ–Ω–∞', value:false, class:'border px-3 py-1.5 rounded-lg hover:bg-gray-50' },
            { label:'–í—ã–π—Ç–∏', value:true, class:'bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg' }
          ]);
          if (ok){
            try { window.Notifications?.stopAutoCheck?.(); } catch(_){ }
            try { window.Backup?.stopAutoBackup?.(); } catch(_){ }
            try { await window.ActivityLog?.logActivity?.(window.ActivityLog.LOG_ACTIONS.LOGOUT, 'users', Storage.getSession()?.userId ? String(Storage.getSession()?.userId) : null, {}); } catch(_){ }
            Auth.logout();
            Utils.showToast('–°–µ–∞–Ω—Å –∑–∞–≤–µ—Ä—à–µ–Ω', 'info');
            setupLogin();
          }
        });
      }

      function initHeader(){
        // Offline indicator
        try {
          if (!window.__btsOfflineInit){
            window.__btsOfflineInit = true;
            window.addEventListener('online', ()=>{
              document.getElementById('offline-indicator')?.classList.add('d-none');
              Utils.showToast('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
            });
            window.addEventListener('offline', ()=>{
              document.getElementById('offline-indicator')?.classList.remove('d-none');
              Utils.showToast('–†–∞–±–æ—Ç–∞ –≤ offline —Ä–µ–∂–∏–º–µ', 'warning');
            });
          }
          if (!navigator.onLine) document.getElementById('offline-indicator')?.classList.remove('d-none');
          else document.getElementById('offline-indicator')?.classList.add('d-none');
        } catch(_){ }

        // Notifications UI
        try {
          window.Notifications?.initUI?.();
          window.Notifications?.updateBadge?.();
        } catch(e){ console.warn('Notifications init failed', e); }
      }

      async function initMaterialsMenu(){
        const btn = document.getElementById('materialsBtn');
        const menu = document.getElementById('materialsMenu');
        const list = document.getElementById('materialsList');
        const settings = await Storage.get('settings', 'materials');
        const items = settings?.value || [];
        list.innerHTML = '';
        if (items.length === 0){
          const empty = document.createElement('div'); empty.className='px-3 py-2 text-gray-500 text-sm'; empty.textContent='–ù–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤'; list.appendChild(empty);
        } else {
          items.forEach((it, idx) => {
            const a = document.createElement('a');
            a.href = it.url || '#';
            a.target = '_blank';
            a.className = 'block px-3 py-2 hover:bg-gray-50 text-sm';
            a.textContent = it.name || ('–§–∞–π–ª ' + (idx+1));
            list.appendChild(a);
          });
        }
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          menu.classList.toggle('hidden');
        });
        document.addEventListener('click', (e) => {
          if (!menu.contains(e.target) && e.target !== btn) menu.classList.add('hidden');
        });
      }

      function initMenu(){
        document.getElementById('menu').addEventListener('click', (e) => {
          const a = e.target.closest('a[data-page]');
          if (!a) return;
          e.preventDefault();
          const page = a.getAttribute('data-page');
          Router.navigate(page);
        });
      }

      async function start(){
        try {
          await Storage.openDB();
          // –ú–∏–≥—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö
          await Storage.migrateIfNeeded();
          await Storage.seedIfEmpty();

          // –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º settings.timezone -> localStorage (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω)
          try {
            const tzRec = await Storage.get('settings', 'timezone').catch(()=>null);
            const tzVal = String(tzRec?.value || '').trim();
            if (tzVal){
              try { globalThis.TZ?.setTimeZone?.(tzVal); } catch(_){ }
            } else {
              // –µ—Å–ª–∏ –≤ settings –Ω–µ—Ç ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ—Ñ–æ–ª—Ç (–ú–æ—Å–∫–≤–∞)
              try { await Storage.put('settings', { key:'timezone', value: globalThis.TZ?.getTimeZone?.() || 'Europe/Moscow' }); } catch(_){ }
            }
          } catch(_){ }

          // PWA: Service Worker registration (best-effort)
          // –í–∞–∂–Ω–æ: –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç ¬´–∑–∞–ª–∏–ø–Ω—É—Ç—å¬ª –Ω–∞ —Å—Ç–∞—Ä–æ–π –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ (–∞ –≤ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ ‚Äî –≤—Å—ë –æ–∫).
          // –ü–æ—ç—Ç–æ–º—É:
          // 1) —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º SW
          // 2) —Ñ–æ—Ä—Å–∏–º update()
          // 3) –ø—Ä–∏ —Å–º–µ–Ω–µ controller –¥–µ–ª–∞–µ–º –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—É—é –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É
          try {
            if ('serviceWorker' in navigator){
              try {
                const reg = await navigator.serviceWorker.register('./sw.js');
                try { await reg.update(); } catch(_){ }
                if (!window.__btsSwCtlInit){
                  window.__btsSwCtlInit = true;
                  navigator.serviceWorker.addEventListener('controllerchange', ()=>{
                    if (window.__btsSwReloaded) return;
                    window.__btsSwReloaded = true;
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å–≤–µ–∂–∏–π index.html/—Å–∫—Ä–∏–ø—Ç—ã –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –≤—Ö–æ–¥–∞ –∏–∑-–∑–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫—ç—à–∞
                    location.reload();
                  });
                }
              } catch(e){
                console.warn('SW register failed', e);
              }
            }
          } catch(e){ console.warn('SW register skipped', e); }

          // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ XLSX (–≤ —Ñ–æ–Ω–µ), —á—Ç–æ–±—ã –∏–º–ø–æ—Ä—Ç/—ç–∫—Å–ø–æ—Ä—Ç Excel —Ä–∞–±–æ—Ç–∞–ª–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ
          try { XLSXLoader.preload(); } catch(e){}
          // –ü—Ä–µ–¥—Ä–∞—Å—á–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –≤ —Ñ–æ–Ω–µ (—É—Å–∫–æ—Ä—è–µ—Ç –æ—Ç–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ê–Ω–∞–ª–∏—Ç–∏–∫–∞)
          try { AnalyticsPrecalc.compute(); } catch(e){}
          const hashRaw = (location.hash || '').replace('#','');
          const forceLogin = hashRaw === 'login';
          if (forceLogin){
            setupLogin();
            return;
          }
          const user = await Auth.getCurrentUser();
          if (user){
            // –ê–≤—Ç–æ–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∏–∑–∏—Ç–æ–≤ –ø–æ –º–∞—Ä—à—Ä—É—Ç–∞–º (—Å–µ–≥–æ–¥–Ω—è + –∑–∞–≤—Ç—Ä–∞) + –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (—Å —É—á—ë—Ç–æ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞)
            try {
              const baseToday = (globalThis.TZ && typeof TZ.todayISO === 'function' && typeof TZ.parseISODate === 'function')
                ? TZ.parseISODate(TZ.todayISO())
                : new Date();
              await Scheduler.generatePlannedVisits(baseToday);
              await Scheduler.generatePlannedVisits(Scheduler.addDays(baseToday, 1));
              // cleanup –≤ —Ñ–æ–Ω–µ
              Scheduler.cleanupOldVisits().catch(()=>{});
            } catch(e){ console.warn('Scheduler autostart skipped', e); }

            // Notifications: check on load + start periodic checks
            try { await window.Notifications?.checkAndCreateNotifications?.(); } catch(e){ console.warn('Notifications check skipped', e); }
            try { window.Notifications?.startAutoCheck?.(); } catch(e){ }

            // Backup: run auto-backup and start periodic checks
            try { await window.Backup?.autoBackup?.(); } catch(e){ }
            try { window.Backup?.startAutoBackup?.(); } catch(e){ }

            setupApp();
            const hash = hashRaw || 'analytics';
            Router.navigate(hash);
          } else {
            setupLogin();
          }
        } catch (e){
          console.error('App start error:', e);
          try { setupLogin(); } catch(_){}
        }
      }

      return { start };
    })();

    // Pages controllers
    const Pages = (() => {
      function inRange(ts, start, end){ const t = (new Date(ts)).setHours(0,0,0,0); return t >= start && t <= end; }

      async function analytics(){
        // Elements
        const btns = document.querySelectorAll('[data-range]');
        const startInp = document.getElementById('anStart');
        const endInp = document.getElementById('anEnd');
        const applyBtn = document.getElementById('anApply');
        const resWrap = document.getElementById('anResults');
        const chart = document.getElementById('anChart');
        const setText = (id, txt)=> document.getElementById(id).textContent = txt;

        // Date helpers
        const todayStr = (globalThis.TZ && typeof TZ.todayISO==='function') ? TZ.todayISO() : new Date().toISOString().slice(0,10);
        function setRange(type){
          // –î–∏–∞–ø–∞–∑–æ–Ω—ã —Å—á–∏—Ç–∞–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ (TZ)
          const todayISO = (globalThis.TZ && typeof TZ.todayISO === 'function') ? TZ.todayISO() : new Date().toISOString().slice(0,10);
          let base = (globalThis.TZ && typeof TZ.parseISODate === 'function') ? TZ.parseISODate(todayISO) : new Date();
          let s = new Date(base), e = new Date(base);
          if (type==='today'){
            // s –∏ e = —Å–µ–≥–æ–¥–Ω—è –≤ TZ
          }
          if (type==='week'){
            s.setDate(s.getDate()-6);
          }
          if (type==='month'){
            s.setDate(s.getDate()-29);
          }
          // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω–ø—É—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–º —Å TZ
          const toISO = (dt)=> (globalThis.TZ && typeof TZ.isoDate==='function')? TZ.isoDate(dt): dt.toISOString().slice(0,10);
          startInp.value = toISO(s);
          endInp.value = toISO(e);
        }
        function validateSpan(){
          // –ü–∞—Ä—Å–∏–º —á–µ—Ä–µ–∑ TZ.parseISODate –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏
          const s = (globalThis.TZ && typeof TZ.parseISODate==='function') ? TZ.parseISODate(startInp.value) : new Date(startInp.value);
          const e = (globalThis.TZ && typeof TZ.parseISODate==='function') ? TZ.parseISODate(endInp.value) : new Date(endInp.value);
          const maxMs=93*24*60*60*1000; if ((e - s) > maxMs){ Utils.showToast('–ü–µ—Ä–∏–æ–¥ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 3 –º–µ—Å—è—Ü–∞', 'warning'); return false; } return true; }

        setRange('today');
        btns.forEach(b=> b.addEventListener('click', ()=>{ setRange(b.dataset.range); render(); }));
        applyBtn.addEventListener('click', ()=>{ if (validateSpan()) render(); });

        async function render(){
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º TZ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –Ω–∞—á–∞–ª–∞/–∫–æ–Ω—Ü–∞ –¥–Ω—è —Å–æ–≥–ª–∞—Å–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —á–∞—Å–æ–≤–æ–º—É –ø–æ—è—Å—É
          const sDate = (globalThis.TZ && typeof TZ.parseISODate==='function') ? TZ.parseISODate(startInp.value) : new Date(startInp.value);
          const eDate = (globalThis.TZ && typeof TZ.parseISODate==='function') ? TZ.parseISODate(endInp.value) : new Date(endInp.value);
          sDate.setHours(0,0,0,0); eDate.setHours(23,59,59,999);
          const s = sDate.getTime(); const e = eDate.getTime();
          const visits = await Storage.getAll('visits');
          const orders = await Storage.getAll('orders');
          const products = await Storage.getAll('products');
          const prodTopSet = new Set(products.filter(p=>p.topSku).map(p=>p.sku));

          const vSel = visits.filter(v=> inRange(v.date, s, e));
          const oSel = orders.filter(o=> inRange(o.date, s, e));

          // Visits KPIs
          const vTotal = vSel.length;
          const vPlanned = vSel.filter(v=>v.status==='–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω').length;
          // –í–Ω–µ–ø–ª–∞–Ω.: –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –≤–∏–∑–∏—Ç—ã –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –∑–∞–ø–∏—Å–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –≤ —ç—Ç–æ—Ç –∂–µ –¥–µ–Ω—å –ø–æ —Ç–æ–π –∂–µ —Ç–æ—á–∫–µ
          const byDayCode = new Map();
          vSel.forEach(v=>{
            const day = new Date(v.date); day.setHours(0,0,0,0); const key=day.getTime()+"|"+(v.outlet||'');
            if (!byDayCode.has(key)) byDayCode.set(key, []); byDayCode.get(key).push(v);
          });
          let vAdhoc=0; byDayCode.forEach(arr=>{
            const hasPlan = arr.some(x=>x.status==='–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω');
            if (!hasPlan) vAdhoc += arr.filter(x=>x.status==='—Å–æ–≤–µ—Ä—à–µ–Ω').length;
          });
          setText('anVisitsTotal', String(vTotal));
          setText('anVisitsPlanned', String(vPlanned));
          setText('anVisitsAdhoc', String(vAdhoc));

          // Results distribution for completed
          const done = vSel.filter(v=>v.status==='—Å–æ–≤–µ—Ä—à–µ–Ω');
          const dist = { order:0, noorder:0, wrong:0, noanswer:0, other:0 };
          done.forEach(v=>{ const r=v.result; if (r==='order'||r==='noorder'||r==='wrong'||r==='noanswer') dist[r]++; else dist.other++; });
          const doneCount = done.length || 1;
          resWrap.innerHTML = '';
          const labels = [
            ['‚úÖ –ó–∞–∫–∞–∑ —Å–¥–µ–ª–∞–Ω','order'],
            ['‚ùå –ë–µ–∑ –∑–∞–∫–∞–∑–∞','noorder'],
            ['üìµ –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä','wrong'],
            ['üìû –ù–µ—Ç –æ—Ç–≤–µ—Ç–∞','noanswer'],
            ['üìù –ü—Ä–æ—á–µ–µ','other']
          ];
          labels.forEach(([title,key])=>{
            const cnt = dist[key]||0; const pct = Math.round(cnt/doneCount*100);
            const bar=document.createElement('div');
            bar.innerHTML = `<div class="flex items-center justify-between"><div>${title}</div><div>${cnt} (${pct}%)</div></div>
              <div class="w-full h-2 bg-gray-100 rounded mt-1"><div class="h-2 bg-indigo-600 rounded" style="width:${pct}%"></div></div>`;
            resWrap.appendChild(bar);
          });

          // Orders sums
          const sum = oSel.reduce((s,o)=> s + (o.total||0), 0);
          const avg = oSel.length? sum/oSel.length : 0;
          setText('anOrdersTotal', Utils.formatCurrency(sum));
          setText('anOrdersAvg', Utils.formatCurrency(avg));
          setText('anOrdersCount', String(oSel.length));

          // Distribution by unique outlets
          const uniq = new Set(oSel.map(o=> o.outlet || (o.outletDetails?.code) || ''));
          const covered = Array.from(uniq).filter(Boolean).length;
          setText('anOutletsCovered', String(covered));
          setText('anAvgPerOutlet', Utils.formatCurrency(covered? sum/covered : 0));

          // Top SKU metrics (only products with topSku flag)
          const qBySku = new Map();
          oSel.forEach(o=> (o.items||[]).forEach(it=>{ if (prodTopSet.has(it.sku)) qBySku.set(it.sku, (qBySku.get(it.sku)||0) + Number(it.qty||0)); }));
          const totalTop = Array.from(qBySku.values()).reduce((a,b)=>a+b,0);
          setText('anTopSkuTotal', String(totalTop));
          setText('anTopSkuAvg', (oSel.length? String(Math.round(totalTop/oSel.length)) : '0'));
          const top5 = Array.from(qBySku.entries()).sort((a,b)=>b[1]-a[1]).slice(0,5);
          const prodBySku = new Map(products.map(p=>[p.sku, p]));
          const list = top5.map((e,i)=> `${i+1}. ${(prodBySku.get(e[0])?.name)||e[0]} - ${e[1]} —à—Ç.`).join('<br/>') || '<span class="text-gray-500">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö</span>';
          document.getElementById('anTop5').innerHTML = list;

          // Simple daily trend chart
          drawTrend(chart, oSel, sDate, eDate);
        }

        function drawTrend(canvas, orders, sDate, eDate){
          const days=[]; const cur=new Date(sDate); cur.setHours(0,0,0,0); const end=new Date(eDate); end.setHours(0,0,0,0);
          while(cur<=end){ days.push(new Date(cur)); cur.setDate(cur.getDate()+1); }
          const sums = days.map(d=>{ const t0=d.getTime(), t1=t0+24*60*60*1000-1; return orders.filter(o=>o.date>=t0 && o.date<=t1).reduce((s,o)=>s+(o.total||0),0); });
          const ctx = canvas.getContext('2d'); const W = canvas.width = canvas.clientWidth; const H = canvas.height; ctx.clearRect(0,0,W,H);
          const max = Math.max(...sums, 1); const pad=20; const stepX = (W - pad*2)/Math.max(1, sums.length-1);
          ctx.strokeStyle = '#cbd5e1'; ctx.beginPath(); ctx.moveTo(pad, H-20); ctx.lineTo(W-pad, H-20); ctx.stroke();
          ctx.strokeStyle = '#6366f1'; ctx.beginPath();
          sums.forEach((v,i)=>{ const x = pad + i*stepX; const y = H-20 - (v/max)*(H-40); if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
          ctx.stroke();
          ctx.fillStyle = '#6366f1'; sums.forEach((v,i)=>{ const x=pad+i*stepX; const y=H-20 - (v/max)*(H-40); ctx.beginPath(); ctx.arc(x,y,2.5,0,Math.PI*2); ctx.fill(); });
        }

        await render();
      }

      async function televisits(){
        // Cleanup previous intervals when navigating back/forth
        try { if (window.__tvInterval) { clearInterval(window.__tvInterval); window.__tvInterval = null; } } catch(_){ }

        const dateInp = document.getElementById('tvDate');
        const prevBtn = document.getElementById('tvPrev');
        const nextBtn = document.getElementById('tvNext');
        const rangeBtn = document.getElementById('tvRange');
        const rangePanel = document.getElementById('tvRangePanel');
        const rangeStartInp = document.getElementById('tvRangeStart');
        const rangeEndInp = document.getElementById('tvRangeEnd');
        const rangeApplyBtn = document.getElementById('tvRangeApply');
        const rangeClearBtn = document.getElementById('tvRangeClear');

        const addBtn = document.getElementById('tvAddVisit');
        const searchInp = document.getElementById('tvSearch');
        const listEl = document.getElementById('tvList');
        const statTotal = document.getElementById('tvStatTotal');
        const statPlanned = document.getElementById('tvStatPlanned');
        const statAdhoc = document.getElementById('tvStatAdhoc');
        const statDone = document.getElementById('tvStatDone');

        // Calendar info elements
        const calBaseEl = document.getElementById('tvCalendarBase');
        const dayNameEl = document.getElementById('tvDayName');
        const weekNoEl = document.getElementById('tvWeekNo');
        const weekParityEl = document.getElementById('tvWeekParity');

        // --- State (date / range) ---
        const state = {
          rangeEnabled: false,
          rangeStart: null,
          rangeEnd: null
        };

        const todayStr = (d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`)(new Date());
        dateInp.value = todayStr;

        /**
         * –õ–æ–∫–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ YYYY-MM-DD (–±–µ–∑ UTC-—Å–¥–≤–∏–≥–∞).
         * @param {string|number|Date} ts
         */
        function toISO(ts){
          const d = ts instanceof Date ? ts : new Date(ts);
          if (isNaN(d)) return '';
          const yyyy = d.getFullYear();
          const mm = String(d.getMonth()+1).padStart(2,'0');
          const dd = String(d.getDate()).padStart(2,'0');
          return `${yyyy}-${mm}-${dd}`;
        }
        function statusColor(s){ if(s==='–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω') return '#17a2b8'; if(s==='–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω') return '#ffc107'; if(s==='—Å–æ–≤–µ—Ä—à–µ–Ω') return '#28a745'; return '#6c757d'; }
        function typeIcon(v){ return (v.type==='unscheduled') ? '‚ö°' : 'üìÖ'; }

        function isoToTime(iso){ const d=new Date(iso); d.setHours(0,0,0,0); return d.getTime(); }
        function validateSpan(startIso, endIso){
          const s = isoToTime(startIso); const e = isoToTime(endIso);
          const maxMs = 93*24*60*60*1000;
          if (e < s){ Utils.showToast('–ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞ —Ä–∞–Ω—å—à–µ –Ω–∞—á–∞–ª–∞', 'warning'); return false; }
          if ((e - s) > maxMs){ Utils.showToast('–ü–µ—Ä–∏–æ–¥ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 3 –º–µ—Å—è—Ü–∞', 'warning'); return false; }
          return true;
        }

        /**
         * –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ñ–∏–ª—å—Ç—Ä (–æ–¥–Ω–∞ –¥–∞—Ç–∞ –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω).
         * @returns {{mode:'single', dates:string[]} | {mode:'range', dates:string[]}}
         */
        function getSelectedDates(){
          if (state.rangeEnabled && state.rangeStart && state.rangeEnd){
            const s = new Date(state.rangeStart); s.setHours(0,0,0,0);
            const e = new Date(state.rangeEnd); e.setHours(0,0,0,0);
            const days=[];
            const cur=new Date(s);
            while(cur<=e){
              days.push(`${cur.getFullYear()}-${String(cur.getMonth()+1).padStart(2,'0')}-${String(cur.getDate()).padStart(2,'0')}`);
              cur.setDate(cur.getDate()+1);
            }
            return { mode:'range', dates: days };
          }
          return { mode:'single', dates:[dateInp.value] };
        }

        /**
         * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞—Ç—É, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
         * - –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –ø–µ—Ä–∏–æ–¥, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–µ (today)
         * - –∏–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç–µ –∏–∑ date picker
         * @returns {Date}
         */
        function getCalendarBaseDate(){
          if (state.rangeEnabled) return new Date();
          return new Date(dateInp.value || new Date());
        }

        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç –±–ª–æ–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏, ISO-–Ω–æ–º–µ—Ä –Ω–µ–¥–µ–ª–∏, —á–µ—Ç–Ω–æ—Å—Ç—å.
         */
        function renderCalendarInfo(){
          const base = getCalendarBaseDate();
          base.setHours(12,0,0,0); // —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –æ—Ç TZ —Å–¥–≤–∏–≥–æ–≤
          const dayNames = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞','–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
          const isoDay = Scheduler.getISODayNumber(base); // 1..7
          const iso = Scheduler.getISOWeek(base);
          const weekNo = iso.week;
          const parity = (weekNo % 2 === 0) ? '–ß–µ—Ç–Ω–∞—è' : '–ù–µ—á–µ—Ç–Ω–∞—è';
          if (calBaseEl) calBaseEl.textContent = `${base.getFullYear()}-${String(base.getMonth()+1).padStart(2,'0')}-${String(base.getDate()).padStart(2,'0')}`;
          if (dayNameEl) dayNameEl.textContent = dayNames[(isoDay-1+7)%7] + ` (${isoDay})`;
          if (weekNoEl) weekNoEl.textContent = String(weekNo);
          if (weekParityEl) weekParityEl.textContent = parity;
        }

        // Auto-update calendar info every minute
        renderCalendarInfo();
        window.__tvInterval = setInterval(renderCalendarInfo, 60*1000);
        // –ü—Ä–∏–≤–æ–¥–∏–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ dateInp –∫ TZ "—Å–µ–≥–æ–¥–Ω—è", –µ—Å–ª–∏ –ø—É—Å—Ç–æ/–Ω–µ–≤–∞–ª–∏–¥–Ω–æ
        try {
          if (!dateInp.value){ dateInp.value = (globalThis.TZ && typeof TZ.todayISO==='function') ? TZ.todayISO() : new Date().toISOString().slice(0,10); }
        } catch(_){ }

        async function ensurePlanForDates(dates){
          // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–ª–∞–Ω–æ–≤—ã–µ –≤–∏–∑–∏—Ç—ã –¥–ª—è –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–∞—Ç
          for (const iso of (dates||[])){
            try { await Scheduler.generatePlannedVisits(new Date(iso)); } catch(e){}
          }
        }

        async function getData(){
          const outlets = await Storage.getAll('outlets');
          const contacts = await Storage.getAll('contacts');
          const contactsByCode = new Map(contacts.map(c=>[c.code, c.list||[]]));
          const visits = await Storage.getAll('visits');
          return { outlets, contactsByCode, visits };
        }

        function renderCard(v, contactsByCode){
          const div=document.createElement('div'); div.className='bg-white border rounded-xl p-4 shadow-sm cursor-pointer hover:shadow';
          const color=statusColor(v.status);
          const tag = typeIcon(v);
          const pr = Number(v.priority||0) || 0;
          const plannedISO = v.plannedDate || toISO(v.date);
          div.innerHTML = `
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm" style="color:${color}">${v.status==='–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω'?'üîµ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω': v.status==='–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω'?'üü° –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω':'üü¢ –°–æ–≤–µ—Ä—à–µ–Ω'} <span class="text-gray-400">‚Ä¢</span> ${tag} ${v.type==='unscheduled'?'–í–Ω–µ–ø–ª–∞–Ω–æ–≤—ã–π':'–ü–ª–∞–Ω–æ–≤—ã–π'} ${pr?`<span class="text-gray-400">‚Ä¢</span> –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ${pr}`:''}</div>
              <button data-contacts class="border rounded-lg px-2 py-1 text-sm hover:bg-gray-50">üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã</button>
            </div>
            <div class="text-xs text-gray-500 mb-1">üìÖ ${plannedISO}</div>
            <div class="text-sm text-gray-600">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${v.direction||'‚Äî'}</div>
            <div class="text-sm text-gray-600 flex items-center gap-2">–ö–æ–¥: <b>${v.outlet||v.outletCode||'‚Äî'}</b>
              <button type="button" data-copy="${v.outlet||v.outletCode||''}" class="border px-2 py-0.5 rounded text-xs hover:bg-gray-50" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥">üìã</button>
            </div>
            <div class="font-medium truncate">üè™ ${v.outletName||'‚Äî'}</div>
            <div class="text-sm text-gray-600 flex items-center gap-2">–ò–ù–ù: <b>${v.inn||'‚Äî'}</b>
              <button type="button" data-copy="${v.inn||''}" class="border px-2 py-0.5 rounded text-xs hover:bg-gray-50" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ò–ù–ù">üìã</button>
            </div>
            <div class="text-sm text-gray-600 truncate">üìç ${v.address||'‚Äî'}</div>
            <div class="my-2 border-t"></div>
            <div class="text-sm">üí≥ –û–ø–ª–∞—Ç–∞: ${v.payment||'‚Äî'}</div>
            <div class="text-sm">üí∞ –õ–∏–º–∏—Ç: ${v.creditLimit? Utils.formatCurrency(v.creditLimit):'‚Äî'} ‚îÇ –î–æ–ª–≥: ${v.debt? Utils.formatCurrency(v.debt):'‚Äî'}</div>
            <div class="text-sm">‚è±Ô∏è –í—Ä–µ–º—è: ${v.duration||'-'}</div>
          `;

          div.addEventListener('dblclick', async ()=>{
            // Start visit and navigate to catalog
            const outlet = { code:(v.outlet||v.outletCode), name:v.outletName, inn:v.inn, address:v.address, paymentTerms:v.payment };
            VisitManager.start(outlet, { plannedDate: plannedISO, type: (v.type||'scheduled'), priority: v.priority||null, operatorEmail: v.operatorEmail||v.operator||'' });
            window.currentVisitContext = { id: VisitManager.get().id, outletCode:(v.outlet||v.outletCode), clientName:v.outletName, inn:v.inn, plannedDate: plannedISO, visitType: v.type||'scheduled', priority: v.priority||null };
            Router.navigate('catalog');
          });

          // Copy buttons (code / INN)
          div.addEventListener('click', async (e)=>{
            const btn = e.target.closest('button[data-copy]');
            if (!btn) return;
            e.stopPropagation();
            const val = String(btn.getAttribute('data-copy')||'').trim();
            if (!val) return Utils.showToast('–ù–µ—á–µ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 'warning');
            await Utils.copyToClipboard(val);
          });

          div.querySelector('[data-contacts]').addEventListener('click', async (e)=>{
            e.stopPropagation();
            const code = (v.outlet||v.outletCode);
            const list = contactsByCode.get(code)||[]; const c=document.createElement('div');
            c.innerHTML = list.length? list.map(one => {
              const tel = String(one.phone||'').replace(/\D/g,'');
              return `<div class="py-1"><div>üë§ ${one.name||'‚Äî'}</div><div>üìû <a class="text-indigo-600 hover:text-indigo-700" href="tel:+${tel}">${one.phone||'‚Äî'}</a></div></div>`;
            }).join('<hr/>') : '<div class="text-sm text-gray-500">–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</div>';
            await Utils.showModal('–ö–æ–Ω—Ç–∞–∫—Ç—ã', c, [{label:'–ó–∞–∫—Ä—ã—Ç—å', value:false}]);
          });

          return div;
        }

        async function addUnscheduledVisit(){
          const outlets = await Storage.getAll('outlets');
          const c=document.createElement('div');
          c.innerHTML = `
            <div class="space-y-3">
              <div>
                <label class="block text-sm mb-1">–ü–æ–∏—Å–∫ —Ç–æ—á–∫–∏</label>
                <input id="uvSearch" class="w-full border rounded-lg px-3 py-2" placeholder="–ö–æ–¥, –Ω–∞–∑–≤–∞–Ω–∏–µ, –ò–ù–ù..."/>
                <div id="uvList" class="border rounded-lg mt-1 max-h-40 overflow-auto hidden"></div>
                <div class="text-xs text-gray-500 mt-1">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –∏–∑ —Å–ø–∏—Å–∫–∞</div>
              </div>
              <div>
                <label class="block text-sm mb-1">–î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞</label>
                <input id="uvDate" type="date" class="w-full border rounded-lg px-3 py-2" value="${dateInp.value}"/>
              </div>
            </div>`;
          let selected = null;
          const pickList = c.querySelector('#uvList');
          const inp = c.querySelector('#uvSearch');
          const renderList = (q)=>{
            const qq = String(q||'').toLowerCase().trim();
            pickList.innerHTML='';
            if (!qq){ pickList.classList.add('hidden'); return; }
            const found = outlets.filter(o=>{
              const hay=[o.code,o.name,o.inn,o.address].map(x=>String(x||'').toLowerCase()).join(' ');
              return hay.includes(qq);
            }).slice(0,25);
            found.forEach(o=>{
              const a=document.createElement('a');
              a.href='#'; a.className='block px-3 py-2 hover:bg-gray-50 text-sm';
              a.textContent = `${o.code} ‚Äî ${o.name||''} ‚Äî ${o.address||''} (${o.inn||'‚Äî'})`;
              a.addEventListener('click',(e)=>{ e.preventDefault(); selected=o; inp.value=`${o.code} ‚Äî ${o.name||''} ‚Äî ${o.address||''}`; pickList.classList.add('hidden'); });
              pickList.appendChild(a);
            });
            pickList.classList.toggle('hidden', found.length===0);
          };
          inp.addEventListener('input', Utils.debounce(()=>renderList(inp.value), 200));

          const ok = await Utils.showModal('–î–æ–±–∞–≤–∏—Ç—å –≤–Ω–µ–ø–ª–∞–Ω–æ–≤—ã–π –≤–∏–∑–∏—Ç', c, [
            {label:'–û—Ç–º–µ–Ω–∞', value:false, class:'border px-3 py-1.5 rounded-lg hover:bg-gray-50'},
            {label:'‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤ –ø–ª–∞–Ω', value:true, class:'bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg'}
          ]);
          if (!ok) return;
          if (!selected){ Utils.showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É', 'warning'); return; }
          const plannedDate = c.querySelector('#uvDate').value;
          if (!plannedDate){ Utils.showToast('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –≤–∏–∑–∏—Ç–∞', 'warning'); return; }

          const user = await Auth.getCurrentUser();

          // –ï—Å–ª–∏ –≤–∏–∑–∏—Ç –Ω–∞ —ç—Ç—É —Ç–æ—á–∫—É –Ω–∞ —ç—Ç—É –¥–∞—Ç—É —É–∂–µ –µ—Å—Ç—å ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º (–Ω–µ —Å–æ–∑–¥–∞–µ–º –¥—É–±–ª—å)
          const all = await Storage.getAll('visits').catch(()=>[]);
          const exists = (all||[]).find(v=> String(v.outlet||v.outletCode||'')===String(selected.code) && String(v.plannedDate||'')===String(plannedDate));

          const rec = {
            ...(exists||{}),
            id: exists?.id || Utils.generateId('visit'),
            date: (()=>{ const m=String(plannedDate||'').match(/^(\d{4})-(\d{2})-(\d{2})$/); const dt=m? new Date(Number(m[1]), Number(m[2])-1, Number(m[3])) : new Date(plannedDate); dt.setHours(0,0,0,0); return dt.getTime(); })(),
            plannedDate,
            outlet: selected.code,
            outletCode: selected.code,
            outletName: selected.name||'',
            inn: selected.inn||'',
            address: selected.address||'',
            payment: selected.paymentTerms||'',
            direction: selected.direction||'',
            creditLimit: selected.creditLimit||'',
            debt: selected.debt||'',
            status: '–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω',
            type: 'unscheduled',
            priority: 5,
            operator: user?.email||'',
            operatorEmail: user?.email||'',
            duration: exists?.duration || '-',
            createdAt: exists?.createdAt || Date.now()
          };
          await Storage.put('visits', rec);
          Utils.showToast(exists ? '–í–∏–∑–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω' : '–í–Ω–µ–ø–ª–∞–Ω–æ–≤—ã–π –≤–∏–∑–∏—Ç –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
          await render();
        }

        /**
         * –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è: —Ç–æ—á–∫–∞ –¥–æ–ª–∂–Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –æ–¥–∏–Ω —Ä–∞–∑.
         * –ü—Ä–∞–≤–∏–ª–æ: –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ (plannedDate + outletCode), –≤—ã–±–∏—Ä–∞–µ–º –∑–∞–ø–∏—Å—å —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º —Å—Ç–∞—Ç—É—Å–æ–≤:
         * —Å–æ–≤–µ—Ä—à–µ–Ω > –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω > –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω; –ø—Ä–∏ —Ä–∞–≤–µ–Ω—Å—Ç–≤–µ ‚Äî –±–µ—Ä–µ–º –±–æ–ª–µ–µ –Ω–æ–≤—É—é –ø–æ date/createdAt.
         */
        function dedupeVisits(list){
          const score = (v)=>{
            if (v.status==='—Å–æ–≤–µ—Ä—à–µ–Ω') return 3;
            if (v.status==='–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω') return 2;
            if (v.status==='–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω') return 1;
            return 0;
          };
          const map = new Map();
          for (const v of (list||[])){
            const key = String(v.plannedDate||'') + '|' + String(v.outlet||v.outletCode||'');
            const cur = map.get(key);
            if (!cur){ map.set(key, v); continue; }
            const s1 = score(cur), s2 = score(v);
            if (s2 > s1){ map.set(key, v); continue; }
            if (s2 === s1){
              const t1 = Number(cur.date||cur.createdAt||0);
              const t2 = Number(v.date||v.createdAt||0);
              if (t2 > t1) map.set(key, v);
            }
          }
          return Array.from(map.values());
        }

        async function render(){
          // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å—Ä–∞–∑—É –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ä–µ–Ω–¥–µ—Ä–µ
          try { renderCalendarInfo(); } catch(_){ }
          const sel = getSelectedDates();
          await ensurePlanForDates(sel.dates);

          const { outlets, contactsByCode, visits } = await getData();
          const user = await Auth.getCurrentUser();
          const q = searchInp.value.toLowerCase().trim();
          const allowedDates = new Set(sel.dates);

          // 1) —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç–µ/–¥–∏–∞–ø–∞–∑–æ–Ω—É
          let filtered = (visits||[])
            .filter(v=>{
              const iso = v.plannedDate || toISO(v.date);
              return allowedDates.has(iso);
            })
            .filter(v=>{
              // 2) –æ–ø–µ—Ä–∞—Ç–æ—Ä –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –≤–∏–∑–∏—Ç—ã (–ø–æ operatorEmail), –∞–¥–º–∏–Ω ‚Äî –≤—Å–µ
              if (user?.role==='admin') return true;
              const op = String(v.operatorEmail || v.operator || '').toLowerCase();
              return op === String(user?.email||'').toLowerCase();
            });

          // 3) –¥–µ–¥—É–ø –ø–æ —Ç–æ—á–∫–µ –Ω–∞ –¥–∞—Ç—É
          filtered = dedupeVisits(filtered);

          // 4) –ø–æ–∏—Å–∫
          if (q){
            filtered = filtered.filter(v=>{
              const out = outlets.find(o=>o.code===(v.outlet||v.outletCode)) || { name:v.outletName, address:v.address, inn:v.inn };
              const hay = [v.outlet, v.outletName, out.name, out.address, out.inn].map(x=>String(x||'').toLowerCase()).join(' ');
              return hay.includes(q);
            });
          }

          // 5) —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–≤–µ—Ä—Ö—É, –∑–∞—Ç–µ–º –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω—ã–µ, —Å–æ–≤–µ—Ä—à–µ–Ω–Ω—ã–µ ‚Äî –≤–Ω–∏–∑—É
          // –ü—Ä–∏ —Ä–∞–≤–µ–Ω—Å—Ç–≤–µ: priority ASC, –∑–∞—Ç–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
          const statusRank = (s)=> (s==='–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω'?0 : s==='–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω'?1 : s==='—Å–æ–≤–µ—Ä—à–µ–Ω'?2 : 3);
          filtered.sort((a,b)=>{
            const ar = statusRank(a.status);
            const br = statusRank(b.status);
            if (ar !== br) return ar - br;
            const ap = Number(a.priority||99), bp = Number(b.priority||99);
            if (ap !== bp) return ap - bp;
            return String(a.outletName||'').localeCompare(String(b.outletName||''));
          });

          // —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–ø–æ —Ç–µ–∫—É—â–µ–π –≤—ã–±–æ—Ä–∫–µ)
          statTotal.textContent = String(filtered.length);
          statPlanned.textContent = String(filtered.filter(v=> (v.type||'scheduled') !== 'unscheduled').length);
          statAdhoc.textContent = String(filtered.filter(v=> (v.type||'') === 'unscheduled').length);
          statDone.textContent = String(filtered.filter(v=> v.status==='—Å–æ–≤–µ—Ä—à–µ–Ω').length);

          listEl.innerHTML='';
          filtered.forEach(v=> listEl.appendChild(renderCard(v, contactsByCode)) );
        }

        // --- Range UI events ---
        rangeBtn.addEventListener('click', ()=>{
          rangePanel.classList.toggle('hidden');
        });
        rangeApplyBtn.addEventListener('click', async ()=>{
          const s = rangeStartInp.value;
          const e = rangeEndInp.value;
          if (!s || !e){ Utils.showToast('–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞', 'warning'); return; }
          if (!validateSpan(s,e)) return;
          state.rangeEnabled = true;
          state.rangeStart = s;
          state.rangeEnd = e;
          await render();
        });
        rangeClearBtn.addEventListener('click', async ()=>{
          state.rangeEnabled = false;
          state.rangeStart = null;
          state.rangeEnd = null;
          rangeStartInp.value = '';
          rangeEndInp.value = '';
          await render();
        });

        // --- Date navigation ---
        prevBtn.addEventListener('click', async ()=>{
          const d=new Date(dateInp.value); d.setDate(d.getDate()-1);
          dateInp.value = d.toISOString().slice(0,10);
          if (!state.rangeEnabled) await render();
        });
        nextBtn.addEventListener('click', async ()=>{
          const d=new Date(dateInp.value); d.setDate(d.getDate()+1);
          dateInp.value = d.toISOString().slice(0,10);
          if (!state.rangeEnabled) await render();
        });
        dateInp.addEventListener('change', async ()=>{ if (!state.rangeEnabled) await render(); });
        searchInp.addEventListener('input', Utils.debounce(render, 200));
        addBtn.addEventListener('click', addUnscheduledVisit);

        await render();
      }

      async function catalog(params={}){
        // State
        const state = {
          items: [],
          imgs: new Map(),
          filtered: [],
          view: localStorage.getItem('bts_cat_view')||'grid',
          search: params.q||'',
          topOnly: false,
          sort: localStorage.getItem('bts_cat_sort')||'sortOrder',
          filters: { vendor:new Set(), manufacturer:new Set(), category:new Set(), subcategory:new Set() },
          page: 0,
          pageSize: 30,
          cart: JSON.parse(localStorage.getItem('bts_cart')||'[]'),
          promos: [],
          activePromos: [],
          promoFilterSkus: null,
          promoActiveIdx: 0,
          promoTimer: null,
          infinite: (localStorage.getItem('bts_cat_infinite') === '1')
        };

        // Elements (updated to current promo cards block)
        const promoWrap = document.getElementById('promoCardsWrap');
        const promoPrev = document.getElementById('promoPrev');
        const promoNext = document.getElementById('promoNext');

        const catSearch = document.getElementById('catSearch');
        const viewGridBtn = document.getElementById('viewGridBtn');
        const viewTableBtn = document.getElementById('viewTableBtn');
        const topSkuBtn = document.getElementById('topSkuBtn');
        const catInfinite = document.getElementById('catInfinite');
        const resetFiltersBtn = document.getElementById('resetFiltersBtn');
        const sortBtn = document.getElementById('sortBtn');
        const sortMenu = document.getElementById('sortMenu');
        const statsEl = document.getElementById('catStats');
        const gridEl = document.getElementById('catGrid');
        const tableWrap = document.getElementById('catTableWrap');
        const tableBody = document.getElementById('catTable');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const cartOpenBtn = document.getElementById('cartOpenBtn');
        const cartBadge = document.getElementById('cartBadge');
        const cartTotalTop = document.getElementById('cartTotal');
        const cartOverlay = document.getElementById('cartOverlay');
        const cartPanel = document.getElementById('cartPanel');
        const cartCloseBtn = document.getElementById('cartCloseBtn');
        const cartBody = document.getElementById('cartBody');
        const cartTotalBottom = document.getElementById('cartTotalBottom');
        const cartExportBtn = document.getElementById('cartExportBtn');
        const cartClearBtn = document.getElementById('cartClearBtn');
        const cartCheckoutBtn = document.getElementById('cartCheckoutBtn');

        // Load data
        const prods = await Storage.getAll('products');
        const imgs = await Storage.getAll('productImages');
        state.items = prods;
        state.imgs = new Map(imgs.map(i=>[i.sku, i.images||[]]));

        // Load promos from dedicated store and filter active
        const promosAll = await Storage.getAll('promos').catch(()=>[]);
        state.promos = promosAll;
        state.activePromos = PromoEngine.getActive(promosAll);

        // --- Dependent filters (vendor/manufacturer/category/subcategory) ---
        /**
         * –°—Ç—Ä–æ–∏—Ç –æ–ø—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–¥–Ω–∞–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–æ–≤.
         * –§–∏–ª—å—Ç—Ä—ã –≤–∑–∞–∏–º–æ–∑–∞–≤–∏—Å–∏–º—ã: –≤—ã–±–æ—Ä –≤ –æ–¥–Ω–æ–º –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤ –¥—Ä—É–≥–∏—Ö.
         */
        function recomputeFilterOptions(){
          /**
           * –§–∞—Å–µ—Ç–Ω—ã–µ (–≤–∑–∞–∏–º–æ–∑–∞–≤–∏—Å–∏–º—ã–µ) —Ñ–∏–ª—å—Ç—Ä—ã —Å –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä–æ–º.
           * –í–∞–∂–Ω–æ: –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ü–æ—Å—Ç–∞–≤—â–∏–∫) –≤—ã–±–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ OR.
           * –ü–æ—ç—Ç–æ–º—É –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ –æ–ø—Ü–∏–π –¥–ª—è –≥—Ä—É–ø–ø—ã –º—ã –ù–ï –¥–æ–ª–∂–Ω—ã –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–π –≥—Ä—É–ø–ø–æ–π,
           * –∏–Ω–∞—á–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏—Å—á–µ–∑–∞—é—Ç –∏ –∏—Ö –Ω–µ–ª—å–∑—è –≤—ã–±—Ä–∞—Ç—å.
           */
          const base = state.items;
          const f = state.filters;

          /**
           * @param {Set<string>} set
           * @param {any} val
           */
          const selected = (set, val)=> set.size===0 || set.has(String(val||'').trim());

          /**
           * –¢–æ–≤–∞—Ä—ã, –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø–æ–¥ —Ñ–∏–ª—å—Ç—Ä—ã –≤—Å–µ—Ö –≥—Ä—É–ø–ø –ö–†–û–ú–ï excludeKey.
           * @param {any} p
           * @param {'vendor'|'manufacturer'|'category'|'subcategory'} excludeKey
           */
          function matchesExcept(p, excludeKey){
            if (excludeKey !== 'vendor' && !selected(f.vendor, p.vendor)) return false;
            if (excludeKey !== 'manufacturer' && !selected(f.manufacturer, p.manufacturer)) return false;
            if (excludeKey !== 'category' && !selected(f.category, p.category)) return false;
            if (excludeKey !== 'subcategory' && !selected(f.subcategory, p.subcategory)) return false;
            return true;
          }

          const sets = { vendor: new Map(), manufacturer:new Map(), category:new Map(), subcategory:new Map() };
          const allVals = { vendor: new Set(), manufacturer:new Set(), category:new Set(), subcategory:new Set() };

          const incr=(map,key)=>{
            if (key === null || key === undefined) return;
            const k = String(key).trim();
            if (!k) return;
            map.set(k,(map.get(k)||0)+1);
          };

          // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å–æ–≤—Å–µ–º –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö)
          base.forEach(p=>{
            const v = String(p.vendor||'').trim(); if (v) allVals.vendor.add(v);
            const m = String(p.manufacturer||'').trim(); if (m) allVals.manufacturer.add(m);
            const c = String(p.category||'').trim(); if (c) allVals.category.add(c);
            const s = String(p.subcategory||'').trim(); if (s) allVals.subcategory.add(s);
          });

          // –§–∞—Å–µ—Ç–Ω—ã–µ —Å—á—ë—Ç—á–∏–∫–∏: –¥–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã —Å—á–∏—Ç–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ –¥–∞–Ω–Ω—ã–º, –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–æ –¥—Ä—É–≥–∏–º –≥—Ä—É–ø–ø–∞–º
          base.forEach(p=>{
            if (matchesExcept(p, 'vendor')) incr(sets.vendor, p.vendor);
            if (matchesExcept(p, 'manufacturer')) incr(sets.manufacturer, p.manufacturer);
            if (matchesExcept(p, 'category')) incr(sets.category, p.category);
            if (matchesExcept(p, 'subcategory')) incr(sets.subcategory, p.subcategory);
          });

          const renderFilterGroup = (containerId, map, key) => {
            const wrap = document.getElementById(containerId);
            if (!wrap) return;
            wrap.innerHTML='';

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –∏—Ö —Å—á—ë—Ç—á–∏–∫ 0
            for (const val of Array.from(state.filters[key])){
              if (!map.has(val)) map.set(val, 0);
            }

            const entries = Array.from(map.entries()).sort((a,b)=> a[0].localeCompare(b[0]));
            entries.forEach(([name,count])=>{
              const id = `f_${key}_`+btoa(encodeURIComponent(name)).replace(/=+/g,'');
              const checked = state.filters[key].has(name);
              const div=document.createElement('div');
              div.innerHTML=`<label class="inline-flex items-center gap-2 w-full px-2 py-1 rounded-lg hover:bg-slate-50 cursor-pointer">
                <input type="checkbox" id="${id}" class="accent-indigo-600" ${checked?'checked':''}/>
                <span class="flex-1 min-w-0">${name}</span>
                <span class="text-gray-400">(${count})</span>
              </label>`;
              wrap.appendChild(div);
              div.querySelector('input').addEventListener('change', (e)=>{
                if (e.target.checked) state.filters[key].add(name);
                else state.filters[key].delete(name);
                // –ü–µ—Ä–µ—Å—á—ë—Ç —Ñ–∞—Å–µ—Ç–æ–≤ –∏ —Å–ø–∏—Å–∫–∞
                recomputeFilterOptions();
                applyFilters();
              });
            });
          };

          // –£–±–∏—Ä–∞–µ–º –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–ª—å–∫–æ —Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã—Ö –≤–æ–æ–±—â–µ –Ω–µ—Ç –≤ –±–∞–∑–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞/–æ—á–∏—Å—Ç–∫–∏)
          for (const key of ['vendor','manufacturer','category','subcategory']){
            for (const val of Array.from(state.filters[key])){
              if (!allVals[key].has(val)) state.filters[key].delete(val);
            }
          }

          renderFilterGroup('filterVendor', sets.vendor, 'vendor');
          renderFilterGroup('filterManufacturer', sets.manufacturer, 'manufacturer');
          renderFilterGroup('filterCategory', sets.category, 'category');
          renderFilterGroup('filterSubcategory', sets.subcategory, 'subcategory');
        }

        // initial render
        recomputeFilterOptions();

        // Helpers
        function saveCart(){ localStorage.setItem('bts_cart', JSON.stringify(state.cart)); updateCartUI(); }
        function cartCount(){ return state.cart.reduce((s,i)=> s + (i.qty||0), 0); }

        function getActivePromoSkusMap(){
          return PromoEngine.skusMap(state.activePromos);
        }
        const promoSkusMap = getActivePromoSkusMap();

        function recomputeDiscounts(){
          PromoEngine.applyPromos(state.cart, state.activePromos);
        }

        function cartTotal(){
          recomputeDiscounts();
          const subtotal = state.cart.reduce((s,i)=> s + (i.price||0)*(i.qty||0), 0);
          const discount = state.cart.reduce((s,i)=> s + (i._discountAmount||0), 0);
          return { subtotal, discount, total: Math.max(0, subtotal - discount) };
        }
        function updateCartUI(){ const t=cartTotal(); cartBadge.textContent = String(cartCount()); cartTotalTop.textContent = Utils.formatCurrency(t.total); cartTotalBottom.textContent = Utils.formatCurrency(t.total); }
        function showCart(open=true){ cartOverlay.classList.toggle('open', open); cartPanel.classList.toggle('open', open); if (open) renderCart(); }
        function addToCart(p, inc){
          const step = Number(p.shipmentQuantum||1) || 1;
          let item = state.cart.find(i=>i.sku===p.sku);
          if (!item){
            item = {
              sku: p.sku,
              name: p.name,
              barcode: String(p.barcode||''),
              price: Number(p.pricePromo||p.priceBase||p.price||0),
              qty: 0,
              image: (state.imgs.get(p.sku)||[])[0]||''
            };
            state.cart.push(item);
          }
          item.qty = Math.max(0, (item.qty||0) + (inc ?? step));
          if (item.qty===0){ state.cart = state.cart.filter(i=>i !== item); }
          saveCart(); animateCartAdd();
        }
        function animateCartAdd(){ cartBadge.classList.add('animate-bounce'); setTimeout(()=>cartBadge.classList.remove('animate-bounce'), 600); }
        function qtyControls(p){
          const item = state.cart.find(i=>i.sku===p.sku);
          if (!item){ return `<button data-act="add" data-sku="${p.sku}" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg text-sm">‚ûï –í –∫–æ—Ä–∑–∏–Ω—É</button>`; }
          return `
            <div class="inline-flex items-center gap-2">
              <button data-act="dec" data-sku="${p.sku}" class="border px-2 py-1 rounded">-</button>
              <input data-act="qty" data-sku="${p.sku}" type="number" class="w-16 border rounded px-2 py-1 text-center tabular-nums" value="${item.qty}" min="0" />
              <button data-act="inc" data-sku="${p.sku}" class="border px-2 py-1 rounded">+</button>
            </div>`;
        }
        function applyFilters(){
          const s = state.search.toLowerCase().trim();
          const f = state.filters; const hasAny = Object.values(f).some(set=>set.size>0);
          const selected = (set, val)=> set.size===0 || set.has(String(val||'').trim());
          const promoSet = state.promoFilterSkus ? new Set(state.promoFilterSkus.map(x=>String(x||'').trim())) : null;
          state.filtered = state.items.filter(p=>{
            // –¢–û–ü SKU: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö –≤ —à–∞–±–ª–æ–Ω–µ –¢–û–ü –°–ö–Æ = 1
            // –•—Ä–∞–Ω–∏–º –∫–∞–∫ —á–∏—Å–ª–æ 1/0, –Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ, –≥–¥–µ topSku –º–æ–≥ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π.
            if (state.topOnly && !(p.topSku === 1 || String(p.topSku) === '1')) return false;
            // –ü—Ä–æ–º–æ-—Ñ–∏–ª—å—Ç—Ä: –∞–∫—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –∑–∞–¥–∞—é—Ç—Å—è –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞–º. –û—Å—Ç–∞–≤–ª—è–µ–º –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø–æ SKU.
            if (promoSet){
              const keySku = String(p.sku||'').trim();
              const keyBarcode = String(p.barcode||'').trim();
              const match = (keyBarcode && promoSet.has(keyBarcode)) || (keySku && promoSet.has(keySku));
              if (!match) return false;
            }
            // text search across fields
            if (s){ const hay = [p.name,p.sku,p.barcode,p.category,p.manufacturer,p.vendor].map(x=>String(x||'').toLowerCase()).join(' '); if (!hay.includes(s)) return false; }
            if (hasAny){ if (!selected(f.vendor, p.vendor)) return false; if (!selected(f.manufacturer, p.manufacturer)) return false; if (!selected(f.category, p.category)) return false; if (!selected(f.subcategory, p.subcategory)) return false; }
            return true;
          });
          applySort();
          state.page = 0; renderList(); updateStats();
          localStorage.setItem('bts_cat_view', state.view);
          localStorage.setItem('bts_cat_sort', state.sort);
        }
        function applySort(){
          const cmp = {
            'name-asc': (a,b)=> String(a.name||'').localeCompare(String(b.name||'')),
            'name-desc': (a,b)=> String(b.name||'').localeCompare(String(a.name||'')),
            'price-asc': (a,b)=> (Number(a.pricePromo||a.priceBase||a.price||0) - Number(b.pricePromo||b.priceBase||b.price||0)),
            'price-desc': (a,b)=> (Number(b.pricePromo||b.priceBase||b.price||0) - Number(a.pricePromo||a.priceBase||a.price||0)),
            'category': (a,b)=> String(a.category||'').localeCompare(String(b.category||'')) || String(a.name||'').localeCompare(String(b.name||'')),
            'sortOrder': (a,b)=> Number(a.sortOrder||0) - Number(b.sortOrder||0)
          };
          state.filtered.sort(cmp[state.sort]||cmp.sortOrder);
        }
        function updateStats(){ statsEl.textContent = `–ù–∞–π–¥–µ–Ω–æ: ${state.filtered.length}`; }

        function renderList(){
          const isGrid = state.view==='grid';
          const slice = state.infinite ? state.filtered : state.filtered.slice(0, (state.page+1)*state.pageSize);

          // Hard toggle (prevents ‚Äúsplit screen‚Äù when some CSS frameworks override .hidden)
          gridEl.classList.toggle('hidden', !isGrid);
          tableWrap.classList.toggle('hidden', isGrid);
          gridEl.style.display = isGrid ? '' : 'none';
          tableWrap.style.display = isGrid ? 'none' : '';

          // Pagination button
          if (state.infinite){
            loadMoreBtn.style.display = 'none';
          } else {
            loadMoreBtn.style.display = slice.length < state.filtered.length ? '' : 'none';
          }

          if (isGrid){
            gridEl.innerHTML='';
            slice.forEach(p=> gridEl.appendChild(renderCard(p)) );
            // Lazy-load images for newly rendered cards
            observeProductImages(gridEl);
          } else {
            tableBody.innerHTML='';
            slice.forEach(p=> tableBody.appendChild(renderRow(p)) );
            // Lazy-load images for table
            observeProductImages(tableBody);
          }
        }

        // --- Lazy image loader (IntersectionObserver) ---
        const IMG_FINAL_CACHE = new Map();
        /**
         * localImageService ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç–æ–≤–∞—Ä–∞ –∏–∑ IndexedDB.productImages.
         * –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç id = barcode –∏–ª–∏ sku.
         */
        const localImageService = {
          /**
           * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ SKU/—à—Ç—Ä–∏—Ö–∫–æ–¥—É/–∏–º–µ–Ω–æ–≤–∞–Ω–∏—é —Ñ–∞–π–ª–∞ (—Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º –∏–ª–∏ –±–µ–∑).
           * –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç id –≤–∏–¥–∞: 'SKU123', '4601234567890', '1111111111.jpg', '1111111111.png'.
           *
           * –í–ê–ñ–ù–û: —Å–Ω–∞—á–∞–ª–∞ —Å–º–æ—Ç—Ä–∏–º –≤ state.imgs (–∫–∞—Ä—Ç–∞, –ø–æ–ª—É—á–µ–Ω–Ω–∞—è –∏–∑ getAll('productImages'))
           * ‚Äî —ç—Ç–æ –±—ã—Å—Ç—Ä–µ–µ –∏ –Ω–∞–¥–µ–∂–Ω–µ–µ, —á–µ–º –¥–µ—Ä–≥–∞—Ç—å IndexedDB –Ω–∞ –∫–∞–∂–¥—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É.
           * –í –∫–æ–Ω—Ü–µ –¥–µ–ª–∞–µ–º fallback –≤ IndexedDB –Ω–∞ —Å–ª—É—á–∞–π ¬´—É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ¬ª state.imgs.
           *
           * @param {string} id
           * @returns {Promise<string|null>} base64 dataURL
           */
          async getById(id){
            const raw = String(id||'').trim();
            if (!raw) return null;

            // 0) –ü—Ä–æ–±—É–µ–º —Ç–æ—á–Ω—ã–π –∫–ª—é—á ¬´–∫–∞–∫ –µ—Å—Ç—å¬ª (–Ω–∞ —Å–ª—É—á–∞–π —Å—Ç–∞—Ä—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤, –≥–¥–µ sku –º–æ–≥ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º)
            try {
              const direct = state.imgs.get(raw);
              if (direct?.[0]) return direct[0];
            } catch(_){ }

            // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: —É–±–∏—Ä–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
            const key = raw.replace(/\.(jpe?g|png|webp)$/i, '');

            // 1) –¢–æ—á–Ω—ã–π SKU
            try {
              const bySku = state.imgs.get(key);
              if (bySku?.[0]) return bySku[0];
            } catch(_){ }

            // 2) –ü–æ–∏—Å–∫ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É (barcode ‚Üí sku)
            try {
              const prods = state.items || [];
              const found = prods.find(x => String(x.barcode||'').trim() === key);
              if (found?.sku){
                const byMappedSku = state.imgs.get(found.sku);
                if (byMappedSku?.[0]) return byMappedSku[0];
              }
            } catch(_){ }

            // 3) Fallback –≤ IndexedDB (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ state.imgs —É—Å—Ç–∞—Ä–µ–ª)
            try {
              const recBySku = await Storage.get('productImages', key).catch(()=>null);
              if (recBySku?.images?.[0]) return recBySku.images[0];

              const prods = state.items || [];
              const found = prods.find(x => String(x.barcode||'').trim() === key);
              if (found?.sku){
                const recByBarcode = await Storage.get('productImages', found.sku).catch(()=>null);
                if (recByBarcode?.images?.[0]) return recByBarcode.images[0];
              }
            } catch(_){ }

            return null;
          }
        };

        /**
         * Placeholder dataURL (simple SVG) when no image.
         * @param {string} text
         */
        function placeholderDataURL(text){
          const t = (text||'').toString().slice(0,18);
          const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300"><rect width="100%" height="100%" fill="#f1f5f9"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#64748b" font-family="Arial" font-size="18">${String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;')}</text></svg>`;
          return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
        }

        let imageObserver = null;
        function setupImageObserver(){
          if (imageObserver) imageObserver.disconnect();
          imageObserver = new IntersectionObserver(entries => {
            entries.forEach(async entry => {
              if (!entry.isIntersecting) return;
              const img = entry.target;
              const sku = img.getAttribute('data-sku');
              const barcode = img.getAttribute('data-barcode');
              const cacheKey = (barcode || sku || '').toString();
              const cached = IMG_FINAL_CACHE.get(cacheKey);
              if (cached){
                img.src = cached;
                img.setAttribute('data-loaded', '1');
                img.classList.remove('skeleton');
                imageObserver.unobserve(img);
                return;
              }
              if (img.getAttribute('data-loaded') === '1') return;

              // 1) –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω–æ–µ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞
              let localUrl = await localImageService.getById(barcode || sku) || await localImageService.getById(sku);

              // 2) –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ ‚Äî –ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∑–∞–≥–ª—É—à–∫—É –ø–æ –∫–æ–¥—É 1111111111 (Excel/—Ñ–æ—Ç–æ-–±–∞–Ω–∫)
              if (!localUrl){
                // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∑–∞–≥–ª—É—à–∫—É –ø–æ –∫–æ–¥—É 1111111111 (–≤–∫–ª—é—á–∞—è –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º)
                localUrl =
                  await localImageService.getById('1111111111') ||
                  await localImageService.getById('1111111111.jpg') ||
                  await localImageService.getById('1111111111.jpeg') ||
                  await localImageService.getById('1111111111.webp') ||
                  await localImageService.getById('1111111111.png');
              }

              const src = localUrl || placeholderDataURL(sku || barcode);
              IMG_FINAL_CACHE.set(cacheKey, src);
              img.src = src;
              img.setAttribute('data-loaded', '1');
              img.classList.remove('skeleton');

              imageObserver.unobserve(img);
            });
          }, { rootMargin: '200px 0px' });
        }

        function observeProductImages(root){
          if (!imageObserver) setupImageObserver();
          (root || document).querySelectorAll('img[data-lazy="1"]').forEach(img => {
            if (img.getAttribute('data-loaded') === '1') return;
            imageObserver.observe(img);
          });
        }

        function renderImagesCarousel(imgs, sku, barcode, opts={}){
          const wrap=document.createElement('div');
          wrap.className='relative';
          wrap.dataset.sku = sku || '';
          wrap.setAttribute('data-img-wrap','1');

          const imgEl=document.createElement('img');
          imgEl.loading='lazy';
          imgEl.src = placeholderDataURL(sku || barcode);
          imgEl.className='product-img skeleton';
          imgEl.setAttribute('data-lazy','1');
          imgEl.setAttribute('data-sku', sku || '');
          imgEl.setAttribute('data-barcode', barcode || '');
          wrap.appendChild(imgEl);

          // Top SKU badge ‚Äî left top (thumb up)
          const isTop = (opts?.topSku === 1 || String(opts?.topSku) === '1' || opts?.topSku === true);
          if (isTop){
            const b=document.createElement('div');
            b.className='absolute top-1 left-1 bg-amber-500 text-white text-xs px-2 py-0.5 rounded';
            b.innerHTML = '<i class="bi bi-hand-thumbs-up-fill"></i>';
            b.title = '–¢–û–ü SKU';
            wrap.appendChild(b);
          }

          // Promo badge ‚Äî right top: "–ï—â–µ –¥–µ—à–µ–≤–ª–µ" —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π
          const promosFor = promoSkusMap.get(String(barcode||sku||'').trim()) || promoSkusMap.get(String(sku||'').trim());
          if (promosFor && promosFor.length){
            const p = promosFor[0];
            const hint = (()=>{
              const t = (p.type||'').toLowerCase();
              if (t==='–∫—É–ø–∏_–ø–æ–ª—É—á–∏'){
                const it=p.items?.[0];
                return `–ö—É–ø–∏ ${it?.requiredQty||1} —à—Ç. ‚Äî —Å–∫–∏–¥–∫–∞ ${p.discountPercent||0}%`;
              }
              if (t==='–Ω–∞–±–æ—Ä'){
                return `–ù–∞–±–æ—Ä ‚Äî —Å–∫–∏–¥–∫–∞ ${p.discountPercent||0}% –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π`;
              }
              return p.name||'–ê–ö–¶–ò–Ø';
            })();
            const b=document.createElement('div');
            b.className='absolute top-1 right-1 bg-rose-600 text-white text-xs px-2 py-0.5 rounded shadow';
            b.textContent='–ï—â–µ –¥–µ—à–µ–≤–ª–µ';
            b.title = hint;
            wrap.appendChild(b);
          }

          // –ü–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏–µ –≤ –ø–ª–∏—Ç–∫–µ/—Ç–∞–±–ª–∏—Ü–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ: —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –±–µ–π–¥–∂–∏.
          return wrap;
        }

        function priceBlock(p){
          const base = Number(p.priceBase||p.price||0); const promo = Number(p.pricePromo||0);
          if (promo && promo < base){
            return `<div><div class="text-sm text-gray-600 line-through">${Utils.formatCurrency(base)}</div><div class="text-red-600 font-medium">${Utils.formatCurrency(promo)} üî•</div></div>`;
          }
          return `<div class="font-medium">${Utils.formatCurrency(base)}</div>`;
        }

        function renderCard(p){
          const card=document.createElement('div');
          // Compact card for 5-column layout
          card.className='product-card bg-white border rounded-xl p-2 shadow-sm';

          const imgs = state.imgs.get(p.sku)||[];
          const top = document.createElement('div');
          top.appendChild(renderImagesCarousel(imgs, p.sku, p.barcode, { topSku: (p.topSku === 1 || String(p.topSku) === '1') }));
          card.appendChild(top);

          const title=document.createElement('div');
          title.className='mt-2 two-line-title text-slate-900';
          title.textContent=p.name||p.fullName||p.sku;
          card.appendChild(title);

          const pack=document.createElement('div');
          pack.className='text-xs text-gray-600 mt-1';
          pack.textContent='–®—Ç. –≤ –±–ª–æ–∫–µ: ' + (p.unitsInBox||p.shipmentQuantum||1);
          card.appendChild(pack);

          const hr=document.createElement('div'); hr.className='my-2 border-t'; card.appendChild(hr);

          const price=document.createElement('div');
          price.innerHTML=priceBlock(p);
          card.appendChild(price);

          const hr2=document.createElement('div'); hr2.className='my-2 border-t'; card.appendChild(hr2);

          const controls=document.createElement('div');
          controls.innerHTML=qtyControls(p);
          card.appendChild(controls);

          const lineTotal=document.createElement('div');
          lineTotal.className='text-xs text-gray-600 mt-1';
          card.appendChild(lineTotal);

          function updateLineTotal(){
            const item = state.cart.find(i=>i.sku===p.sku);
            if (!item || !item.qty){ lineTotal.textContent = ''; return; }
            // –ò—Ç–æ–≥–æ: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ * —Ü–µ–Ω–∞ (—Å —É—á–µ—Ç–æ–º –ø—Ä–æ–º–æ, —Ç.–∫. item.price = promo/base)
            const total = (Number(item.qty||0) * Number(item.price||0));
            lineTotal.innerHTML = `–ò—Ç–æ–≥–æ: <b>${Utils.formatCurrency(total)}</b>`;
          }
          updateLineTotal();

          // Double click ‚Äî open product modal
          card.addEventListener('dblclick', ()=> openProductModal(p));

          card.addEventListener('click', (e)=>{
            const btn=e.target.closest('[data-act]');
            if(!btn) return;
            const act=btn.getAttribute('data-act');
            if (act==='add'){ addToCart(p); controls.innerHTML=qtyControls(p); updateLineTotal(); }
            if (act==='inc'){ addToCart(p, + (p.shipmentQuantum||1)); controls.innerHTML=qtyControls(p); updateLineTotal(); }
            if (act==='dec'){ addToCart(p, - (p.shipmentQuantum||1)); controls.innerHTML=qtyControls(p); updateLineTotal(); }
          });
          card.addEventListener('change', (e)=>{
            const inp=e.target.closest('input[data-act="qty"]');
            if (!inp) return;
            const qty=Math.max(0, Number(inp.value||0));
            const item=state.cart.find(i=>i.sku===p.sku);
            if (item){ item.qty=qty; saveCart(); controls.innerHTML=qtyControls(p); updateLineTotal(); }
          });

          return card;
        }

        function renderRow(p){
          const tr=document.createElement('tr');
          const sku = p.sku;
          const barcode = p.barcode || '';
          const imgPlaceholder = placeholderDataURL(sku || barcode);

          const topMark = (p.topSku === true || p.topSku === 1 || p.topSku === '1') ? '<span class="absolute -top-1 -left-1 bg-amber-500 text-white text-[10px] px-1 rounded" title="–¢–û–ü SKU"><i class="bi bi-hand-thumbs-up-fill"></i></span>' : '';
          const promoMark = promoSkusMap.has(sku) ? '<span class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] px-1 rounded" title="–ê–∫—Ü–∏—è">üî•</span>' : '';

          const cartCellHtml = ()=>{
            const item = state.cart.find(i=>i.sku===p.sku);
            const total = item && item.qty ? (Number(item.qty||0) * Number(item.price||0)) : 0;
            const line = (item && item.qty) ? `<div class="text-xs text-gray-600 mt-1">–ò—Ç–æ–≥–æ: <b>${Utils.formatCurrency(total)}</b></div>` : '';
            return `${qtyControls(p)}${line}`;
          };

          tr.innerHTML = `
            <td class="py-2 pr-2">
              <div class="relative inline-block" data-img-wrap="1">
                ${topMark}
                ${promoMark}
                <img
                  src="${imgPlaceholder}"
                  data-lazy="1"
                  data-sku="${sku}"
                  data-barcode="${barcode}"
                  class="product-img-table border skeleton"
                  alt="${String(sku||'')}">
              </div>
            </td>
            <td class="py-2 pr-2">${p.sku}</td>
            <td class="py-2 pr-2"><div class="title-3lines">${p.name||''}</div></td>
            <td class="py-2 pr-2">${p.category||''}</td>
            <td class="py-2 pr-2">${Utils.formatCurrency(p.priceBase||p.price||0)}</td>
            <td class="py-2 pr-2">${p.pricePromo? Utils.formatCurrency(p.pricePromo): '‚Äî'}</td>
            <td class="py-2 pr-2">${p.unitsInBox||p.shipmentQuantum||1}</td>
            <td class="py-2 pr-2">${cartCellHtml()}</td>
          `;

          tr.addEventListener('dblclick', ()=> openProductModal(p));
          tr.addEventListener('click', (e)=>{
            const btn=e.target.closest('[data-act]');
            if(!btn) return;
            const act=btn.getAttribute('data-act');
            if (act==='add'){ addToCart(p); tr.querySelector('td:last-child').innerHTML=cartCellHtml(); }
            if (act==='inc'){ addToCart(p, + (p.shipmentQuantum||1)); tr.querySelector('td:last-child').innerHTML=cartCellHtml(); }
            if (act==='dec'){ addToCart(p, - (p.shipmentQuantum||1)); tr.querySelector('td:last-child').innerHTML=cartCellHtml(); }
          });
          tr.addEventListener('change', (e)=>{
            const inp=e.target.closest('input[data-act="qty"]');
            if (!inp) return;
            const qty=Math.max(0, Number(inp.value||0));
            const item=state.cart.find(i=>i.sku===p.sku);
            if (item){ item.qty=qty; saveCart(); tr.querySelector('td:last-child').innerHTML=cartCellHtml(); }
          });
          return tr;
        }

        function renderCart(){
          cartBody.innerHTML='';
          if (state.cart.length===0){ cartBody.innerHTML = '<div class="text-sm text-gray-500">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>'; return; }
          recomputeDiscounts();
          state.cart.forEach(item=>{
            const div=document.createElement('div'); div.className='border rounded-lg p-2 flex gap-2 items-center';
            const img=item.image? `<img src="${item.image}" class="w-12 h-12 rounded border"/>` : '<div class="w-12 h-12 rounded border bg-gray-100"></div>';
            const lineSubtotal = (item.price||0)*(item.qty||0);
            const disc = Math.round(item._discountAmount||0);
            const lineTotal = Math.max(0, lineSubtotal - disc);
            div.innerHTML = `${img}
              <div class="flex-1 min-w-0">
                <div class="truncate">${item.name}</div>
                <div class="text-xs text-gray-500">–ê—Ä—Ç–∏–∫—É–ª: ${item.sku}</div>
                <div class="text-sm">–¶–µ–Ω–∞: ${Utils.formatCurrency(item.price)} √ó ${item.qty} = <b>${Utils.formatCurrency(lineSubtotal)}</b></div>
                ${disc>0 ? `<div class="text-sm text-red-600">üî• ${item._promoApplied||'–ê–ö–¶–ò–Ø'} -${item._discountPercent}%: -${Utils.formatCurrency(disc)}</div>`:''}
                ${disc>0 ? `<div class="text-sm">–ò—Ç–æ–≥–æ: <b>${Utils.formatCurrency(lineTotal)}</b></div>`:''}
              </div>
              <div class="flex items-center gap-2">
                <button data-act="dec" data-sku="${item.sku}" class="border px-2 py-1 rounded">-</button>
                <input data-act="qty" data-sku="${item.sku}" type="number" class="w-16 border rounded px-2 py-1 text-center tabular-nums" value="${item.qty}" min="0" />
                <button data-act="inc" data-sku="${item.sku}" class="border px-2 py-1 rounded">+</button>
                <button data-act="rm" data-sku="${item.sku}" class="text-red-600 hover:text-red-700">üóëÔ∏è</button>
              </div>`;
            cartBody.appendChild(div);
          });
        }

        function openProductModal(p){
          // Photos: main (by SKU) + fallback image (special code 1111111111)
          const skuImgs = (state.imgs.get(p.sku)||[]).filter(Boolean);
          const fallbackImgs = (state.imgs.get('1111111111')||[]).filter(Boolean);
          let all = skuImgs.length ? skuImgs : fallbackImgs;

          const cont=document.createElement('div');
          const inPromo = promoSkusMap.has(p.sku);

          const wrap = document.createElement('div');
          wrap.className = 'space-y-3';

          // --- Carousel (only in modal) ---
          const carousel = document.createElement('div');
          carousel.className = 'relative';
          let idx = 0;

          const imgEl = document.createElement('img');
          imgEl.loading = 'lazy';
          imgEl.className = 'product-img';
          imgEl.style.height = '130px';
          imgEl.src = all[0] || placeholderDataURL(p.sku || p.barcode);
          carousel.appendChild(imgEl);

          // Removed badge overlay for fallback images per new requirements

          // TOP SKU badge
          if (p.topSku === 1 || String(p.topSku) === '1'){ 
            const b=document.createElement('div');
            b.className='absolute top-1 left-1 bg-amber-500 text-white text-xs px-2 py-0.5 rounded flex items-center gap-1';
            b.innerHTML = '<i class="bi bi-hand-thumbs-up-fill"></i><span>–¢–û–ü</span>';
            carousel.appendChild(b);
          }

          // Promo badge
          if (inPromo){
            const b=document.createElement('div');
            b.className='absolute top-1 right-1 bg-red-600 text-white text-xs px-2 py-0.5 rounded';
            b.textContent='üî• –ê–ö–¶–ò–Ø';
            carousel.appendChild(b);
          }

          const dots = document.createElement('div');
          dots.className = 'carousel-dots mt-2';

          function renderDots(){
            dots.innerHTML='';
            if (all.length <= 1) return;
            all.forEach((_, i)=>{
              const d = document.createElement('button');
              d.type = 'button';
              d.className = 'carousel-dot' + (i===idx ? ' active' : '');
              d.title = '–§–æ—Ç–æ ' + (i+1);
              d.addEventListener('click', (e)=>{ e.stopPropagation(); idx = i; update(); });
              dots.appendChild(d);
            });
          }

          function update(){
            imgEl.src = all[idx] || placeholderDataURL(p.sku || p.barcode);
            renderDots();
          }

          if (all.length > 1){
            const prev = document.createElement('button');
            prev.type = 'button';
            prev.className = 'absolute left-2 top-1/2 -translate-y-1/2 bg-white/90 border rounded-lg px-2 py-1 text-gray-700 hover:bg-white';
            prev.innerHTML = '<i class="bi bi-chevron-left"></i>';
            prev.addEventListener('click', (e)=>{ e.stopPropagation(); idx = (idx - 1 + all.length) % all.length; update(); });

            const next = document.createElement('button');
            next.type = 'button';
            next.className = 'absolute right-2 top-1/2 -translate-y-1/2 bg-white/90 border rounded-lg px-2 py-1 text-gray-700 hover:bg-white';
            next.innerHTML = '<i class="bi bi-chevron-right"></i>';
            next.addEventListener('click', (e)=>{ e.stopPropagation(); idx = (idx + 1) % all.length; update(); });

            carousel.appendChild(prev);
            carousel.appendChild(next);

            // click on image = next
            imgEl.style.cursor = 'pointer';
            imgEl.addEventListener('click', ()=>{ idx = (idx + 1) % all.length; update(); });
          }

          wrap.appendChild(carousel);
          wrap.appendChild(dots);
          renderDots();

          const title = document.createElement('div');
          title.className = 'font-medium text-lg';
          title.textContent = p.name||p.sku;
          wrap.appendChild(title);

          if (p.fullName){
            const full = document.createElement('div');
            full.className = 'text-xs text-gray-500';
            full.textContent = p.fullName;
            wrap.appendChild(full);
          }

          const skuRow = document.createElement('div');
          skuRow.className = 'text-sm text-gray-600 flex items-center gap-2';
          skuRow.innerHTML = `–ê—Ä—Ç–∏–∫—É–ª: ${p.sku} <button data-copy="${p.sku}" class="border px-2 py-1 rounded text-xs">üìã</button>`;
          wrap.appendChild(skuRow);

          const bcRow = document.createElement('div');
          bcRow.className = 'text-sm text-gray-600 flex items-center gap-2';
          bcRow.innerHTML = `–®—Ç—Ä–∏—Ö–∫–æ–¥: ${p.barcode||'‚Äî'} ${p.barcode? `<button data-copy="${p.barcode}" class="border px-2 py-1 rounded text-xs">üìã</button>`:''}`;
          wrap.appendChild(bcRow);

          // Description
          const desc = document.createElement('div');
          desc.className = 'text-sm text-gray-700';
          desc.innerHTML = `<div class="text-xs text-gray-500 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</div><div>${(p.description && String(p.description).trim()) ? String(p.description) : '<span class="text-gray-400">‚Äî</span>'}</div>`;
          wrap.appendChild(desc);

          const price = document.createElement('div');
          price.innerHTML = priceBlock(p);
          wrap.appendChild(price);

          if (inPromo){
            const note = document.createElement('div');
            note.className = 'text-xs text-red-600';
            note.textContent = '–¢–æ–≤–∞—Ä —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –∞–∫—Ü–∏–∏ ‚Äî –≤–æ–∑–º–æ–∂–Ω–∞ —Å–∫–∏–¥–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —É—Å–ª–æ–≤–∏–π';
            wrap.appendChild(note);
          }

          const controls = document.createElement('div');
          controls.innerHTML = qtyControls(p);
          wrap.appendChild(controls);

          cont.appendChild(wrap);

          const okPromise = Utils.showModal('–¢–æ–≤–∞—Ä', cont, [{label:'–ó–∞–∫—Ä—ã—Ç—å', value:false}], { variant:'product' });
          cont.addEventListener('click', (e)=>{
            const btn=e.target.closest('[data-act]');
            if(btn){
              const act=btn.getAttribute('data-act');
              if (act==='add'){ addToCart(p); controls.innerHTML=qtyControls(p); }
              if (act==='inc'){ addToCart(p, + (p.shipmentQuantum||1)); controls.innerHTML=qtyControls(p); }
              if (act==='dec'){ addToCart(p, - (p.shipmentQuantum||1)); controls.innerHTML=qtyControls(p); }
            }
            const cpy=e.target.closest('button[data-copy]');
            if (cpy){ Utils.copyToClipboard(cpy.getAttribute('data-copy')); }
          });
          return okPromise;
        }

        // Promo cards rendering (new UX)
        function renderPromoCards(){
          // Defensive: ensure state and promo containers exist
          if (!state || typeof state !== 'object') return;
          const wrap = document.getElementById('promoCardsWrap');
          const track = document.getElementById('promoCardsTrack');
          const prevBtn = document.getElementById('promoPrev');
          const nextBtn = document.getElementById('promoNext');
          // Guard: if promo container doesn't exist (e.g., when navigating quickly), skip safely
          if (!wrap || !track){ return; }
          if (!state.activePromos.length){ wrap.classList.add('hidden'); return; }
          wrap.classList.remove('hidden'); track.innerHTML='';

          // Pastel gentle palette for cards
          const pastel = [
            'from-sky-50 to-white',
            'from-rose-50 to-white',
            'from-emerald-50 to-white',
            'from-violet-50 to-white',
            'from-amber-50 to-white',
            'from-cyan-50 to-white'
          ];

          // Build cards (max 4 visible per slide width)
          const cards = state.activePromos.map((p,idx)=>{
            const card=document.createElement('div');
            const tone = pastel[idx % pastel.length];
            card.className=`promo-card rounded-lg border shadow-sm p-3 w-[calc(25%-8px)] min-w-[220px] bg-gradient-to-br ${tone}`;
            const cover = p.coverUrl ? `<div class="promo-cover w-full overflow-hidden mb-2 rounded-md"><img src="${p.coverUrl}" alt="${Utils.escapeXml?.(p.name)||''}" class="w-full h-full object-cover"></div>` : '';
            const title = Utils.escapeXml ? Utils.escapeXml(p.name||'–°–ø–µ—Ü–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ') : (p.name||'–°–ø–µ—Ü–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ');
            // Read human condition/notes from multiple possible fields, including Russian column
            const condRaw = (p.condition ?? p.conditions ?? p['–£—Å–ª–æ–≤–∏—è'] ?? p['—É—Å–ª–æ–≤–∏—è'] ?? p.cond ?? p.rule ?? '').toString().trim();
            const tooltipText = condRaw ? `–£—Å–ª–æ–≤–∏—è –∞–∫—Ü–∏–∏: ${condRaw}` : '';
            card.innerHTML = `
              ${cover}
              <div class="text-sm font-semibold mb-1 truncate" title="${title}">${title}</div>
              <div class="promo-footer">
                <span class="badge bg-rose-100 text-rose-700 border border-rose-200" title="${Utils.escapeXml?.(tooltipText)||''}">–ê–ö–¶–ò–Ø</span>
                <button class="buyPromoBtn border px-2 py-1 rounded-md text-xs hover:bg-slate-50">–ö—É–ø–∏—Ç—å</button>
              </div>
            `;
            // Show tooltip on whole card (native title)
            if (tooltipText){ card.title = tooltipText; }
            card.querySelector('.buyPromoBtn').addEventListener('click', ()=>{
              state.promoFilterSkus = (p.items||[]).map(i=> String(i.barcode||i.sku||'').trim()).filter(Boolean);
              applyFilters();
              Utils.showToast('–ü–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–≤–∞—Ä—ã –∞–∫—Ü–∏–∏', 'info');
            });
            return card;
          });

          // For seamless manual carousel effect, clone head/tail once
          const perView = 4;
          const clonesHead = cards.slice(0, perView).map(c=> c.cloneNode(true));
          const clonesTail = cards.slice(-perView).map(c=> c.cloneNode(true));
          clonesTail.forEach(c=> track.appendChild(c));
          cards.forEach(c=> track.appendChild(c));
          clonesHead.forEach(c=> track.appendChild(c));

          let index = perView; // start at the real first slide

          function update(noAnim=false){
            track.style.transition = noAnim ? 'none' : 'transform .3s ease';
            const width = track.parentElement.clientWidth;
            const offset = (index - perView) * width;
            track.style.transform = `translateX(-${offset}px)`;
          }

          function normalize(){
            const total = cards.length;
            if (index >= total + perView){ index = perView; update(true); }
            if (index < perView){ index = total + perView - 1; update(true); }
          }

          prevBtn.onclick = ()=>{ index--; update(); setTimeout(normalize, 320); };
          nextBtn.onclick = ()=>{ index++; update(); setTimeout(normalize, 320); };

          // Remove any previous auto-rotation
          if (state.promoTimer){ clearInterval(state.promoTimer); state.promoTimer=null; }

          // Hide controls if few
          prevBtn.style.visibility = (cards.length>perView)?'visible':'hidden';
          nextBtn.style.visibility = (cards.length>perView)?'visible':'hidden';

          // Hide the whole block on catalog scroll (when user scrolls product list)
          const listEl = document.getElementById('catGrid');
          let hiddenOnScroll=false;
          if (listEl && wrap){
            listEl.addEventListener('scroll', ()=>{
              if (hiddenOnScroll) return; wrap.style.display='none'; hiddenOnScroll=true; 
            });
          }

          // initial position
          setTimeout(()=>update(true), 0);
        }

        // Events
        catSearch.value = state.search; catSearch.addEventListener('input', Utils.debounce(()=>{ state.search=catSearch.value; applyFilters(); }, 300));
        viewGridBtn.addEventListener('click', ()=>{ state.view='grid'; applyFilters(); });
        viewTableBtn.addEventListener('click', ()=>{ state.view='table'; applyFilters(); });

        // Render promo cards block (replacing old carousel)
        try { renderPromoCards(); } catch(e){ console.warn('renderPromoCards error', e); }

        // Infinite toggle
        try {
          if (catInfinite){
            catInfinite.checked = !!state.infinite;
            catInfinite.addEventListener('change', ()=>{
              state.infinite = !!catInfinite.checked;
              localStorage.setItem('bts_cat_infinite', state.infinite ? '1' : '0');
              state.page = 0;
              renderList();
              updateStats();
            });
          }
        } catch(_){ }

        // Filters sidebar toggle (hidden by default)
        try {
          const layoutEl = document.getElementById('catLayout');
          const toggleFiltersBtn = document.getElementById('toggleFiltersBtn');
          const saved = localStorage.getItem('bts_cat_filters_open');
          if (layoutEl){
            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ñ–∏–ª—å—Ç—Ä—ã –≤–∏–¥–∏–º—ã. –°–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ –≤—ã–∫–ª—é—á–∏–ª.
            const open = saved !== '0';
            layoutEl.classList.toggle('filters-hidden', !open);
          }
          toggleFiltersBtn?.addEventListener('click', ()=>{
            if (!layoutEl) return;
            const willOpen = layoutEl.classList.contains('filters-hidden');
            layoutEl.classList.toggle('filters-hidden', !willOpen);
            localStorage.setItem('bts_cat_filters_open', willOpen ? '1' : '0');
          });
        } catch(_){ }
        topSkuBtn.addEventListener('click', ()=>{ state.topOnly=!state.topOnly; topSkuBtn.classList.toggle('bg-indigo-600'); topSkuBtn.classList.toggle('text-white'); applyFilters(); });
        resetFiltersBtn.addEventListener('click', ()=>{
          state.search='';
          catSearch.value='';
          state.topOnly=false;
          state.filters={ vendor:new Set(), manufacturer:new Set(), category:new Set(), subcategory:new Set() };
          state.promoFilterSkus=null;
          // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
          try { recomputeFilterOptions(); } catch(_){ }
          applyFilters();
        });
        sortBtn.addEventListener('click', (e)=>{ e.stopPropagation(); sortMenu.classList.toggle('hidden'); });
        document.addEventListener('click', (e)=>{ if (!sortMenu.contains(e.target) && e.target!==sortBtn) sortMenu.classList.add('hidden'); });
        sortMenu.addEventListener('click', (e)=>{ const a=e.target.closest('a[data-sort]'); if(!a) return; e.preventDefault(); state.sort=a.getAttribute('data-sort'); sortMenu.classList.add('hidden'); applySort(); state.page=0; renderList(); updateStats(); });
        loadMoreBtn.addEventListener('click', ()=>{ if (state.infinite) return; state.page++; renderList(); });

        cartOpenBtn.addEventListener('click', ()=> showCart(true));
        cartCloseBtn.addEventListener('click', ()=> showCart(false));
        cartOverlay.addEventListener('click', ()=> showCart(false));
        cartBody.addEventListener('click', (e)=>{
          const btn=e.target.closest('[data-act]'); if(!btn) return; const sku=btn.getAttribute('data-sku'); const item=state.cart.find(i=>i.sku===sku); if(!item) return;
          const p=state.items.find(x=>x.sku===sku) || { shipmentQuantum:1 };
          if (btn.dataset.act==='inc'){ item.qty += Number(p.shipmentQuantum||1)||1; }
          if (btn.dataset.act==='dec'){ item.qty = Math.max(0, item.qty - (Number(p.shipmentQuantum||1)||1)); if (item.qty===0) state.cart = state.cart.filter(i=>i.sku!==sku); }
          if (btn.dataset.act==='rm'){ state.cart = state.cart.filter(i=>i.sku!==sku); }
          saveCart(); renderCart();
        });
        cartBody.addEventListener('change', (e)=>{ const inp=e.target.closest('input[data-act="qty"]'); if (!inp) return; const sku=inp.getAttribute('data-sku'); const item=state.cart.find(i=>i.sku===sku); if(!item) return; const qty=Math.max(0, Number(inp.value||0)); item.qty=qty; if (qty===0) state.cart=state.cart.filter(i=>i.sku!==sku); saveCart(); renderCart(); });
        cartClearBtn.addEventListener('click', async ()=>{ const ok=await Utils.showModal('–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É', '–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏?', [ {label:'–û—Ç–º–µ–Ω–∞', value:false, class:'border px-3 py-1.5 rounded-lg hover:bg-gray-50'}, {label:'–û—á–∏—Å—Ç–∏—Ç—å', value:true, class:'bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg'} ]); if (ok){ state.cart=[]; saveCart(); renderCart(); }});
        cartExportBtn.addEventListener('click', async ()=>{
          // –≠–∫—Å–ø–æ—Ä—Ç –∫–æ—Ä–∑–∏–Ω—ã –≤ Excel: .xlsx (–µ—Å–ª–∏ XLSX –¥–æ—Å—Ç—É–ø–µ–Ω) –∏–ª–∏ fallback .xls (SpreadsheetML)
          try {
            recomputeDiscounts();
            const headers = ['–ê—Ä—Ç–∏–∫—É–ª','–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ','–¶–µ–Ω–∞','–ö–æ–ª-–≤–æ','–°—É–º–º–∞','–°–∫–∏–¥–∫–∞','–ò—Ç–æ–≥–æ','–ê–∫—Ü–∏—è'];
            const rows = state.cart.map(i=>{
              const sub = (Number(i.price||0) * Number(i.qty||0));
              const disc = Math.round(Number(i._discountAmount||0));
              const tot = Math.max(0, sub - disc);
              return [i.sku, i.name, i.price, i.qty, sub, disc, tot, i._promoApplied||''];
            });

            const ok = await (typeof XLSXLoader !== 'undefined' ? XLSXLoader.ensure().catch(()=>false) : Promise.resolve(typeof XLSX !== 'undefined'));
            if (ok && window.XLSX?.utils){
              const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
              const wb = XLSX.utils.book_new();
              XLSX.utils.book_append_sheet(wb, ws, '–ö–æ—Ä–∑–∏–Ω–∞');
              Utils.saveWorkbookXLSX(wb, 'cart.xlsx');
              return;
            }

            // Fallback: Excel-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π .xls (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ Microsoft Excel)
            const xml = Utils.buildExcelXmlTable(headers, rows, '–ö–æ—Ä–∑–∏–Ω–∞');
            Utils.downloadFile('cart.xls', xml, 'application/vnd.ms-excel');
            Utils.showToast('XLSX –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —Å–∫–∞—á–∞–Ω Excel .xls (—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç)', 'warning');
          } catch(e){
            console.error('cartExportBtn error', e);
            Utils.showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å Excel', 'error');
          }
        });
        cartCheckoutBtn.addEventListener('click', async ()=>{
          // Build checkout modal (top-to-bottom) ‚Äî according to new requirements
          const div=document.createElement('div');
          // –î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞ (—Å–µ–≥–æ–¥–Ω—è + 2 –¥–Ω—è)
          const defDelivery = (()=>{
            const base = new Date();
            base.setHours(0,0,0,0);
            const d = (globalThis.Scheduler && typeof Scheduler.addDays === 'function') ? Scheduler.addDays(base, 2) : new Date(base.getTime() + 2*86400000);
            if (globalThis.Scheduler && typeof Scheduler.toISODate === 'function') return Scheduler.toISODate(d);
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth()+1).padStart(2,'0');
            const dd = String(d.getDate()).padStart(2,'0');
            return `${yyyy}-${mm}-${dd}`;
          })();

          div.innerHTML = `
            <div class="space-y-3">
              <div>
                <label class="block text-sm mb-1">–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                <input id="chkDeliveryDate" type="date" class="w-full border rounded-lg px-3 py-2" value="${defDelivery}" />
                <div class="text-xs text-gray-500 mt-1">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: –ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞ (—Å–µ–≥–æ–¥–Ω—è + 2 –¥–Ω—è)</div>
              </div>

              <div>
                <label class="block text-sm mb-1">–ö–ª–∏–µ–Ω—Ç (–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ + –ò–ù–ù)</label>
                <input id="chkClient" class="w-full border rounded-lg px-3 py-2" placeholder="–ü–æ–∏—Å–∫: –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ + –ò–ù–ù" />
                <div id="chkClientList" class="border rounded-lg mt-1 max-h-44 overflow-auto hidden"></div>
                <div class="text-xs text-gray-500 mt-1">–ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –∫–ª–∏–µ–Ω—Ç ‚Äî –Ω–∏–∂–µ –±—É–¥–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏ —ç—Ç–æ–≥–æ –ò–ù–ù.</div>
              </div>

              <div>
                <label class="block text-sm mb-1">–¢–æ—á–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ (–ö–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞ + –ê–¥—Ä–µ—Å)</label>
                <input id="chkOutletSearch" class="w-full border rounded-lg px-3 py-2" placeholder="–ü–æ–∏—Å–∫: –∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ –∞–¥—Ä–µ—Å" />
                <div id="chkOutletList" class="border rounded-lg mt-1 max-h-44 overflow-auto hidden"></div>
                <div class="text-xs text-gray-500 mt-1">–ï—Å–ª–∏ –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É –∑–¥–µ—Å—å ‚Äî –∫–ª–∏–µ–Ω—Ç (–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ + –ò–ù–ù) –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <div>
                  <label class="block text-sm mb-1">–ò–ù–ù</label>
                  <input id="chkInn" class="w-full border rounded-lg px-3 py-2 bg-gray-50" readonly />
                </div>
                <div>
                  <label class="block text-sm mb-1">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                  <input id="chkAddress" class="w-full border rounded-lg px-3 py-2 bg-gray-50" readonly />
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <div>
                  <label class="block text-sm mb-1">–§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã</label>
                  <select id="chkPayment" class="w-full border rounded-lg px-3 py-2">
                    <option>–ù–∞–ª–∏—á–Ω—ã–µ –ø–æ —Ñ–∞–∫—Ç—É</option>
                    <option>–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</option>
                    <option>–ë–∞–Ω–∫ 7 –¥–Ω–µ–π</option>
                    <option>–ë–∞–Ω–∫ 14 –¥–Ω–µ–π</option>
                    <option>–ë–∞–Ω–∫ 21 –¥–µ–Ω—å</option>
                    <option>–ë–∞–Ω–∫ 28 –¥–Ω–µ–π</option>
                  </select>
                  <div class="text-xs text-gray-500 mt-1">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ—á–∫–∏.</div>
                </div>
                <div>
                  <label class="block text-sm mb-1">–ö—Ä–µ–¥–∏—Ç–Ω—ã–π –ª–∏–º–∏—Ç</label>
                  <input id="chkCreditLimit" class="w-full border rounded-lg px-3 py-2 bg-gray-50" readonly />
                </div>
              </div>

              <div>
                <label class="block text-sm mb-1">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <textarea id="chkComment" rows="2" class="w-full border rounded-lg px-3 py-2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¥–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ 10:00, –ø–æ–∑–≤–æ–Ω–∏—Ç—å –∑–∞—Ä–∞–Ω–µ–µ"></textarea>
              </div>
            </div>`;

          const okPromise = Utils.showModal('–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞', div, [
            {label:'–û—Ç–º–µ–Ω–∞', value:false, class:'border px-3 py-1.5 rounded-lg hover:bg-gray-50'},
            {label:'‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å', value:true, class:'bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg'}
          ]);

          // preload from visit context if any
          const visitCtx = window.currentVisitContext || {};
          const outlets = await Storage.getAll('outlets');

          const clientInp = div.querySelector('#chkClient');
          const clientList = div.querySelector('#chkClientList');
          const outletInp = div.querySelector('#chkOutletSearch');
          const outletList = div.querySelector('#chkOutletList');

          const innEl = div.querySelector('#chkInn');
          const addrEl = div.querySelector('#chkAddress');
          const creditEl = div.querySelector('#chkCreditLimit');
          const payEl = div.querySelector('#chkPayment');

          // State inside modal
          let selectedInn = '';
          let selectedOutletCode = '';

          // Build unique clients by INN (one INN can have multiple outlets)
          const clientsByInn = new Map();
          for (const o of (outlets||[])){
            const inn = String(o.inn||'').trim();
            if (!inn) continue;
            if (!clientsByInn.has(inn)) clientsByInn.set(inn, { inn, name: o.name||'', outlets: [] });
            clientsByInn.get(inn).outlets.push(o);
          }
          const allClients = Array.from(clientsByInn.values());

          function formatClientLabel(name, inn){
            const nm = String(name||'–ö–ª–∏–µ–Ω—Ç').trim() || '–ö–ª–∏–µ–Ω—Ç';
            const i = String(inn||'').trim();
            return i ? `${nm} (${i})` : nm;
          }

          function setPaymentFromOutlet(outletObj){
            const pt = String(outletObj?.paymentTerms||'').trim();
            if (!pt) return;
            const opt = Array.from(payEl.options).find(o=>String(o.value||o.textContent).trim()===pt);
            if (opt) payEl.value = opt.value;
          }

          function setOutlet(code){
            const outletObj = (outlets||[]).find(o=>String(o.code)===String(code)) || null;
            if (!outletObj) return;
            selectedOutletCode = outletObj.code;
            selectedInn = String(outletObj.inn||'').trim();

            // Fill top client combo
            clientInp.value = formatClientLabel(outletObj.name, selectedInn);

            // Fill outlet field
            outletInp.value = `${outletObj.code}${outletObj.address? ' ‚Äî '+outletObj.address:''}`;

            // Fill details
            innEl.value = selectedInn;
            addrEl.value = outletObj.address || '';
            const cl = outletObj.creditLimit;
            creditEl.value = (cl !== undefined && cl !== null && String(cl).trim() !== '') ? Utils.formatCurrency(cl) : '';

            // Payment default
            setPaymentFromOutlet(outletObj);

            // Show outlets of the same client
            renderOutletList('');
          }

          function applyClientInn(inn, name){
            selectedInn = String(inn||'').trim();
            clientInp.value = formatClientLabel(name, selectedInn);
            // Show list of outlets for this INN
            renderOutletList('');
          }

          function renderClientList(q){
            const qq = String(q||'').toLowerCase().trim();
            clientList.innerHTML='';
            if (!qq){
              clientList.classList.add('hidden');
              return;
            }
            const found = allClients.filter(c=> (c.name||'').toLowerCase().includes(qq) || String(c.inn||'').includes(qq));
            found.slice(0,25).forEach(c=>{
              const a=document.createElement('a');
              a.href='#';
              a.className='block px-3 py-2 hover:bg-gray-50 text-sm';
              a.textContent = formatClientLabel(c.name, c.inn);
              a.addEventListener('click', (e)=>{
                e.preventDefault();
                clientList.classList.add('hidden');
                applyClientInn(c.inn, c.name);
              });
              clientList.appendChild(a);
            });
            clientList.classList.toggle('hidden', found.length===0);
          }

          function renderOutletList(q){
            const qq = String(q||'').toLowerCase().trim();
            outletList.innerHTML='';

            // If client not selected and query empty ‚Äî don't show huge list
            if (!selectedInn && !qq){
              outletList.classList.add('hidden');
              return;
            }

            const pool = selectedInn
              ? (outlets||[]).filter(o=>String(o.inn||'').trim()===selectedInn)
              : (outlets||[]);

            const found = pool.filter(o=>{
              if (!qq) return true;
              const hay = [o.code, o.address, o.name, o.inn].map(x=>String(x||'').toLowerCase()).join(' ');
              return hay.includes(qq);
            }).slice(0, 50);

            found.forEach(o=>{
              const a=document.createElement('a');
              a.href='#';
              a.className='block px-3 py-2 hover:bg-gray-50 text-sm';
              a.textContent = `${o.code}${o.address? ' ‚Äî '+o.address:''}`;
              a.addEventListener('click', (e)=>{
                e.preventDefault();
                outletList.classList.add('hidden');
                setOutlet(o.code);
              });
              outletList.appendChild(a);
            });

            outletList.classList.toggle('hidden', found.length===0);
          }

          // --- Prefill from visit context (Televisits -> Catalog) ---
          try {
            if (visitCtx.outletCode){
              setOutlet(String(visitCtx.outletCode));
            } else {
              if (visitCtx.inn){
                const name = visitCtx.clientName || (allClients.find(c=>String(c.inn)===String(visitCtx.inn))?.name) || '';
                applyClientInn(String(visitCtx.inn), name);
              }
            }
          } catch(_){ }

          // Events
          clientInp.addEventListener('input', Utils.debounce(()=>{
            const val = clientInp.value;
            // If user clears client ‚Äî reset selectedInn and outlet fields
            if (!String(val||'').trim()){
              selectedInn = '';
              selectedOutletCode = '';
              innEl.value = '';
              addrEl.value = '';
              creditEl.value = '';
              outletInp.value = '';
              outletList.classList.add('hidden');
              renderClientList('');
              return;
            }
            renderClientList(val);
          }, 200));

          outletInp.addEventListener('input', Utils.debounce(()=>{
            renderOutletList(outletInp.value);
          }, 150));

          // Open lists on focus
          clientInp.addEventListener('focus', ()=>{ if (clientInp.value.trim()) renderClientList(clientInp.value); });
          outletInp.addEventListener('focus', ()=>{ renderOutletList(outletInp.value); });

          // If selectedInn exists, show outlets list immediately (requirement #1)
          if (selectedInn){
            renderOutletList('');
          }

          const ok = await okPromise;
          if (!ok) return;

          if (!selectedOutletCode){
            Utils.showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –¥–æ—Å—Ç–∞–≤–∫–∏', 'warning');
            return;
          }

          // Save order
          recomputeDiscounts();
          const id = genOrderId();
          const totals = cartTotal();
          const outletCode = selectedOutletCode;
          const outletObj = (await Storage.get('outlets', outletCode))||{};

          const itemsWithBarcode = (state.cart||[]).map(it=>{
            const p = (state.items||[]).find(x=>x.sku===it.sku) || {};
            // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∑–∞–∫–∞–∑ –∏–º–µ–Ω–Ω–æ –ø–æ–ª–µ "barcode" (–®—Ç—Ä–∏—Ö–∫–æ–¥) –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏
            return {
              ...it,
              barcode: String(it.barcode || p.barcode || '')
            };
          });

          const order = {
            id,
            date: Date.now(),
            // –î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ (YYYY-MM-DD)
            deliveryDate: (div.querySelector('#chkDeliveryDate')?.value || '') || null,
            items: itemsWithBarcode,
            total: totals.total,
            operator: (Storage.getSession()?.email||''),
            outlet: outletCode,
            outletDetails: {
              code: outletObj.code||outletCode,
              name: outletObj.name||'',
              inn: outletObj.inn||'',
              address: outletObj.address||'',
              paymentTerms: outletObj.paymentTerms||'',
              creditLimit: outletObj.creditLimit ?? ''
            },
            payment: div.querySelector('#chkPayment')?.value||'',
            comment: (div.querySelector('#chkComment')?.value||'').trim(),
            clientText: (div.querySelector('#chkClient')?.value||'').trim()
          };

          await Storage.put('orders', order);
          try {
            await window.Notifications?.createNotification?.({
              type: window.Notifications?.NOTIFICATION_TYPES?.ORDER_CREATED || 'order_created',
              title: '–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω',
              message: `–ó–∞–∫–∞–∑ ${id} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω`,
              actionUrl: 'orders',
              data: { orderId: id }
            });
          } catch(_){ }

          state.cart=[];
          saveCart();
          renderCart();
          showCart(false);
          Utils.showToast(`–ó–∞–∫–∞–∑ ${id} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω`, 'success');

          // finish active visit via VisitManager if any
          if (VisitManager.isActive()) { await VisitManager.promptFinish(); }
        });

        function genOrderId(){
          const d=new Date(); const num=Math.floor(Math.random()*9000)+1000; const yyyy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `ORD-${yyyy}${mm}${dd}-${num}`;
        }

        // Init
        try { setupImageObserver(); } catch(_){ }
        // Render promo cards block (safe)
        try { renderPromoCards(); } catch(e){ console.warn('renderPromoCards error', e); }
        updateCartUI();
        applyFilters();
      }

      async function orders(){
        const listEl = document.getElementById('ordList');
        const searchInp = document.getElementById('ordSearch');
        const exportAllBtn = document.getElementById('ordExportAll');
        const deleteAllBtn = document.getElementById('ordDeleteAll');

        // Best-effort: warm up XLSX in background (don‚Äôt block UI, don‚Äôt show toasts here)
        try { XLSXLoader?.ensure?.().catch(()=>{}); } catch(_){ }

        // Auto purge orders older than 3 days
        const now = Date.now();
        const all = await Storage.getAll('orders');
        const threeDays = 3*24*60*60*1000;
        let removed = 0;
        for (const o of all){
          if ((now - (o.date||0)) > threeDays){
            await Storage.del('orders', o.id);
            removed++;
          }
        }
        if (removed>0) Utils.showToast(`–£–¥–∞–ª–µ–Ω–æ ${removed} —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–∫–∞–∑–æ–≤`, 'info');

        // --- Backfill barcodes for old orders (if items[] were created before barcode support)
        try {
          const prods = await Storage.getAll('products').catch(()=>[]);
          const bySku = new Map((prods||[]).map(p=>[String(p.sku||''), String(p.barcode||'').trim()]));
          const ordersNow = await Storage.getAll('orders').catch(()=>[]);
          for (const o of (ordersNow||[])){
            let touched = false;
            const items = (o.items||[]).map(it=>{
              const bc = String(it?.barcode ?? '').trim();
              if (bc) return it;
              const mapped = bySku.get(String(it?.sku||'')) || '';
              if (mapped){ touched = true; return { ...it, barcode: mapped }; }
              return it;
            });
            if (touched){
              await Storage.put('orders', { ...o, items });
            }
          }
        } catch(_){ }

        /** @type {Array<any>} */
        let ordersCache = [];

        async function loadOrdersCache(){
          const orders = await Storage.getAll('orders').catch(()=>[]);
          orders.sort((a,b)=> (b.date||0)-(a.date||0));
          ordersCache = orders;
        }

        function viewOrder(o){
          const outlet = o.outletDetails || {};
          const c=document.createElement('div');
          const rows = (o.items||[]).map((it,idx)=>`<tr><td class="py-1 pr-2">${idx+1}</td><td class="py-1 pr-2">${it.sku}</td><td class="py-1 pr-2">${it.barcode||''}</td><td class="py-1 pr-2">${it.name}</td><td class="py-1 pr-2">${it.price}</td><td class="py-1 pr-2">${it.qty}</td><td class="py-1 pr-2">${(Number(it.price||0)*Number(it.qty||0))}</td></tr>`).join('')||'';
          c.innerHTML = `
            <div class="space-y-2 text-sm">
              <div><b>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</b> ${o.id}</div>
              <div><b>–î–∞—Ç–∞:</b> ${Utils.formatDate(o.date)}</div>
              <div><b>–ö–ª–∏–µ–Ω—Ç:</b> ${outlet.name||'‚Äî'}</div>
              <div><b>–ö–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞:</b> ${outlet.code||o.outlet||'‚Äî'}</div>
              <div><b>–ò–ù–ù:</b> ${outlet.inn||'‚Äî'}</div>
              <div><b>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:</b> ${outlet.address||'‚Äî'}</div>
              <div><b>–§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã:</b> ${o.payment||outlet.paymentTerms||'‚Äî'}</div>
              ${o.deliveryDate ? `<div><b>–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏:</b> ${o.deliveryDate}</div>`:''}
              <div class="border-t my-2"></div>
              <div class="overflow-auto">
                <table class="w-full text-sm"><thead><tr class="text-left text-gray-500"><th class="py-1 pr-2">‚Ññ</th><th class="py-1 pr-2">–ê—Ä—Ç–∏–∫—É–ª</th><th class="py-1 pr-2">–®—Ç—Ä–∏—Ö–∫–æ–¥</th><th class="py-1 pr-2">–ù–∞–∑–≤–∞–Ω–∏–µ</th><th class="py-1 pr-2">–¶–µ–Ω–∞</th><th class="py-1 pr-2">–ö–æ–ª-–≤–æ</th><th class="py-1 pr-2">–°—É–º–º–∞</th></tr></thead><tbody>${rows}</tbody></table>
              </div>
              <div class="text-right font-medium">–ò—Ç–æ–≥–æ: ${Utils.formatCurrency(o.total||0)}</div>
            </div>`;
          Utils.showModal('–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–∫–∞–∑–∞', c, [{label:'–ó–∞–∫—Ä—ã—Ç—å', value:false}]);
        }

        /**
         * –≠–∫—Å–ø–æ—Ä—Ç –æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞.
         * –í–∞–∂–Ω–æ: —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å user-gesture friendly (–±–µ–∑ await –ø–µ—Ä–µ–¥ download).
         */
        function exportOrderExcel(o){
          const outlet = o.outletDetails || {};

          // Prefer .xlsx when XLSX is available
          if (XLSXLoader?.isReady?.() && window.XLSX?.utils){
            const ws1 = XLSX.utils.aoa_to_sheet([
              ['–ü–æ–ª–µ','–ó–Ω–∞—á–µ–Ω–∏–µ'],
              ['–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞', o.id],
              ['–î–∞—Ç–∞', Utils.formatDate(o.date)],
              ['–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏', o.deliveryDate||''],
              ['–ö–ª–∏–µ–Ω—Ç', outlet.name||''],
              ['–ö–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞', outlet.code||o.outlet||''],
              ['–ò–ù–ù', outlet.inn||''],
              ['–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏', outlet.address||''],
              ['–§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã', o.payment||outlet.paymentTerms||'']
            ]);
            const ws2 = XLSX.utils.aoa_to_sheet([
              ['‚Ññ','–ê—Ä—Ç–∏–∫—É–ª','–®—Ç—Ä–∏—Ö–∫–æ–¥','–ù–∞–∑–≤–∞–Ω–∏–µ','–¶–µ–Ω–∞','–ö–æ–ª-–≤–æ','–°—É–º–º–∞'],
              ... (o.items||[]).map((it,idx)=>[idx+1, it.sku, it.barcode||'', it.name, it.price, it.qty, (Number(it.price||0)*Number(it.qty||0))])
            ]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws1, '–ó–∞–≥–æ–ª–æ–≤–æ–∫');
            XLSX.utils.book_append_sheet(wb, ws2, '–¢–æ–≤–∞—Ä—ã');
            Utils.saveWorkbookXLSX(wb, `order_${o.id}.xlsx`);
            try { window.ActivityLog?.logActivity?.(window.ActivityLog.LOG_ACTIONS.ORDER_EXPORTED, 'orders', o.id, { type:'single' }); } catch(_){ }
            return;
          }

          // Fallback: Excel-compatible .xls (SpreadsheetML 2003)
          // One sheet: first rows contain header fields, then an empty row, then item table.
          const sheetRows = [
            ['–ü–æ–ª–µ','–ó–Ω–∞—á–µ–Ω–∏–µ'],
            ['–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞', o.id],
            ['–î–∞—Ç–∞', Utils.formatDate(o.date)],
            ['–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏', o.deliveryDate||''],
            ['–ö–ª–∏–µ–Ω—Ç', outlet.name||''],
            ['–ö–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞', outlet.code||o.outlet||''],
            ['–ò–ù–ù', outlet.inn||''],
            ['–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏', outlet.address||''],
            ['–§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã', o.payment||outlet.paymentTerms||''],
            ['',''],
            ['‚Ññ','–ê—Ä—Ç–∏–∫—É–ª','–®—Ç—Ä–∏—Ö–∫–æ–¥','–ù–∞–∑–≤–∞–Ω–∏–µ','–¶–µ–Ω–∞','–ö–æ–ª-–≤–æ','–°—É–º–º–∞'],
            ... (o.items||[]).map((it,idx)=>[
              String(idx+1),
              String(it.sku||''),
              String(it.barcode||''),
              String(it.name||''),
              String(it.price||''),
              String(it.qty||''),
              String((Number(it.price||0)*Number(it.qty||0)))
            ])
          ];
          // SpreadsheetML expects a single header row; we can just use a generic header and keep rest as rows.
          const xml = Utils.buildExcelXmlTable(sheetRows[0], sheetRows.slice(1), '–ó–∞–∫–∞–∑');
          Utils.downloadFile(`order_${o.id}.xls`, xml, 'application/vnd.ms-excel');
          Utils.showToast('XLSX –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —Å–∫–∞—á–∞–Ω Excel .xls (—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç)', 'warning');
        }

        async function deleteOrder(o){
          const ok = await Utils.showModal('–£–¥–∞–ª–µ–Ω–∏–µ', `–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑ ${o.id}?`, [
            {label:'–û—Ç–º–µ–Ω–∞', value:false, class:'border px-3 py-1.5 rounded-lg hover:bg-gray-50'},
            {label:'–£–¥–∞–ª–∏—Ç—å', value:true, class:'bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg'}
          ]);
          if (!ok) return;
          await Storage.del('orders', o.id);
          try { await window.ActivityLog?.logActivity?.(window.ActivityLog.LOG_ACTIONS.ORDER_DELETED, 'orders', o.id, {}); } catch(_){ }
          Utils.showToast('–ó–∞–∫–∞–∑ —É–¥–∞–ª–µ–Ω', 'info');
          await loadOrdersCache();
          await render();
        }

        function renderCard(o){
          const div=document.createElement('div');
          div.className='bg-white border rounded-xl p-4 shadow-sm';
          const outlet = o.outletDetails || {};
          div.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="font-medium">üìã –ó–∞–∫–∞–∑ #${o.id}</div>
              <div class="text-sm text-gray-500">${Utils.formatDate(o.date)}</div>
            </div>
            <div class="mt-2 text-sm">
              <div class="font-medium truncate">üè™ ${outlet.name||'‚Äî'}</div>
              <div>–ö–æ–¥: ${outlet.code||o.outlet||'‚Äî'} ‚îÇ –ò–ù–ù: ${outlet.inn||'‚Äî'}</div>
              <div class="truncate">üìç ${outlet.address||'‚Äî'}</div>
              <div>üí≥ ${o.payment||outlet.paymentTerms||'‚Äî'}</div>
              ${o.deliveryDate ? `<div class="text-gray-500 text-xs mt-1">üöö –î–æ—Å—Ç–∞–≤–∫–∞: <b>${o.deliveryDate}</b></div>`:''}
            </div>
            <div class="my-2 border-t"></div>
            <div class="text-sm">–ü–æ–∑–∏—Ü–∏–π: ${o.items?.length||0} ‚îÇ –°—É–º–º–∞: ${Utils.formatCurrency(o.total||0)}</div>
            <div class="mt-2 flex items-center gap-2 flex-wrap">
              <button data-act="view" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä</button>
              <button data-act="excel" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üì• Excel</button>
              <button data-act="print" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50"><i class="bi bi-printer"></i> –ü–µ—á–∞—Ç—å</button>
              <button data-act="del" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50 text-red-600">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>`;

          // Important: keep this handler synchronous for Excel downloads (user gesture)
          div.addEventListener('click', (e)=>{
            const btn=e.target.closest('button[data-act]');
            if(!btn) return;
            const act=btn.dataset.act;
            if (act==='view') return viewOrder(o);
            if (act==='excel') return exportOrderExcel(o);
            if (act==='print') {
              try { window.Print?.printOrder?.(o.id); } catch(_){ }
              return;
            }
            if (act==='del') {
              deleteOrder(o);
              return;
            }
          });
          return div;
        }

        async function render(){
          const q = String(searchInp.value||'').toLowerCase().trim();
          const filtered = (ordersCache||[]).filter(o=>{
            if(!q) return true;
            const outlet=o.outletDetails||{};
            const hay=[o.id, outlet.name, outlet.code, outlet.inn, outlet.address].map(x=>String(x||'').toLowerCase()).join(' ');
            return hay.includes(q);
          });
          listEl.innerHTML='';
          filtered.forEach(o=> listEl.appendChild(renderCard(o)) );
        }

        // Initial load
        await loadOrdersCache();
        await render();

        searchInp.addEventListener('input', Utils.debounce(render, 200));

        // Export ALL (sync click handler for user-gesture)
        exportAllBtn.addEventListener('click', ()=>{
          const orders = (ordersCache||[]).slice().reverse(); // older -> newer for file
          if (!orders.length){
            Utils.showToast('–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏', 'warning');
            return;
          }

          if (XLSXLoader?.isReady?.() && window.XLSX?.utils){
            const wb = XLSX.utils.book_new();
            orders.forEach((o,idx)=>{
              const outlet = o.outletDetails || {};
              const ws1 = XLSX.utils.aoa_to_sheet([
                ['–ü–æ–ª–µ','–ó–Ω–∞—á–µ–Ω–∏–µ'],
                ['–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞', o.id],
                ['–î–∞—Ç–∞', Utils.formatDate(o.date)],
                ['–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏', o.deliveryDate||''],
                ['–ö–ª–∏–µ–Ω—Ç', outlet.name||''],
                ['–ö–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞', outlet.code||o.outlet||''],
                ['–ò–ù–ù', outlet.inn||''],
                ['–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏', outlet.address||''],
                ['–§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã', o.payment||outlet.paymentTerms||'']
              ]);
              const ws2 = XLSX.utils.aoa_to_sheet([
                ['‚Ññ','–ê—Ä—Ç–∏–∫—É–ª','–®—Ç—Ä–∏—Ö–∫–æ–¥','–ù–∞–∑–≤–∞–Ω–∏–µ','–¶–µ–Ω–∞','–ö–æ–ª-–≤–æ','–°—É–º–º–∞'],
                ... (o.items||[]).map((it,i)=>[i+1, it.sku, it.barcode||'', it.name, it.price, it.qty, (Number(it.price||0)*Number(it.qty||0))])
              ]);
              XLSX.utils.book_append_sheet(wb, ws1, `–ó–∞–∫–∞–∑_${String(idx+1).padStart(4,'0')}_–ó–∞–≥`);
              XLSX.utils.book_append_sheet(wb, ws2, `–ó–∞–∫–∞–∑_${String(idx+1).padStart(4,'0')}_–¢–æ–≤–∞—Ä—ã`);
            });
            Utils.saveWorkbookXLSX(wb, 'orders_all.xlsx');
            try { window.ActivityLog?.logActivity?.(window.ActivityLog.LOG_ACTIONS.ORDER_EXPORTED, 'orders', null, { type:'all', count: orders.length }); } catch(_){ }
            return;
          }

          // Fallback: Excel-compatible .xls (single sheet)
          const headers = ['–ó–∞–∫–∞–∑','–î–∞—Ç–∞','–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏','–ö–æ–¥ —Ç–æ—á–∫–∏','–¢–æ—á–∫–∞','–ò–ù–ù','–ê–¥—Ä–µ—Å','–û–ø–ª–∞—Ç–∞','–ê—Ä—Ç–∏–∫—É–ª','–®—Ç—Ä–∏—Ö–∫–æ–¥','–ù–∞–∑–≤–∞–Ω–∏–µ','–¶–µ–Ω–∞','–ö–æ–ª-–≤–æ','–°—É–º–º–∞'];
          const rows = [];
          for (const o of orders){
            const outlet = o.outletDetails || {};
            for (const it of (o.items||[])){
              rows.push([
                o.id||'',
                Utils.formatDate(o.date),
                o.deliveryDate||'',
                outlet.code||o.outlet||'',
                outlet.name||'',
                outlet.inn||'',
                outlet.address||'',
                o.payment||outlet.paymentTerms||'',
                it.sku||'',
                it.barcode||'',
                it.name||'',
                String(it.price||''),
                String(it.qty||''),
                String((Number(it.price||0)*Number(it.qty||0)))
              ]);
            }
          }
          const xml = Utils.buildExcelXmlTable(headers, rows, '–ó–∞–∫–∞–∑—ã');
          Utils.downloadFile('orders_all.xls', xml, 'application/vnd.ms-excel');
          Utils.showToast('XLSX –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —Å–∫–∞—á–∞–Ω Excel .xls (—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç)', 'warning');
        });

        deleteAllBtn.addEventListener('click', async ()=>{
          const ok = await Utils.showModal('–£–¥–∞–ª–µ–Ω–∏–µ', '–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã?', [
            {label:'–û—Ç–º–µ–Ω–∞', value:false, class:'border px-3 py-1.5 rounded-lg hover:bg-gray-50'},
            {label:'–£–¥–∞–ª–∏—Ç—å', value:true, class:'bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg'}
          ]);
          if (!ok) return;
          await Storage.clearStore('orders');
          Utils.showToast('–í—Å–µ –∑–∞–∫–∞–∑—ã —É–¥–∞–ª–µ–Ω—ã', 'info');
          await loadOrdersCache();
          await render();
        });
      }

      async function admin(){
        // –¢–∏—Ö–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ XLSX –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –∞–¥–º–∏–Ω–∫—É (–±–µ–∑ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö –æ—à–∏–±–æ–∫).
        // –û—à–∏–±–∫–∏ –±—É–¥–µ–º –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–¥–µ–ª–∞—Ç—å Excel-–¥–µ–π—Å—Ç–≤–∏–µ.
        const xlsxStatusEl = document.getElementById('xlsxStatus');
        try {
          const ok = await XLSXLoader.ensure();
          if (xlsxStatusEl){
            if (ok){
              xlsxStatusEl.textContent = 'Excel: –¥–æ—Å—Ç—É–ø–µ–Ω';
              xlsxStatusEl.className = 'text-xs px-2 py-1 rounded-lg border bg-green-50 text-green-700';
            } else {
              xlsxStatusEl.textContent = 'Excel: –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
              xlsxStatusEl.className = 'text-xs px-2 py-1 rounded-lg border bg-amber-50 text-amber-800';
            }
          }
        } catch(e){
          console.warn('XLSXLoader.ensure failed', e);
          if (xlsxStatusEl){
            xlsxStatusEl.textContent = 'Excel: –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
            xlsxStatusEl.className = 'text-xs px-2 py-1 rounded-lg border bg-amber-50 text-amber-800';
          }
        }

        // --- –ú–∏–Ω–∏-–∫–Ω–æ–ø–∫–∏ "i" –≤ –ø–ª–∏—Ç–∫–∞—Ö (–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞) ---
        (function initAdminTileHelp(){
          const helpTexts = {
            users: {
              title: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞',
              html: `
                <div class="space-y-2 text-sm">
                  <div><b>–î–æ–±–∞–≤–∏—Ç—å</b> ‚Äî —Å–æ–∑–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–ø–µ—Ä–∞—Ç–æ—Ä/–∞–¥–º–∏–Ω). –ü–∞—Ä–æ–ª—å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∏ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è.</div>
                  <div><b>–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å</b> ‚Äî –¥–æ—Å—Ç—É–ø–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É (–ø–∞—Ä–æ–ª–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ).</div>
                  <div><b>–£–¥–∞–ª–∏—Ç—å</b> ‚Äî –Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.</div>
                  <div class="text-xs text-gray-500">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ email (–≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ).</div>
                </div>`
            },
            products: {
              title: '–¢–æ–≤–∞—Ä—ã ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞',
              html: `
                <div class="space-y-2 text-sm">
                  <div><b>–ò–º–ø–æ—Ä—Ç</b> ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ—Ç Excel (.xlsx/.xls). –ê—Ä—Ç–∏–∫—É–ª –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω, —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è.</div>
                  <div><b>–®–∞–±–ª–æ–Ω</b> ‚Äî —Å–∫–∞—á–∏–≤–∞–µ—Ç —Ñ–∞–π–ª —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç —à–∞–±–ª–æ–Ω–∞).</div>
                  <div><b>–≠–∫—Å–ø–æ—Ä—Ç</b> ‚Äî –≤—ã–≥—Ä—É–∂–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ —Ç–æ–≤–∞—Ä—ã –≤ Excel.</div>
                  <div><b>–û—á–∏—Å—Ç–∏—Ç—å</b> ‚Äî —É–¥–∞–ª—è–µ—Ç –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –±–∞–∑—ã.</div>
                  <div class="text-xs text-gray-500">–¢–û–ü SKU: –∑–Ω–∞—á–µ–Ω–∏–µ 1 (–∏–ª–∏ ¬´–¥–∞/true/x¬ª) ‚Üí –±—É–¥–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å—Å—è –∫–Ω–æ–ø–∫–æ–π –¢–û–ü SKU –∏ –æ—Ç–º–µ—á–∞—Ç—å—Å—è –∑–Ω–∞—á–∫–æ–º üëç.</div>
                </div>`
            },
            images: {
              title: '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞',
              html: `
                <div class="space-y-2 text-sm">
                  <div><b>–ò–º–ø–æ—Ä—Ç —Ñ–æ—Ç–æ</b> ‚Äî –≤—ã–±–∏—Ä–∞–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –æ–Ω–∏ –±—É–¥—É—Ç —Å–∂–∞—Ç—ã –¥–æ 800√ó800 –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ.</div>
                  <div><b>–ò–º—è —Ñ–∞–π–ª–∞</b> –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å <b>–ê—Ä—Ç–∏–∫—É–ª–æ–º</b> –∏–ª–∏ <b>–®—Ç—Ä–∏—Ö–∫–æ–¥–æ–º</b>.</div>
                  <div>–°—É—Ñ—Ñ–∏–∫—Å—ã <b>(1)</b>, <b>(2)</b> ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ.</div>
                  <div class="text-xs text-gray-500">–ó–∞–≥–ª—É—à–∫–∞: –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª <b>1111111111.jpg</b> ‚Äî –æ–Ω –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ –±–µ–∑ —Ñ–æ—Ç–æ —Å –Ω–∞–¥–ø–∏—Å—å—é ¬´—É–∂–µ —Å–∫–æ—Ä–æ¬ª.</div>
                </div>`
            },
            outlets: {
              title: '–¢–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞',
              html: `
                <div class="space-y-2 text-sm">
                  <div><b>–ò–º–ø–æ—Ä—Ç</b> ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ç–æ—á–∫–∏ (–∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω). –°–æ–≤–ø–∞–¥–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è.</div>
                  <div><b>–®–∞–±–ª–æ–Ω</b> ‚Äî —Å–∫–∞—á–∞–π—Ç–µ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö.</div>
                  <div><b>–≠–∫—Å–ø–æ—Ä—Ç</b> ‚Äî –≤—ã–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ —Ç–æ—á–∫–∏ –≤ Excel.</div>
                  <div><b>–û—á–∏—Å—Ç–∏—Ç—å</b> ‚Äî —É–¥–∞–ª—è–µ—Ç –≤—Å–µ —Ç–æ—á–∫–∏.</div>
                  <div class="text-xs text-gray-500">–ü–æ–ª—è –æ–ø–ª–∞—Ç—ã –∏ –∫—Ä–µ–¥–∏—Ç–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞.</div>
                </div>`
            },
            contacts: {
              title: '–ö–æ–Ω—Ç–∞–∫—Ç—ã ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞',
              html: `
                <div class="space-y-2 text-sm">
                  <div><b>–ò–º–ø–æ—Ä—Ç</b> ‚Äî –æ–¥–∏–Ω –∫–æ–¥ —Ç–æ—á–∫–∏ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ (–∫–æ–Ω—Ç–∞–∫—Ç–æ–≤); –æ–Ω–∏ –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è.</div>
                  <div><b>–®–∞–±–ª–æ–Ω</b> ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.</div>
                  <div><b>–û—á–∏—Å—Ç–∏—Ç—å</b> ‚Äî —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã.</div>
                </div>`
            },
            promos: {
              title: '–ü–†–û–ú–û ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞',
              html: `
                <div class="space-y-2 text-sm">
                  <div><b>–ò–º–ø–æ—Ä—Ç</b> ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∞–∫—Ü–∏–∏ –≤ IndexedDB.promos.</div>
                  <div><b>–®–∞–±–ª–æ–Ω</b> ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –ø–æ–ª–µ–π –∏ –¥–∞—Ç.</div>
                  <div><b>–≠–∫—Å–ø–æ—Ä—Ç</b> ‚Äî –≤—ã–≥—Ä—É–∂–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ –∞–∫—Ü–∏–∏.</div>
                  <div><b>–û—á–∏—Å—Ç–∏—Ç—å</b> ‚Äî —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –∞–∫—Ü–∏–∏.</div>
                  <div class="text-xs text-gray-500">–ê–∫—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫ –∫–æ—Ä–∑–∏–Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞.</div>
                </div>`
            },
            routes: {
              title: '–ú–∞—Ä—à—Ä—É—Ç—ã ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞',
              html: `
                <div class="space-y-2 text-sm">
                  <div><b>–ò–º–ø–æ—Ä—Ç</b> ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç—ã, –∑–∞—Ç–µ–º –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø–ª–∞–Ω –Ω–∞ 7 –¥–Ω–µ–π.</div>
                  <div><b>–®–∞–±–ª–æ–Ω</b> ‚Äî —Ñ–æ—Ä–º–∞—Ç: <b>–¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏</b> (1..7) + <b>—Ü–∏–∫–ª –Ω–µ–¥–µ–ª–∏</b> (1 / 2.1 / 2.2 / 4.1..4.4).</div>
                  <div class="border rounded-lg p-2 bg-gray-50">
                    <div class="text-sm fw-semibold mb-1">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —Ü–∏–∫–ª–æ–≤ (ISO-–Ω–µ–¥–µ–ª–∏ –æ—Ç –Ω–∞—á–∞–ª–∞ –≥–æ–¥–∞)</div>
                    <ul class="list-disc pl-5 space-y-1 text-sm">
                      <li><b>1</b> ‚Äî –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é</li>
                      <li><b>2.1</b> ‚Äî –Ω–µ—á–µ—Ç–Ω–∞—è –Ω–µ–¥–µ–ª—è (—Ä–∞–∑ –≤ 2 –Ω–µ–¥–µ–ª–∏)</li>
                      <li><b>2.2</b> ‚Äî —á–µ—Ç–Ω–∞—è –Ω–µ–¥–µ–ª—è (—Ä–∞–∑ –≤ 2 –Ω–µ–¥–µ–ª–∏)</li>
                      <li><b>4.1</b> ‚Äî –ø–µ—Ä–≤–∞—è –Ω–µ–¥–µ–ª—è (—Ä–∞–∑ –≤ 4 –Ω–µ–¥–µ–ª–∏)</li>
                      <li><b>4.2</b> ‚Äî –≤—Ç–æ—Ä–∞—è –Ω–µ–¥–µ–ª—è (—Ä–∞–∑ –≤ 4 –Ω–µ–¥–µ–ª–∏)</li>
                      <li><b>4.3</b> ‚Äî —Ç—Ä–µ—Ç—å—è –Ω–µ–¥–µ–ª—è (—Ä–∞–∑ –≤ 4 –Ω–µ–¥–µ–ª–∏)</li>
                      <li><b>4.4</b> ‚Äî —á–µ—Ç–≤–µ—Ä—Ç–∞—è –Ω–µ–¥–µ–ª—è (—Ä–∞–∑ –≤ 4 –Ω–µ–¥–µ–ª–∏)</li>
                    </ul>
                    <div class="text-xs text-gray-500 mt-1">–ù–µ–¥–µ–ª–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –ø–æ ISO 8601 (–ø–µ—Ä–≤–∞—è –Ω–µ–¥–µ–ª—è –≥–æ–¥–∞ –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É, –Ω–µ–¥–µ–ª—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ü–Ω).</div>
                  </div>
                  <div><b>–û—á–∏—Å—Ç–∏—Ç—å –≤–∏–∑–∏—Ç—ã</b> ‚Äî —É–¥–∞–ª—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –∑–≤–æ–Ω–∫–æ–≤ –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç –ø–ª–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.</div>
                  <div class="text-xs text-gray-500">–û–ø–µ—Ä–∞—Ç–æ—Ä –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –º–∞—Ä—à—Ä—É—Ç—ã –∏ –≤–∏–∑–∏—Ç—ã, –∞–¥–º–∏–Ω ‚Äî –≤—Å–µ.</div>
                </div>`
            },
            materials: {
              title: '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞',
              html: `
                <div class="space-y-2 text-sm">
                  <div><b>–ó–∞–≥—Ä—É–∑–∏—Ç—å</b> ‚Äî —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (base64) –∏ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –º–µ–Ω—é ¬´–ú–∞—Ç–µ—Ä–∏–∞–ª—ã¬ª –≤ —à–∞–ø–∫–µ.</div>
                  <div><b>–£–¥–∞–ª–∏—Ç—å</b> ‚Äî —É–±–∏—Ä–∞–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª –∏–∑ —Å–ø–∏—Å–∫–∞.</div>
                </div>`
            },
            backup: {
              title: '–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞',
              html: `
                <div class="space-y-2 text-sm">
                  <div><b>–°–∫–∞—á–∞—Ç—å –±—ç–∫–∞–ø</b> ‚Äî –≤—ã–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ IndexedDB –æ–¥–Ω–∏–º JSON.</div>
                  <div><b>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</b> ‚Äî –∑–∞–º–µ–Ω—è–µ—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞.</div>
                  <div><b>–ê–≤—Ç–æ–±—ç–∫–∞–ø</b> ‚Äî —Ö—Ä–∞–Ω–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –∫–æ–ø–∏–∏ –≤ localStorage.</div>
                  <div class="text-xs text-gray-500">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ –¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø –ø–µ—Ä–µ–¥ –º–∞—Å—Å–æ–≤—ã–º–∏ –∏–º–ø–æ—Ä—Ç–∞–º–∏.</div>
                </div>`
            }
          };

          // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–∞–º i
          document.getElementById('main-content')?.addEventListener('click', async (e)=>{
            const btn = e.target.closest('[data-admin-help]');
            if (!btn) return;
            const key = btn.getAttribute('data-admin-help');
            const meta = helpTexts[key];
            if (!meta) return;
            await Utils.showModal(meta.title, meta.html, [{ label:'–ü–æ–Ω—è—Ç–Ω–æ', value:false, class:'bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg' }]);
          });
        })();

        // –í–µ—Ä—Ö–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
        document.getElementById('btnSchema').addEventListener('click', async ()=>{
          const div=document.createElement('div');
          div.innerHTML = `
            <div class="text-sm space-y-3">
              <div class="fw-semibold">–°—Ö–µ–º–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã Big TeleSales (—á—Ç–æ –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è)</div>

              <div class="rounded-lg border bg-gray-50 p-3">
                <div class="fw-semibold mb-1">–ù–∞–≤–∏–≥–∞—Ü–∏—è (–ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å)</div>
                <ul class="list-disc pl-5 space-y-1">
                  <li><b>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</b> ‚Äî –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –≤–∏–∑–∏—Ç–æ–≤ –∏ –∑–∞–∫–∞–∑–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥ + –≥—Ä–∞—Ñ–∏–∫.</li>
                  <li><b>–¢–µ–ª–µ–≤–∏–∑–∏—Ç—ã</b> ‚Äî —Å–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É/–ø–µ—Ä–∏–æ–¥, –∫–∞—Ä—Ç–æ—á–∫–∏ –≤–∏–∑–∏—Ç–æ–≤, –∫–æ–Ω—Ç–∞–∫—Ç—ã, –∑–∞–ø—É—Å–∫ –≤–∏–∑–∏—Ç–∞.</li>
                  <li><b>–ö–∞—Ç–∞–ª–æ–≥</b> ‚Äî —Ç–æ–≤–∞—Ä—ã, –ø–æ–∏—Å–∫/—Ñ–∏–ª—å—Ç—Ä—ã, –∫–æ—Ä–∑–∏–Ω–∞, –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞.</li>
                  <li><b>–ó–∞–∫–∞–∑—ã</b> ‚Äî —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤, –ø—Ä–æ—Å–º–æ—Ç—Ä, —ç–∫—Å–ø–æ—Ä—Ç Excel, –ø–µ—á–∞—Ç—å, —É–¥–∞–ª–µ–Ω–∏–µ.</li>
                  <li><b>–ê–¥–º–∏–Ω. –ø–∞–Ω–µ–ª—å</b> ‚Äî –∏–º–ø–æ—Ä—Ç/—ç–∫—Å–ø–æ—Ä—Ç –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ (–≤–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ —Ä–æ–ª–∏ <b>admin</b>).</li>
                </ul>
                <div class="text-xs text-gray-500 mt-2">–ü–∞–Ω–µ–ª—å —Å–ª–µ–≤–∞ –≤—Å–µ–≥–¥–∞ —Å–≤–µ—Ä–Ω—É—Ç–∞ ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—É–Ω–∫—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏.</div>
              </div>

              <div class="rounded-lg border bg-gray-50 p-3">
                <div class="fw-semibold mb-1">–®–∞–ø–∫–∞ (–≤–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)</div>
                <ul class="list-disc pl-5 space-y-1">
                  <li><b>–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</b> ‚Äî —Å–ª–µ–≤–∞ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏).</li>
                  <li><b>–¢–∞–π–º–µ—Ä –≤–∏–∑–∏—Ç–∞</b> ‚Äî –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–∏–∑–∏—Ç–∞ (‚è±Ô∏è 00:00:00) + –∫–Ω–æ–ø–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.</li>
                  <li><b>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</b> (–∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫) ‚Äî –±–µ–π–¥–∂ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö, —Å–ø–∏—Å–æ–∫, ¬´–ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ¬ª.</li>
                  <li><b>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</b> ‚Äî –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ (–∏–∑ –∞–¥–º–∏–Ω–∫–∏).</li>
                  <li><b>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</b> ‚Äî —Å—Å—ã–ª–∫–∞ –Ω–∞ email.</li>
                  <li><b>Offline —Ä–µ–∂–∏–º</b> ‚Äî —Å–≤–µ—Ä—Ö—É –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä, –µ—Å–ª–∏ –Ω–µ—Ç —Å–µ—Ç–∏.</li>
                </ul>
              </div>

              <div class="rounded-lg border bg-gray-50 p-3">
                <div class="fw-semibold mb-1">–ö–ª—é—á–µ–≤—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–æ—Å–Ω–æ–≤–Ω—ã–µ –±–ª–æ–∫–∏)</div>
                <ul class="list-disc pl-5 space-y-1">
                  <li><b>–ö–∞—Ç–∞–ª–æ–≥</b>: –≤–µ—Ä—Ö–Ω—è—è –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å (–ø–æ–∏—Å–∫/–¢–û–ü SKU/—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞/–∫–æ—Ä–∑–∏–Ω–∞) + –ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–ü–æ—Å—Ç–∞–≤—â–∏–∫/–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å/–ö–∞—Ç–µ–≥–æ—Ä–∏—è/–°—É–±–∫–∞—Ç–µ–≥–æ—Ä–∏—è) + —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ (–ü–ª–∏—Ç–∫–∞/–¢–∞–±–ª–∏—Ü–∞) + –±–æ–∫–æ–≤–∞—è –∫–æ—Ä–∑–∏–Ω–∞.</li>
                  <li><b>–¢–µ–ª–µ–≤–∏–∑–∏—Ç—ã</b>: –ø–∞–Ω–µ–ª—å –¥–∞—Ç—ã/–ø–µ—Ä–∏–æ–¥–∞ + —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–Ω—è + –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ—á–µ–∫ (–ø–ª–∞–Ω–æ–≤—ã–µ/–≤–Ω–µ–ø–ª–∞–Ω–æ–≤—ã–µ) + –º–æ–¥–∞–ª–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤.</li>
                  <li><b>–ó–∞–∫–∞–∑—ã</b>: –ø–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ + –∫–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–∫–∞–∑–æ–≤ + –º–æ–¥–∞–ª–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ + Excel/–ü–µ—á–∞—Ç—å.</li>
                  <li><b>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</b>: –≤—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ + KPI –≤–∏–∑–∏—Ç–æ–≤/–∑–∞–∫–∞–∑–æ–≤ + –¢–û–ü SKU + –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–¥–∞–∂.</li>
                </ul>
              </div>

              <div class="rounded-lg border bg-gray-50 p-3">
                <div class="fw-semibold mb-1">–•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö (–≥–¥–µ –≤—Å—ë —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è)</div>
                <ul class="list-disc pl-5 space-y-1">
                  <li><b>IndexedDB</b> (BigTeleSalesDB): users, products, productImages, outlets, contacts, orders, visits, promos, routes, notifications, activityLog, settings.</li>
                  <li><b>localStorage</b>: —Å–µ—Å—Å–∏—è, –∫–æ—Ä–∑–∏–Ω–∞, –∞–∫—Ç–∏–≤–Ω—ã–π –≤–∏–∑–∏—Ç (—Ç–∞–π–º–µ—Ä), –∞–≤—Ç–æ-–±—ç–∫–∞–ø—ã (3 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö), –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ UI –∫–∞—Ç–∞–ª–æ–≥–∞.</li>
                </ul>
              </div>

              <div class="rounded-lg border bg-gray-50 p-3">
                <div class="fw-semibold mb-1">–ê–≤—Ç–æ–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –º–∞—Ä—à—Ä—É—Ç–∞–º</div>
                <div class="text-sm">–ú–∞—Ä—à—Ä—É—Ç—ã ‚Üí –ø–ª–∞–Ω–æ–≤—ã–µ –≤–∏–∑–∏—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è/–∑–∞–≤—Ç—Ä–∞. –ê–ª–≥–æ—Ä–∏—Ç–º: <b>–¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ 1..7</b> + <b>—Ü–∏–∫–ª –Ω–µ–¥–µ–ª—å</b> (1 / 2.1 / 2.2 / 4.1..4.4) –ø–æ ISO-–Ω–µ–¥–µ–ª—è–º –æ—Ç –Ω–∞—á–∞–ª–∞ –≥–æ–¥–∞.</div>
              </div>

              <div class="rounded-lg border bg-gray-50 p-3">
                <div class="fw-semibold mb-1">–ü–†–û–ú–û (–∞–∫—Ü–∏–∏)</div>
                <div class="text-sm">–ê–∫—Ü–∏–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ <b>IndexedDB.promos</b>, –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥–µ (–∫–∞—Ä—É—Å–µ–ª—å/–±–µ–π–¥–∂ ¬´–ê–ö–¶–ò–Ø¬ª) –∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫ –∫–æ—Ä–∑–∏–Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞.</div>
              </div>
            </div>`;
          await Utils.showModal('–°—Ö–µ–º–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã', div, [{label:'OK'}]);
        });
        document.getElementById('btnInfo').addEventListener('click', async ()=>{
          const div=document.createElement('div');
          div.innerHTML = `
            <div class="text-sm space-y-3">
              <div class="fw-semibold">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–∞–±–æ—Ç–µ —Å Big TeleSales</div>

              <div class="rounded-lg border bg-gray-50 p-3">
                <div class="fw-semibold mb-1">1) –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä—É (–±—ã—Å—Ç—Ä—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π)</div>
                <ol class="list-decimal pl-5 space-y-1">
                  <li>–û—Ç–∫—Ä–æ–π—Ç–µ <b>–¢–µ–ª–µ–≤–∏–∑–∏—Ç—ã</b> ‚Äî –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–ª–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.</li>
                  <li>–î–≤–∞–∂–¥—ã –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ —Ç–æ—á–∫–µ ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è <b>–ö–∞—Ç–∞–ª–æ–≥</b> –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è —Ç–∞–π–º–µ—Ä –≤–∏–∑–∏—Ç–∞.</li>
                  <li>–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω—É –∏ –Ω–∞–∂–º–∏—Ç–µ <b>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</b>.</li>
                  <li>–ü—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ –ø–æ—è–≤–∏—Ç—Å—è –æ–∫–Ω–æ <b>–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–∏–∑–∏—Ç–∞</b> ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</li>
                  <li>–í <b>–ó–∞–∫–∞–∑–∞—Ö</b> –º–æ–∂–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–∫–∞–∑, —Å–∫–∞—á–∞—Ç—å Excel –∏ —Ä–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å.</li>
                </ol>
              </div>

              <div class="rounded-lg border bg-gray-50 p-3">
                <div class="fw-semibold mb-1">2) –ö–∞—Ç–∞–ª–æ–≥ (–ø–æ–∏—Å–∫, —Ñ–∏–ª—å—Ç—Ä—ã, –∫–æ—Ä–∑–∏–Ω–∞)</div>
                <ul class="list-disc pl-5 space-y-1">
                  <li><b>–ü–æ–∏—Å–∫</b> ‚Äî –∏—â–µ—Ç –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞—Ä—Ç–∏–∫—É–ª—É, —à—Ç—Ä–∏—Ö–∫–æ–¥—É, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—é, –ø–æ—Å—Ç–∞–≤—â–∏–∫—É.</li>
                  <li><b>–§–∏–ª—å—Ç—Ä—ã —Å–ª–µ–≤–∞</b> ‚Äî –≤–∑–∞–∏–º–æ–∑–∞–≤–∏—Å–∏–º—ã–µ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä (–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –∏ —Ç.–¥.).</li>
                  <li><b>–¢–û–ü SKU</b> ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã —Å –¢–û–ü –°–ö–Æ = 1 (–≤ —Ñ–∞–π–ª–µ –∏–º–ø–æ—Ä—Ç–∞ —Ç–æ–≤–∞—Ä–æ–≤).</li>
                  <li><b>–ü–ª–∏—Ç–∫–∞/–¢–∞–±–ª–∏—Ü–∞</b> ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</li>
                  <li><b>–ö–æ—Ä–∑–∏–Ω–∞</b> ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –í –∫–æ—Ä–∑–∏–Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Å–∫–∏–¥–∫–∏ –ø–æ –∞–∫—Ü–∏—è–º (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ).</li>
                  <li><b>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</b> ‚Äî —Å–≤–µ—Ä—Ö—É –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è <b>–¥–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</b> (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞), –¥–∞–ª–µ–µ –∫–ª–∏–µ–Ω—Ç/—Ç–æ—á–∫–∞, –æ–ø–ª–∞—Ç–∞, –∫—Ä–µ–¥–∏—Ç–Ω—ã–π –ª–∏–º–∏—Ç, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.</li>
                </ul>
              </div>

              <div class="rounded-lg border bg-gray-50 p-3">
                <div class="fw-semibold mb-1">3) –¢–µ–ª–µ–≤–∏–∑–∏—Ç—ã (–ø–ª–∞–Ω/–ø–µ—Ä–∏–æ–¥/–∫–æ–Ω—Ç–∞–∫—Ç—ã)</div>
                <ul class="list-disc pl-5 space-y-1">
                  <li>–ö–Ω–æ–ø–∫–∞ <b>–ü–µ—Ä–∏–æ–¥</b> –≤–∫–ª—é—á–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É –¥–∞—Ç (–º–∞–∫—Å–∏–º—É–º 3 –º–µ—Å—è—Ü–∞).</li>
                  <li>–ö–Ω–æ–ø–∫–∞ <b>–ö–æ–Ω—Ç–∞–∫—Ç—ã</b> –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Ç–æ—á–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω—ã (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ tel:).</li>
                  <li>–ö–Ω–æ–ø–∫–∞ <b>‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∏–∑–∏—Ç</b> ‚Äî —Å–æ–∑–¥–∞—ë—Ç –≤–Ω–µ–ø–ª–∞–Ω–æ–≤—ã–π –≤–∏–∑–∏—Ç (‚ö°) –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É.</li>
                  <li>–ö–∞–∂–¥–∞—è —Ç–æ—á–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è <b>–æ–¥–∏–Ω —Ä–∞–∑</b> –Ω–∞ –¥–∞—Ç—É; –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è/–ø–µ—Ä–µ–Ω–æ—Å–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ —É—Ö–æ–¥–∏—Ç –≤–Ω–∏–∑ –ø–æ —Å–ø–∏—Å–∫—É.</li>
                </ul>
              </div>

              <div class="rounded-lg border bg-gray-50 p-3">
                <div class="fw-semibold mb-1">4) –ó–∞–∫–∞–∑—ã</div>
                <ul class="list-disc pl-5 space-y-1">
                  <li>–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∑–∞–∫–∞–∑–æ–≤ –≤–∫–ª—é—á–µ–Ω–∞ –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–∫–∞–∑–æ–≤ (—Å—Ç–∞—Ä—à–µ 3 –¥–Ω–µ–π).</li>
                  <li>–í –∫–∞—Ä—Ç–æ—á–∫–µ –∑–∞–∫–∞–∑–∞ –¥–æ—Å—Ç—É–ø–Ω–æ: <b>–ü—Ä–æ—Å–º–æ—Ç—Ä</b>, <b>Excel</b>, <b>–ü–µ—á–∞—Ç—å</b>, <b>–£–¥–∞–ª–∏—Ç—å</b>.</li>
                  <li>–ö–Ω–æ–ø–∫–∞ <b>–°–∫–∞—á–∞—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã</b> –≤—ã–≥—Ä—É–∂–∞–µ—Ç –æ–¥–Ω–∏–º —Ñ–∞–π–ª–æ–º.</li>
                </ul>
              </div>

              <div class="rounded-lg border bg-gray-50 p-3">
                <div class="fw-semibold mb-1">5) –ü–†–û–ú–û (–∞–∫—Ü–∏–∏)</div>
                <ul class="list-disc pl-5 space-y-1">
                  <li>–ê–∫—Ü–∏–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ <b>IndexedDB.promos</b> –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –≤ –∫–æ—Ä–∑–∏–Ω–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞.</li>
                  <li>–í –∫–∞—Ç–∞–ª–æ–≥–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ –≤–∏–¥–µ <b>–∫–∞—Ä—É—Å–µ–ª–∏</b> —Å–≤–µ—Ä—Ö—É (–º–æ–∂–Ω–æ –∫–ª–∏–∫–Ω—É—Ç—å –∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –∞–∫—Ü–∏–∏).</li>
                  <li>–í –∫–æ—Ä–∑–∏–Ω–µ —Å–∫–∏–¥–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π: –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–∫—Ü–∏–∏, %, —Å—É–º–º–∞ —Å–∫–∏–¥–∫–∏ –∏ –∏—Ç–æ–≥.</li>
                </ul>
              </div>

              <div class="rounded-lg border bg-gray-50 p-3">
                <div class="fw-semibold mb-1">6) –ú–∞—Ä—à—Ä—É—Ç—ã –∏ –∞–≤—Ç–æ–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
                <ul class="list-disc pl-5 space-y-1">
                  <li>–ú–∞—Ä—à—Ä—É—Ç –ø—Ä–∏–≤—è–∑–∞–Ω –∫ email –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ (–æ–ø–µ—Ä–∞—Ç–æ—Ä –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ç–æ—á–∫–∏; –∞–¥–º–∏–Ω ‚Äî –≤—Å–µ).</li>
                  <li>–ê–ª–≥–æ—Ä–∏—Ç–º –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: <b>–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (1..7)</b> + <b>–¶–∏–∫–ª –Ω–µ–¥–µ–ª–∏</b> (1 / 2.1 / 2.2 / 4.1..4.4) –ø–æ ISO-–Ω–µ–¥–µ–ª—è–º.</li>
                  <li>–ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –ø–ª–∞–Ω –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 7 –¥–Ω–µ–π.</li>
                  <li>–ö–Ω–æ–ø–∫–∞ <b>üßπ –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤–∏–∑–∏—Ç–æ–≤</b> —É–¥–∞–ª—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –∏ –æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤ ¬´–¢–µ–ª–µ–≤–∏–∑–∏—Ç–∞—Ö¬ª —Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.</li>
                </ul>
              </div>

              <div class="rounded-lg border bg-gray-50 p-3">
                <div class="fw-semibold mb-1">7) –ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç (—Ç–æ–≤–∞—Ä—ã, —Ç–æ—á–∫–∏, –∫–æ–Ω—Ç–∞–∫—Ç—ã, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)</div>
                <ul class="list-disc pl-5 space-y-1">
                  <li><b>–¢–æ–≤–∞—Ä—ã</b>: –∏–º–ø–æ—Ä—Ç/—ç–∫—Å–ø–æ—Ä—Ç Excel, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –ø–æ–ª–µ <b>–û–ø–∏—Å–∞–Ω–∏–µ</b>, —à—Ç—Ä–∏—Ö–∫–æ–¥, —Ü–µ–Ω—ã, –¢–û–ü SKU, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞.</li>
                  <li><b>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</b>: –∏–º—è —Ñ–∞–π–ª–∞ = –∞—Ä—Ç–∏–∫—É–ª –∏–ª–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥; (1)/(2) = –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ. –ó–∞–≥–ª—É—à–∫–∞: <b>1111111111.jpg</b> ‚Üí –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ ¬´—É–∂–µ —Å–∫–æ—Ä–æ¬ª –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ –±–µ–∑ —Ñ–æ—Ç–æ.</li>
                  <li><b>–¢–æ—á–∫–∏</b>: –∏–º–ø–æ—Ä—Ç/—ç–∫—Å–ø–æ—Ä—Ç Excel, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞, –ò–ù–ù, –∞–¥—Ä–µ—Å, —É—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã, –∫—Ä–µ–¥–∏—Ç–Ω—ã–π –ª–∏–º–∏—Ç, –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å.</li>
                  <li><b>–ö–æ–Ω—Ç–∞–∫—Ç—ã</b>: –∏–º–ø–æ—Ä—Ç Excel, –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –Ω–∞ –æ–¥–Ω—É —Ç–æ—á–∫—É (–≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –ø–æ –∫–æ–¥—É).</li>
                </ul>
              </div>

              <div class="rounded-lg border bg-gray-50 p-3">
                <div class="fw-semibold mb-1">8) –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, Offline –∏ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏</div>
                <ul class="list-disc pl-5 space-y-1">
                  <li><b>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</b>: –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫ –≤ —à–∞–ø–∫–µ, –∞–≤—Ç–æ-–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç.</li>
                  <li><b>Offline —Ä–µ–∂–∏–º</b>: –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å–µ—Ç–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä ¬´Offline —Ä–µ–∂–∏–º¬ª.</li>
                  <li><b>–ë—ç–∫–∞–ø</b>: –º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –ø–æ–ª–Ω—É—é –∫–æ–ø–∏—é –±–∞–∑—ã (JSON) –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –µ—ë. –ï—Å—Ç—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–≤—Ç–æ–±—ç–∫–∞–ø (—Ö—Ä–∞–Ω–∏—Ç—Å—è 3 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–æ–ø–∏–∏).</li>
                </ul>
              </div>

              <div class="rounded-lg border bg-red-50 p-3">
                <div class="fw-semibold mb-1 text-red-700">–í–∞–∂–Ω–æ (–ø—Ä–æ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö)</div>
                <div class="text-sm">–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è <b>–ª–æ–∫–∞–ª—å–Ω–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ</b>. –ï—Å–ª–∏ –æ—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–∞–π—Ç–∞/–±—Ä–∞—É–∑–µ—Ä–∞ ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞. –î–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ <b>—Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é</b> (JSON) –∏–ª–∏ Excel-—ç–∫—Å–ø–æ—Ä—Ç.</div>
              </div>

              <div class="rounded-lg border bg-gray-50 p-3">
                <div class="fw-semibold mb-1">–ö–Ω–æ–ø–∫–∞ ¬´–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë¬ª</div>
                <div class="text-sm">–ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∫–æ—Ä–∑–∏–Ω–∞/–≤–∏–∑–∏—Ç/–∞–≤—Ç–æ–±—ç–∫–∞–ø—ã) –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è ¬´—á–∏—Å—Ç–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞¬ª.</div>
              </div>
            </div>`;
          await Utils.showModal('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', div, [{label:'–ü–æ–Ω—è—Ç–Ω–æ'}]);
        });

        // --- –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å ---
        document.getElementById('btnTimezone')?.addEventListener('click', async ()=>{
          try {
            const cur = (globalThis.TZ?.getTimeZone?.() || 'Europe/Moscow');
            const c = document.createElement('div');
            const opts = (globalThis.TZ?.list?.() || [{value:'Europe/Moscow', label:'–ú–æ—Å–∫–≤–∞ (Europe/Moscow)'}])
              .map(o=> `<option value="${String(o.value)}" ${String(o.value)===String(cur)?'selected':''}>${String(o.label)}</option>`)
              .join('');
            c.innerHTML = `
              <div class="space-y-2 text-sm">
                <div class="text-gray-600">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞—Ç –≤–æ –≤—Å–µ—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä—è—Ö –∏ —Å–ø–∏—Å–∫–∞—Ö (–¢–µ–ª–µ–≤–∏–∑–∏—Ç—ã, –ê–Ω–∞–ª–∏—Ç–∏–∫–∞, –ó–∞–∫–∞–∑—ã –∏ —Ç.–¥.).</div>
                <label class="block text-sm font-medium">–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å</label>
                <select id="tzSelect" class="w-full border rounded-lg px-3 py-2">${opts}</select>
                <div class="text-xs text-gray-500">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: –ú–æ—Å–∫–≤–∞ (Europe/Moscow).</div>
              </div>
            `;
            const ok = await Utils.showModal('–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å', c, [
              { label:'–û—Ç–º–µ–Ω–∞', value:false, class:'border px-3 py-1.5 rounded-lg hover:bg-gray-50' },
              { label:'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', value:true, class:'bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg' }
            ]);
            if (!ok) return;
            const next = c.querySelector('#tzSelect')?.value || 'Europe/Moscow';
            try { globalThis.TZ?.setTimeZone?.(next); } catch(_){ }
            try { await Storage.put('settings', { key:'timezone', value: String(next) }); } catch(_){ }
            Utils.showToast('–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞‚Ä¶', 'success');
            setTimeout(()=>location.reload(), 700);
          } catch(e){
            console.error('btnTimezone error', e);
            Utils.showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å', 'error');
          }
        });

        // --- –°–±—Ä–æ—Å –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –∫—ç—à–∞ ---
        document.getElementById('btnResetAll')?.addEventListener('click', async ()=>{
          const ok = await Utils.showModal('üß® –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë',
            `<div class="text-sm space-y-2">
              <div class="text-red-600"><b>–í–Ω–∏–º–∞–Ω–∏–µ:</b> —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∞.</div>
              <ul class="list-disc pl-5">
                <li>–¢–æ–≤–∞—Ä—ã, —Ñ–æ—Ç–æ, —Ç–æ—á–∫–∏, –∫–æ–Ω—Ç–∞–∫—Ç—ã</li>
                <li>–ú–∞—Ä—à—Ä—É—Ç—ã –∏ –∏—Å—Ç–æ—Ä–∏—è –≤–∏–∑–∏—Ç–æ–≤</li>
                <li>–ó–∞–∫–∞–∑—ã</li>
                <li>–ü–†–û–ú–û –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</li>
                <li>–ö–æ—Ä–∑–∏–Ω–∞ –∏ –∞–∫—Ç–∏–≤–Ω—ã–π –≤–∏–∑–∏—Ç</li>
              </ul>
              <div>–ü–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ –±—É–¥—É—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –¥–µ–º–æ‚Äë–¥–∞–Ω–Ω—ã–µ (admin –∏ —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏).</div>
            </div>`,
            [
              { label:'–û—Ç–º–µ–Ω–∞', value:false, class:'border px-3 py-1.5 rounded-lg hover:bg-gray-50' },
              { label:'–°–±—Ä–æ—Å–∏—Ç—å', value:true, class:'bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg' }
            ]
          );
          if (!ok) return;

          try {
            // 1) –°–±—Ä–æ—Å IndexedDB + –¥–µ–º–æ-–Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
            await Storage.resetAndSeed();

            // 2) –û—á–∏—Å—Ç–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∫–æ—Ä–∑–∏–Ω–∞/–≤–∏–∑–∏—Ç/–∞–≤—Ç–æ–±—ç–∫–∞–ø—ã/–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ UI)
            try { localStorage.removeItem('bts_cart'); } catch(_){ }
            try { localStorage.removeItem('bts_visit'); } catch(_){ }
            try { localStorage.removeItem('bts_autoBackups'); } catch(_){ }
            try { localStorage.removeItem('bts_cat_view'); } catch(_){ }
            try { localStorage.removeItem('bts_cat_sort'); } catch(_){ }
            try { localStorage.removeItem('bts_cat_filters_open'); } catch(_){ }

            // 3) –û—á–∏—Å—Ç–∫–∞ SW caches (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã)
            try {
              if (window.caches && typeof caches.keys === 'function'){
                const keys = await caches.keys();
                await Promise.all(keys.map(k => caches.delete(k)));
              }
            } catch(e){ console.warn('Cache delete skipped', e); }

            // 4) –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ–Ω–æ–≤—ã—Ö –º–æ–¥—É–ª–µ–π/–∫—ç—à–µ–π
            try { AnalyticsPrecalc.invalidate(); } catch(_){ }
            try { window.Notifications?.stopAutoCheck?.(); } catch(_){ }
            try { window.Backup?.stopAutoBackup?.(); } catch(_){ }

            Utils.showToast('–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞‚Ä¶', 'success');
            setTimeout(()=>location.reload(), 800);
          } catch(e){
            console.error('Reset all failed', e);
            Utils.showToast('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö', 'error');
          }
        });

        // --- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ---
        const usersTbody = document.getElementById('usersTable');
        async function renderUsers(){
          const users = await Storage.getAll('users');
          usersTbody.innerHTML = '';
          users.forEach(u => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="py-2 pr-2">${u.email}</td>
              <td class="py-2 pr-2">${u.role}</td>
              <td class="py-2 pr-2">${Utils.formatDate(u.createdAt||Date.now(), 'dd.MM.yyyy')}</td>
              <td class="py-2 pr-2">
                <button class="text-sm text-gray-600 hover:text-gray-800" data-action="viewpass" data-id="${u.id}">–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å</button>
                <button class="ml-2 text-sm text-indigo-600 hover:text-indigo-700" data-action="pass" data-id="${u.id}">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å</button>
                <button class="ml-2 text-sm text-red-600 hover:text-red-700" data-action="delete" data-id="${u.id}">–£–¥–∞–ª–∏—Ç—å</button>
              </td>`;
            usersTbody.appendChild(tr);
          });
        }
        await renderUsers();

        document.getElementById('addUserBtn').addEventListener('click', async () => {
          const c = document.createElement('div');
          c.innerHTML = `
            <div class="space-y-3">
              <div>
                <label class="block text-sm mb-1">Email</label>
                <input id="email" type="email" class="w-full border rounded-lg px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm mb-1">–†–æ–ª—å</label>
                <select id="role" class="w-full border rounded-lg px-3 py-2">
                  <option value="operator">–û–ø–µ—Ä–∞—Ç–æ—Ä</option>
                  <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                </select>
              </div>
              <div class="flex items-center gap-2">
                <button id="genPass" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å</button>
                <span id="passOut" class="text-sm text-gray-600"></span>
              </div>
              <div>
                <button id="sendMail" class="border px-3 py-1.5 rounded-lg text-sm hover:bg-gray-50">üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø–æ—á—Ç—É</button>
              </div>
            </div>`;
          const okPromise = Utils.showModal('–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', c, [
            { label:'–û—Ç–º–µ–Ω–∞', value:false, class:'border px-3 py-1.5 rounded-lg hover:bg-gray-50' },
            { label:'–°–æ–∑–¥–∞—Ç—å', value:true, class:'bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg' }
          ]);
          let generated = '';
          c.querySelector('#genPass').addEventListener('click', async ()=>{
            generated = Utils.generatePassword(10); c.querySelector('#passOut').textContent = generated; await Utils.copyToClipboard(generated);
          });
          c.querySelector('#sendMail').addEventListener('click', ()=>{
            const email = (c.querySelector('#email').value||'').trim();
            const pass = generated || '–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –ø–∞—Ä–æ–ª—å';
            const subject = encodeURIComponent('–í–∞—à –¥–æ—Å—Ç—É–ø –∫ Big TeleSales');
            const body = encodeURIComponent(`–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!\n\n–í–∞—à –¥–æ—Å—Ç—É–ø –∫ Big TeleSales:\n–õ–æ–≥–∏–Ω: ${email}\n–ü–∞—Ä–æ–ª—å: ${pass}\n\n–°—Å—ã–ª–∫–∞: ${location.href}`);
            location.href = `mailto:${email}?subject=${subject}&body=${body}`;
          });
          const ok = await okPromise;
          if (ok){
            const email = c.querySelector('#email').value.trim().toLowerCase();
            const roleVal = String(c.querySelector('#role').value || '').trim().toLowerCase();
            // –í–∞–∂–Ω–æ: value —É select = "operator" | "admin". –†–∞–Ω–µ–µ —Å—Ä–∞–≤–Ω–∏–≤–∞–ª–∏ —Å —Ç–µ–∫—Å—Ç–æ–º "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä", –∏–∑-–∑–∞ —á–µ–≥–æ –≤—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–≤–∞–ª—Å—è operator.
            const role = (roleVal === 'admin' || roleVal === '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä') ? 'admin' : 'operator';
            if (!email) return Utils.showToast('–£–∫–∞–∂–∏—Ç–µ email', 'warning');
            const password = generated || Utils.generatePassword(10);
            try {
              await Storage.add('users', { email, role, password, createdAt: Date.now() });
              try { await window.ActivityLog?.logActivity?.(window.ActivityLog.LOG_ACTIONS.USER_CREATED, 'users', null, { email, role }); } catch(_){ }
              Utils.showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω', 'success');
              await renderUsers();
            }
            catch(e){ Utils.showToast('–û—à–∏–±–∫–∞: –≤–æ–∑–º–æ–∂–Ω–æ, email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è', 'error'); }
          }
        });

        document.getElementById('resetAdminBtn').addEventListener('click', async () => {
          const u = await Storage.getByIndex('users', 'by_email', 'admin@bigtelesales.local');
          if (!u) { await Storage.add('users', { email: 'admin@bigtelesales.local', password: 'admin123', role: 'admin', createdAt: Date.now() }); }
          else { u.password = 'admin123'; await Storage.put('users', u); }
          Utils.showToast('–ü–∞—Ä–æ–ª—å admin —Å–±—Ä–æ—à–µ–Ω', 'success');
        });
        usersTbody.addEventListener('click', async (e) => {
          const btn = e.target.closest('button[data-action]'); if (!btn) return;
          const id = Number(btn.getAttribute('data-id')); const action = btn.getAttribute('data-action');
          const user = await Storage.get('users', id); if (!user) return;

          if (action === 'viewpass'){
            const c = document.createElement('div');
            c.innerHTML = `
              <div class="space-y-2">
                <div class="text-sm text-gray-600">Email: <b>${user.email}</b></div>
                <div class="text-sm text-gray-600">–†–æ–ª—å: <b>${user.role}</b></div>
                <div class="border rounded-lg p-3 bg-gray-50">
                  <div class="text-xs text-gray-500 mb-1">–ü–∞—Ä–æ–ª—å</div>
                  <div class="flex items-center gap-2">
                    <input class="flex-1 border rounded-lg px-3 py-2" value="${String(user.password||'')}" readonly />
                    <button id="copyUserPassBtn" class="border px-3 py-2 rounded-lg text-sm hover:bg-gray-50" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å"><i class="bi bi-clipboard"></i></button>
                  </div>
                </div>
                <div class="text-xs text-gray-500">–í–Ω–∏–º–∞–Ω–∏–µ: –ø–∞—Ä–æ–ª–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (IndexedDB) –∏ –¥–æ—Å—Ç—É–ø–Ω—ã –∞–¥–º–∏–Ω—É.</div>
              </div>
            `;
            // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
            Utils.showModal('–ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', c, [{ label:'–ó–∞–∫—Ä—ã—Ç—å', value:false, class:'bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg' }]);
            // –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
            c.querySelector('#copyUserPassBtn')?.addEventListener('click', async (ev)=>{
              ev.preventDefault();
              await Utils.copyToClipboard(String(user.password||''));
            });
          } else if (action === 'pass'){
            const newPass = Utils.generatePassword(10); user.password = newPass; await Storage.put('users', user);
            Utils.showToast('–ü–∞—Ä–æ–ª—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
            await Utils.copyToClipboard(newPass);
          } else if (action === 'delete'){
            const sess = Storage.getSession();
            if (sess && sess.userId === id) return Utils.showToast('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'warning');
            await Storage.del('users', id);
            Utils.showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω', 'info');
            await renderUsers();
          }
        });

        /**
         * –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –Ω–∞–ª–∏—á–∏–µ XLSX –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π, –≥–¥–µ –æ–Ω —Å—Ç—Ä–æ–≥–æ –Ω—É–∂–µ–Ω.
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–µ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –∞–¥–º–∏–Ω–∫—É).
         * @returns {Promise<boolean>}
         */
        async function requireXLSX(){
          const ok = await XLSXLoader.ensure().catch(()=>false);
          if (!ok || typeof XLSX === 'undefined' || !XLSX?.utils){
            Utils.showToast('Excel-—Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ XLSX –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç/–±–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫–∏.', 'error');
            return false;
          }
          return true;
        }

        /**
         * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ Excel –≤ –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤.
         * –ü–æ–¥–¥–µ—Ä–∂–∫–∞:
         * - .xlsx —á–µ—Ä–µ–∑ SheetJS
         * - .xls (BIFF) —á–µ—Ä–µ–∑ SheetJS
         * - .xls SpreadsheetML 2003 (XML) —á–µ—Ä–µ–∑ Utils.parseSpreadsheetML (fallback)
         *
         * @param {File} file
         * @returns {Promise<Array<Object>>}
         */
        async function readExcelToJson(file){
          const name = String(file?.name||'').toLowerCase().trim();
          const isXlsx = name.endsWith('.xlsx');
          const isXls = name.endsWith('.xls');
          if (!isXlsx && !isXls){
            throw new Error('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã Excel: .xlsx –∏–ª–∏ .xls');
          }

          // –ü—ã—Ç–∞–µ–º—Å—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–ª–∏—á–∏–µ XLSX
          const ok = await (typeof XLSXLoader !== 'undefined' ? XLSXLoader.ensure().catch(()=>false) : Promise.resolve(typeof XLSX !== 'undefined'));

          // –ï—Å–ª–∏ XLSX –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è, –Ω–æ —Ñ–∞–π–ª .xls –º–æ–∂–µ—Ç –±—ã—Ç—å SpreadsheetML (XML) ‚Äî –ø—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å
          if (!ok || typeof XLSX === 'undefined' || !XLSX.read || !XLSX.utils){
            if (isXls){
              try {
                const text = await file.text();
                const parsed = Utils.parseSpreadsheetML(text);
                if (parsed && parsed.length) return parsed;
              } catch(_){ }
            }
            throw new Error('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ XLSX –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
          }

          // –û—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å: SheetJS —á–∏—Ç–∞–µ—Ç –∏ .xlsx, –∏ .xls
          try {
            const data = await file.arrayBuffer();
            const wb = XLSX.read(data, { type:'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            return XLSX.utils.sheet_to_json(ws, { defval:'' });
          } catch (e){
            // Fallback: –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ .xls –±—ã–≤–∞—é—Ç SpreadsheetML (XML)
            if (isXls){
              try {
                const text = await file.text();
                const parsed = Utils.parseSpreadsheetML(text);
                if (parsed && parsed.length) return parsed;
              } catch(_){ }
            }
            throw e;
          }
        }

        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—á–µ—Ç—á–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –∞–¥–º–∏–Ω–∫–µ.
         */
        async function refreshAdminCounts(){
          try {
            const [prods, outlets, contacts, promos, routes] = await Promise.all([
              Storage.getAll('products').catch(()=>[]),
              Storage.getAll('outlets').catch(()=>[]),
              Storage.getAll('contacts').catch(()=>[]),
              Storage.getAll('promos').catch(()=>[]),
              Storage.getAll('routes').catch(()=>[])
            ]);
            const prodCountEl = document.getElementById('prodCount');
            const outCountEl = document.getElementById('outCount');
            const contCountEl = document.getElementById('contCount');
            const routesCountEl = document.getElementById('routesCount');
            if (prodCountEl) prodCountEl.textContent = String(prods.length);
            if (outCountEl) outCountEl.textContent = String(outlets.length);
            if (contCountEl) contCountEl.textContent = String(contacts.length);
            if (routesCountEl) routesCountEl.textContent = String(routes.length);
            // promoCount –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ refreshPromoCount
          } catch(e){
            console.warn('refreshAdminCounts error', e);
          }
        }

        /**
         * –°–∫–∞—á–∏–≤–∞–Ω–∏–µ Excel-—à–∞–±–ª–æ–Ω–∞: —Å–Ω–∞—á–∞–ª–∞ .xlsx (SheetJS), –µ—Å–ª–∏ XLSX –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî fallback –Ω–∞ Excel-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π .xls (SpreadsheetML).
         * –í–∞–∂–Ω–æ: fallback ‚Äî —ç—Ç–æ —Ç–æ–∂–µ Excel (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ Microsoft Excel), –±–µ–∑ CSV.
         * @param {string[]} headers
         * @param {string} sheetName
         * @param {string} fileBaseName - –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
         * @param {Array<Array<any>>} [exampleRows]
         */
        async function downloadExcelTemplate(headers, sheetName, fileBaseName, exampleRows = []){
          const ok = await XLSXLoader.ensure().catch(()=>false);
          if (ok && typeof XLSX !== 'undefined' && XLSX?.utils?.aoa_to_sheet){
            const ws = XLSX.utils.aoa_to_sheet([headers, ...exampleRows]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            Utils.saveWorkbookXLSX(wb, fileBaseName + '.xlsx');
            return;
          }
          // Fallback: SpreadsheetML 2003 (.xls)
          const xml = Utils.buildExcelXmlTable(headers, exampleRows, sheetName);
          Utils.downloadFile(fileBaseName + '.xls', xml, 'application/vnd.ms-excel');
          Utils.showToast('XLSX –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —Å–∫–∞—á–∞–Ω Excel .xls (—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç)', 'warning');
        }

        // --- –ò–º–ø–æ—Ä—Ç/—ç–∫—Å–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä–æ–≤ (Excel) ---
        const prodSpinner = document.getElementById('prodSpinner');
        const prodProgWrap = document.getElementById('prodProgressWrap');
        const prodProg = document.getElementById('prodProgress');
        const updateProdProgress = (p)=>{ prodProgWrap.classList.remove('hidden'); prodProg.style.width = Math.min(100, Math.max(0, p)) + '%'; if (p>=100) setTimeout(()=>prodProgWrap.classList.add('hidden'), 600); };

        document.getElementById('prodTemplateBtn').addEventListener('click', async ()=>{
          const headers = ['–ê—Ä—Ç–∏–∫—É–ª','–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞','–ü–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ','–û–ø–∏—Å–∞–Ω–∏–µ','–ü–æ—Å—Ç–∞–≤—â–∏–∫','–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å','–ö–∞—Ç–µ–≥–æ—Ä–∏—è','–°—É–±–∫–∞—Ç–µ–≥–æ—Ä–∏—è','–ë—Ä–µ–Ω–¥','–®—Ç—Ä–∏—Ö–∫–æ–¥','–ö–æ–ª-–≤–æ –≤ –∫–æ—Ä–æ–±–∫–µ','–ö–≤–∞–Ω—Ç –æ—Ç–≥—Ä—É–∑–∫–∏','–¶–µ–Ω–∞ –±–µ–∑ –ü–†–û–ú–û','–¶–µ–Ω–∞ —Å –ü–†–û–ú–û','–¢–û–ü –°–ö–Æ (–¥–∞/–Ω–µ—Ç)','–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞'];
          try {
            await downloadExcelTemplate(headers, '–¢–æ–≤–∞—Ä—ã', 'template_products');
          } catch (e){
            console.error('prodTemplateBtn error', e);
            Utils.showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω —Ç–æ–≤–∞—Ä–æ–≤ (Excel).', 'error');
          }
        });
        document.getElementById('prodExportBtn').addEventListener('click', async ()=>{
          try {
            const ok = await requireXLSX();
            if (!ok) return;
            const items = await Storage.getAll('products');
            const headers = ['–ê—Ä—Ç–∏–∫—É–ª','–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞','–ü–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ','–û–ø–∏—Å–∞–Ω–∏–µ','–ü–æ—Å—Ç–∞–≤—â–∏–∫','–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å','–ö–∞—Ç–µ–≥–æ—Ä–∏—è','–°—É–±–∫–∞—Ç–µ–≥–æ—Ä–∏—è','–ë—Ä–µ–Ω–¥','–®—Ç—Ä–∏—Ö–∫–æ–¥','–ö–æ–ª-–≤–æ –≤ –∫–æ—Ä–æ–±–∫–µ','–ö–≤–∞–Ω—Ç –æ—Ç–≥—Ä—É–∑–∫–∏','–¶–µ–Ω–∞ –±–µ–∑ –ü–†–û–ú–û','–¶–µ–Ω–∞ —Å –ü–†–û–ú–û','–¢–û–ü –°–ö–Æ (–¥–∞/–Ω–µ—Ç)','–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞'];
            const rows = items.map(p=>[
              p.sku||'', p.name||'', p.fullName||'', p.description||'', p.vendor||'', p.manufacturer||'', p.category||'', p.subcategory||'', p.brand||'', p.barcode||'', p.unitsInBox||'', p.shipmentQuantum||'', p.priceBase||'', p.pricePromo||'', (p.topSku===true || p.topSku===1 || p.topSku==='1') ? 1 : 0, p.sortOrder||''
            ]);
            const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '–¢–æ–≤–∞—Ä—ã');
            Utils.saveWorkbookXLSX(wb, 'products.xlsx');
            Utils.showToast('–≠–∫—Å–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
          } catch(e){
            console.error('prodExportBtn error', e);
            Utils.showToast('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ —Ç–æ–≤–∞—Ä–æ–≤', 'error');
          }
        });

        document.getElementById('prodImportBtn').addEventListener('click', ()=>{
          const input = document.createElement('input'); input.type='file'; input.accept='.xlsx,.xls';
          input.onchange = async ()=>{
            const file = input.files[0];
            if (!file) return;
            prodSpinner.classList.remove('hidden');
            updateProdProgress(0);
            try{
              const json = await readExcelToJson(file);
              let added=0, updated=0; let idx=0; const total=json.length || 1;
              for (const row of json){
                idx++;
                const sku = String(row['–ê—Ä—Ç–∏–∫—É–ª']||row['–ê—Ä—Ç–∏–∫—É–ª ']||'').trim();
                if (!sku){ updateProdProgress(Math.round(idx/total*100)); continue; }
                const rec = await Storage.get('products', sku).catch(()=>null);
                const prod = {
                  sku,
                  name: row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞']||row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ']||'',
                  fullName: row['–ü–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ']||'',
                  description: row['–û–ø–∏—Å–∞–Ω–∏–µ']||row['–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞']||'',
                  vendor: row['–ü–æ—Å—Ç–∞–≤—â–∏–∫']||'',
                  manufacturer: row['–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å']||'',
                  category: row['–ö–∞—Ç–µ–≥–æ—Ä–∏—è']||'',
                  subcategory: row['–°—É–±–∫–∞—Ç–µ–≥–æ—Ä–∏—è']||'',
                  brand: row['–ë—Ä–µ–Ω–¥']||'',
                  barcode: (()=>{
                    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ "–®—Ç—Ä–∏—Ö–∫–æ–¥" —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ –ø—Ä–æ–±–µ–ª–∞–º–∏/–≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏
                    let raw = (row['–®—Ç—Ä–∏—Ö–∫–æ–¥'] ?? row['–®—Ç—Ä–∏—Ö–∫–æ–¥ '] ?? row['–®–ö'] ?? row['Barcode'] ?? row['barcode']);
                    if (raw === undefined){
                      const key = Object.keys(row||{}).find(k => String(k||'').trim().toLowerCase() === '—à—Ç—Ä–∏—Ö–∫–æ–¥');
                      if (key) raw = row[key];
                    }
                    return String(raw ?? '').trim();
                  })(),
                  unitsInBox: Number(String((row['–ö–æ–ª-–≤–æ –≤ –∫–æ—Ä–æ–±–∫–µ'] ?? row['–ö–æ–ª-–≤–æ –≤ –∫–æ—Ä–æ–±–∫–µ '] ?? 0)).toString().replace(',','.')) || 0,
                  shipmentQuantum: Number(String((row['–ö–≤–∞–Ω—Ç –æ—Ç–≥—Ä—É–∑–∫–∏'] ?? 0)).toString().replace(',','.')) || 0,
                  priceBase: Number(String((row['–¶–µ–Ω–∞ –±–µ–∑ –ü–†–û–ú–û'] ?? 0)).toString().replace(',','.')) || 0,
                  pricePromo: Number(String((row['–¶–µ–Ω–∞ —Å –ü–†–û–ú–û'] ?? 0)).toString().replace(',','.')) || 0,
                  topSku: (()=>{
                    // –í–∞–∂–Ω–æ: –≤ Excel –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏–Ω–æ–≥–¥–∞ –∏–º–µ—é—Ç –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã. –ò—â–µ–º –∫–æ–ª–æ–Ω–∫—É –¢–û–ü –°–ö–Æ –ø–æ trim().
                    let raw = (row['–¢–û–ü –°–ö–Æ (–¥–∞/–Ω–µ—Ç)'] ?? row['–¢–û–ü –°–ö–Æ'] ?? row['TOP SKU']);
                    if (raw === undefined){
                      const key = Object.keys(row||{}).find(k => {
                        const nk = String(k||'').trim().toLowerCase();
                        return nk === '—Ç–æ–ø —Å–∫—é (–¥–∞/–Ω–µ—Ç)' || nk === '—Ç–æ–ø —Å–∫—é' || nk === 'top sku';
                      });
                      if (key) raw = row[key];
                    }
                    const s = String(raw ?? '').trim().toLowerCase();
                    const isTop = (raw === true) || (raw === 1) || (s === '1') || (s === '–¥–∞') || (s === 'true') || (s === 'yes') || (s === 'y') || (s === 'x');
                    return isTop ? 1 : 0;
                  })(),
                  sortOrder: Number(String((row['–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞'] ?? 0)).toString().replace(',','.')) || 0
                };
                if (rec){ await Storage.put('products', {...rec, ...prod}); updated++; }
                else { await Storage.put('products', prod); added++; }
                updateProdProgress(Math.round(idx/total*100));
              }
              Utils.showToast(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${added} —Ç–æ–≤–∞—Ä–æ–≤, –æ–±–Ω–æ–≤–ª–µ–Ω–æ ${updated}`, 'success');
              AnalyticsPrecalc.invalidate();
              await refreshAdminCounts();
            } catch(e){
              console.error('prodImportBtn error', e);
              Utils.showToast(String(e?.message||'–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ —Ç–æ–≤–∞—Ä–æ–≤') + '. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ .xlsx –∏–ª–∏ .xls –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å —à–∞–±–ª–æ–Ω–æ–º.', 'error');
            } finally {
              prodSpinner.classList.add('hidden');
              setTimeout(()=>updateProdProgress(100), 80);
            }
          };
          input.click();
        });
        document.getElementById('prodClearBtn').addEventListener('click', async ()=>{
          const ok = await Utils.showModal('–û—á–∏—Å—Ç–∫–∞', '–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã?', [
            {label:'–û—Ç–º–µ–Ω–∞', value:false, class:'border px-3 py-1.5 rounded-lg hover:bg-gray-50'},
            {label:'–û—á–∏—Å—Ç–∏—Ç—å', value:true, class:'bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg'}
          ]);
          if (ok){
            await Storage.clearStore('products');
            await refreshAdminCounts();
            Utils.showToast('–¢–æ–≤–∞—Ä—ã –æ—á–∏—â–µ–Ω—ã', 'info');
          }
        });

        // --- –ò–º–ø–æ—Ä—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ---
        const imgBtn = document.getElementById('imgSelectBtn');
        const imgInput = document.getElementById('imgFiles');
        const imgSpinner = document.getElementById('imgSpinner');
        const imgProgWrap = document.getElementById('imgProgressWrap');
        const imgProg = document.getElementById('imgProgress');
        const imgSummary = document.getElementById('imgSummary');
        const updateImgProgress = (p)=>{ imgProgWrap.classList.remove('hidden'); imgProg.style.width = Math.min(100, Math.max(0, p)) + '%'; if (p>=100) setTimeout(()=>imgProgWrap.classList.add('hidden'), 600); };

        imgBtn.addEventListener('click', ()=> imgInput.click());
        imgInput.addEventListener('change', async ()=>{
          const files = Array.from(imgInput.files||[]);
          if (!files.length) return;

          imgSpinner.classList.remove('hidden');
          updateImgProgress(0);
          imgSummary.textContent='';

          // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ) ‚Äî —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –≥–æ–Ω–æ–∫ –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ
          const metas = files.map(f=>{
            const name = String(f.name||'');
            const skuCandidate = name
              .replace(/\.[^.]+$/, '')      // —É–±—Ä–∞—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
              .replace(/\(\d+\)$/,'')     // —É–±—Ä–∞—Ç—å —Å—É—Ñ—Ñ–∏–∫—Å (n)
              .trim();
            const isAdditional = /\(\d+\)\.[^.]+$/i.test(name);
            return { file: f, skuCandidate, isAdditional };
          });

          // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø–æ skuCandidate –∑–∞—Ä–∞–Ω–µ–µ
          const bySku = new Map();
          for (const m of metas){
            if (!bySku.has(m.skuCandidate)) bySku.set(m.skuCandidate, { main:null, extras:[] });
          }

          // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å –ª–∏–º–∏—Ç–æ–º (—É—Å–∫–æ—Ä—è–µ—Ç –∏–º–ø–æ—Ä—Ç –±–æ–ª—å—à–∏—Ö –ø–∞—á–µ–∫)
          const concurrency = Math.min(4, Math.max(2, Math.floor((navigator.hardwareConcurrency||8)/2)));
          let processed = 0;

          await mapLimit(metas, concurrency, async (m)=>{
            const base64 = await resizeToBase64Fast(m.file, 800, 800);
            const entry = bySku.get(m.skuCandidate);
            if (!entry) return;
            if (m.isAdditional) entry.extras.push(base64);
            else entry.main = base64;
            processed++;
            updateImgProgress(Math.round(processed/files.length*100));
          });

          // persist into productImages by SKU or by barcode mapping
          const prods = await Storage.getAll('products');
          const barcodeToSku = new Map(prods.map(p => [String(p.barcode||'').trim(), p.sku]));
          let photosSaved=0; let itemsTouched=0;

          for (const [key, val] of bySku){
            // key –∑–¥–µ—Å—å –æ–±—ã—á–Ω–æ —É–∂–µ –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è, –Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º
            const normalizedKey = String(key||'').trim().replace(/\.(jpe?g|png|webp)$/i, '');
            let sku = normalizedKey;

            // –°–ø–µ—Ü-–∫–µ–π—Å: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ-–∑–∞–≥–ª—É—à–∫–∞ 1111111111.* –¥–æ–ª–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤—Å–µ–≥–¥–∞
            // –¥–∞–∂–µ –µ—Å–ª–∏ –≤ —Ç–æ–≤–∞—Ä–∞—Ö –Ω–µ—Ç SKU/—à—Ç—Ä–∏—Ö–∫–æ–¥–∞ 1111111111.
            if (normalizedKey === '1111111111'){
              sku = '1111111111';
            } else {
              // –û–±—ã—á–Ω–∞—è –ª–æ–≥–∏–∫–∞: –µ—Å–ª–∏ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–∞ —Å —Ç–∞–∫–∏–º SKU ‚Äî –ø—Ä–æ–±—É–µ–º —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É
              if (!prods.find(p=>p.sku===sku)){
                const mapped = barcodeToSku.get(normalizedKey) || barcodeToSku.get(String(key||'').trim());
                if (mapped) sku = mapped; else continue;
              }
            }

            const images = [];
            if (val.main) images.push(val.main);
            images.push(...val.extras);
            if (images.length){
              // 1) –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –∫–ª—é—á—É (SKU)
              await Storage.put('productImages', { sku, images });

              // 2) –î–ª—è –∑–∞–≥–ª—É—à–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º alias-–∫–ª—é—á —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º
              //    (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –≤ –∫–æ–¥–µ/–∫—ç—à–µ –∏—â—É—Ç –∏–º–µ–Ω–Ω–æ '1111111111.jpg')
              if (sku === '1111111111'){
                try { await Storage.put('productImages', { sku: '1111111111.jpg', images }); } catch(_){ }
              }

              photosSaved += images.length;
              itemsTouched++;
            }
          }

          imgSummary.textContent = `–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${photosSaved} —Ñ–æ—Ç–æ –¥–ª—è ${itemsTouched} —Ç–æ–≤–∞—Ä–æ–≤`;
          Utils.showToast('–ò–º–ø–æ—Ä—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω', 'success');
          imgSpinner.classList.add('hidden');
          setTimeout(()=>updateImgProgress(100), 50);
          imgInput.value='';
        });

        /**
         * –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π map —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á.
         * @template T
         * @param {T[]} items
         * @param {number} limit
         * @param {(item:T)=>Promise<void>} worker
         */
        async function mapLimit(items, limit, worker){
          const queue = items.slice();
          const runners = new Array(Math.min(limit, queue.length)).fill(0).map(async ()=>{
            while(queue.length){
              const item = queue.shift();
              try { await worker(item); } catch(e){ console.warn('mapLimit worker error', e); }
            }
          });
          await Promise.all(runners);
        }

        /**
         * –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—Å–∞–π–∑/—Å–∂–∞—Ç–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–π.
         * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç createImageBitmap (–±—ã—Å—Ç—Ä–µ–µ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ <img>), –∑–∞—Ç–µ–º toBlob/convertToBlob.
         * @param {File} file
         * @param {number} maxW
         * @param {number} maxH
         * @returns {Promise<string>} dataURL
         */
        async function resizeToBase64Fast(file, maxW, maxH){
          // 1) –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ createImageBitmap (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
          if (typeof createImageBitmap === 'function'){
            let bmp = null;
            try {
              bmp = await createImageBitmap(file, { imageOrientation: 'from-image' });
            } catch(_){
              try { bmp = await createImageBitmap(file); } catch(__){}
            }
            if (bmp){
              try {
                let w = bmp.width;
                let h = bmp.height;
                const ratio = Math.min(maxW/w, maxH/h, 1);
                w = Math.max(1, Math.round(w * ratio));
                h = Math.max(1, Math.round(h * ratio));

                // OffscreenCanvas –±—ã—Å—Ç—Ä–µ–µ –∏ –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç DOM
                const canvas = (typeof OffscreenCanvas !== 'undefined') ? new OffscreenCanvas(w, h) : document.createElement('canvas');
                canvas.width = w;
                canvas.height = h;
                const ctx = canvas.getContext('2d', { alpha: false });
                ctx.drawImage(bmp, 0, 0, w, h);

                // convertToBlob (OffscreenCanvas) / toBlob (HTMLCanvas)
                let blob;
                if (canvas.convertToBlob){
                  blob = await canvas.convertToBlob({ type:'image/jpeg', quality: 0.82 });
                } else {
                  blob = await new Promise((resolve)=>{
                    canvas.toBlob((b)=>resolve(b), 'image/jpeg', 0.82);
                  });
                }
                if (bmp.close) try { bmp.close(); } catch(_){ }
                if (!blob) return await fallbackResizeToDataURL(file, maxW, maxH);
                return await blobToDataURL(blob);
              } catch(e){
                try { if (bmp.close) bmp.close(); } catch(_){ }
                return await fallbackResizeToDataURL(file, maxW, maxH);
              }
            }
          }

          // 2) –§–æ–ª–±—ç–∫: —Å—Ç–∞—Ä—ã–π –ø—É—Ç—å —á–µ—Ä–µ–∑ <img> (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
          return await fallbackResizeToDataURL(file, maxW, maxH);
        }

        /**
         * –§–æ–ª–±—ç–∫-—Ä–µ—Å–∞–π–∑ —á–µ—Ä–µ–∑ <img> + canvas.toDataURL.
         * @param {File} file
         * @param {number} maxW
         * @param {number} maxH
         */
        async function fallbackResizeToDataURL(file, maxW, maxH){
          const img = document.createElement('img');
          const dataUrl = await fileToDataURL(file);
          await new Promise(res=>{ img.onload=res; img.src=dataUrl; });
          let {width:w, height:h} = img;
          const ratio = Math.min(maxW/w, maxH/h, 1);
          w=Math.max(1, Math.round(w*ratio));
          h=Math.max(1, Math.round(h*ratio));
          const canvas = document.createElement('canvas');
          canvas.width=w;
          canvas.height=h;
          const ctx=canvas.getContext('2d');
          ctx.drawImage(img,0,0,w,h);
          return canvas.toDataURL('image/jpeg', 0.82);
        }

        /**
         * @param {Blob} blob
         * @returns {Promise<string>}
         */
        function blobToDataURL(blob){
          return new Promise((res, rej)=>{
            const r = new FileReader();
            r.onload = ()=>res(String(r.result||''));
            r.onerror = ()=>rej(r.error || new Error('blobToDataURL error'));
            r.readAsDataURL(blob);
          });
        }

        /**
         * @param {File} file
         * @returns {Promise<string>}
         */
        function fileToDataURL(file){
          return new Promise((res, rej)=>{
            const r=new FileReader();
            r.onload=()=>res(String(r.result||''));
            r.onerror=()=>rej(r.error || new Error('fileToDataURL error'));
            r.readAsDataURL(file);
          });
        }

        // --- –¢–æ—Ä–≥–æ–≤—ã–µ —Ç–æ—á–∫–∏ ---
        // –°—á–µ—Ç—á–∏–∫ —Ç–æ—á–µ–∫ –æ–±–Ω–æ–≤–ª—è–µ–º —á–µ—Ä–µ–∑ refreshAdminCounts()
        await refreshAdminCounts();

        document.getElementById('outTemplateBtn').addEventListener('click', async ()=>{
          const headers = ['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂','–ö–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞','–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ','–ò–ù–ù','–ê–¥—Ä–µ—Å','–£—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã','–ö—Ä–µ–¥–∏—Ç–Ω—ã–π –ª–∏–º–∏—Ç','–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å'];
          try {
            await downloadExcelTemplate(headers, '–¢–æ—á–∫–∏', 'template_outlets');
          } catch (e){
            console.error('outTemplateBtn error', e);
            Utils.showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω —Ç–æ—á–µ–∫ (Excel).', 'error');
          }
        });
        const outSpinner = document.getElementById('outSpinner');
        const outProgWrap = document.getElementById('outProgressWrap');
        const outProg = document.getElementById('outProgress');
        const updateOutProgress = (p)=>{ outProgWrap.classList.remove('hidden'); outProg.style.width = Math.min(100, Math.max(0, p)) + '%'; if (p>=100) setTimeout(()=>outProgWrap.classList.add('hidden'), 600); };

        document.getElementById('outExportBtn').addEventListener('click', async ()=>{
          try {
            const ok = await requireXLSX();
            if (!ok) return;
            const items = await Storage.getAll('outlets');
            const headers = ['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂','–ö–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞','–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ','–ò–ù–ù','–ê–¥—Ä–µ—Å','–£—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã','–ö—Ä–µ–¥–∏—Ç–Ω—ã–π –ª–∏–º–∏—Ç','–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å'];
            const rows = items.map(o=>[o.direction||'', o.code||'', o.name||'', o.inn||'', o.address||'', o.paymentTerms||'', o.creditLimit||'', o.debt||'']);
            const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '–¢–æ—á–∫–∏');
            Utils.saveWorkbookXLSX(wb, 'outlets.xlsx');
            Utils.showToast('–≠–∫—Å–ø–æ—Ä—Ç —Ç–æ—á–µ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
          } catch(e){
            console.error('outExportBtn error', e);
            Utils.showToast('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ —Ç–æ—á–µ–∫', 'error');
          }
        });

        document.getElementById('outImportBtn').addEventListener('click', ()=>{
          const input = document.createElement('input'); input.type='file'; input.accept='.xlsx,.xls';
          input.onchange = async ()=>{
            const file = input.files[0];
            if (!file) return;
            outSpinner.classList.remove('hidden');
            updateOutProgress(0);
            try{
              const json = await readExcelToJson(file);
              let idx=0; const total=json.length||1; let count=0;
              for (const row of json){
                idx++;
                const code = String(row['–ö–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞']||row['–ö–æ–¥ —Ç–æ—á–∫–∏']||'').trim();
                if (!code){ updateOutProgress(Math.round(idx/total*100)); continue; }
                const outlet = {
                  code,
                  direction: row['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂']||row['–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ']||'',
                  name: row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ']||row['–ù–∞–∑–≤–∞–Ω–∏–µ']||'',
                  inn: String(row['–ò–ù–ù']||'').trim(),
                  address: row['–ê–¥—Ä–µ—Å']||'',
                  paymentTerms: row['–£—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã']||row['–§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã']||'',
                  creditLimit: row['–ö—Ä–µ–¥–∏—Ç–Ω—ã–π –ª–∏–º–∏—Ç']||'',
                  debt: row['–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å']||''
                };
                await Storage.put('outlets', outlet);
                count++;
                updateOutProgress(Math.round(idx/total*100));
              }
              Utils.showToast(`–ò–º–ø–æ—Ä—Ç —Ç–æ—á–µ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω: ${count}`, 'success');
              AnalyticsPrecalc.invalidate();
              await refreshAdminCounts();
            } catch(e){
              console.error('outImportBtn error', e);
              Utils.showToast(String(e?.message||'–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ —Ç–æ—á–µ–∫') + '. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ .xlsx –∏–ª–∏ .xls –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å —à–∞–±–ª–æ–Ω–æ–º.', 'error');
            } finally {
              outSpinner.classList.add('hidden');
              setTimeout(()=>updateOutProgress(100), 80);
            }
          };
          input.click();
        });
        document.getElementById('outClearBtn').addEventListener('click', async ()=>{
          const ok = await Utils.showModal('–û—á–∏—Å—Ç–∫–∞', '–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–æ—á–∫–∏?', [
            {label:'–û—Ç–º–µ–Ω–∞', value:false, class:'border px-3 py-1.5 rounded-lg hover:bg-gray-50'},
            {label:'–û—á–∏—Å—Ç–∏—Ç—å', value:true, class:'bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg'}
          ]);
          if (ok){
            await Storage.clearStore('outlets');
            await refreshAdminCounts();
            Utils.showToast('–¢–æ—á–∫–∏ –æ—á–∏—â–µ–Ω—ã', 'info');
          }
        });

        // --- –ö–æ–Ω—Ç–∞–∫—Ç—ã ---
        document.getElementById('contTemplateBtn').addEventListener('click', async ()=>{
          const headers = ['–ö–æ–¥ —Ç–æ—á–∫–∏','–§–ò–û','–¢–µ–ª–µ—Ñ–æ–Ω'];
          try {
            await downloadExcelTemplate(headers, '–ö–æ–Ω—Ç–∞–∫—Ç—ã', 'template_contacts');
          } catch (e){
            console.error('contTemplateBtn error', e);
            Utils.showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ (Excel).', 'error');
          }
        });
        const contSpinner = document.getElementById('contSpinner');
        const contProgWrap = document.getElementById('contProgressWrap');
        const contProg = document.getElementById('contProgress');
        const updateContProgress = (p)=>{ contProgWrap.classList.remove('hidden'); contProg.style.width = Math.min(100, Math.max(0, p)) + '%'; if (p>=100) setTimeout(()=>contProgWrap.classList.add('hidden'), 600); };

        document.getElementById('contImportBtn').addEventListener('click', ()=>{
          const input = document.createElement('input'); input.type='file'; input.accept='.xlsx,.xls';
          input.onchange = async ()=>{
            const file = input.files[0];
            if (!file) return;
            contSpinner.classList.remove('hidden');
            updateContProgress(0);
            try{
              const json = await readExcelToJson(file);
              const byCode = new Map();
              let idx=0; const total=json.length||1;
              for (const row of json){
                idx++;
                const code = String(row['–ö–æ–¥ —Ç–æ—á–∫–∏']||row['–ö–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞']||'').trim();
                if (!code){ updateContProgress(Math.round(idx/total*100)); continue; }
                const contact = { name: row['–§–ò–û']||row['–ö–æ–Ω—Ç–∞–∫—Ç']||'', phone: row['–¢–µ–ª–µ—Ñ–æ–Ω']||row['–¢–µ–ª.']||'' };
                if (!byCode.has(code)) byCode.set(code, []);
                byCode.get(code).push(contact);
                updateContProgress(Math.round(idx/total*100));
              }
              for (const [code, arr] of byCode){
                await Storage.put('contacts', { code, list: arr });
              }
              Utils.showToast(`–ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω: —Ç–æ—á–µ–∫ ${byCode.size}`, 'success');
              await refreshAdminCounts();
            } catch(e){
              console.error('contImportBtn error', e);
              Utils.showToast(String(e?.message||'–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤') + '. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ .xlsx –∏–ª–∏ .xls –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å —à–∞–±–ª–æ–Ω–æ–º.', 'error');
            } finally {
              contSpinner.classList.add('hidden');
              setTimeout(()=>updateContProgress(100), 80);
            }
          };
          input.click();
        });
        document.getElementById('contClearBtn').addEventListener('click', async ()=>{
          const ok = await Utils.showModal('–û—á–∏—Å—Ç–∫–∞', '–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã?', [
            {label:'–û—Ç–º–µ–Ω–∞', value:false, class:'border px-3 py-1.5 rounded-lg hover:bg-gray-50'},
            {label:'–û—á–∏—Å—Ç–∏—Ç—å', value:true, class:'bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg'}
          ]);
          if (ok){
            await Storage.clearStore('contacts');
            await refreshAdminCounts();
            Utils.showToast('–ö–æ–Ω—Ç–∞–∫—Ç—ã –æ—á–∏—â–µ–Ω—ã', 'info');
          }
        });

        // --- PROMO ---
        const promoCountEl = document.getElementById('promoCount');
        const promoSpinner = document.getElementById('promoSpinner');
        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—á–µ—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏–π (–∏–∑ IndexedDB.promos).
         */
        async function refreshPromoCount(){
          const all = await Storage.getAll('promos').catch(()=>[]);
          const active = PromoEngine.getActive(all);
          promoCountEl.textContent = String(active.length);
        }
        await refreshPromoCount();

        function excelDateToJSDate(n){ // rough conversion (days since 1899-12-30)
          if (!isFinite(n)) return null; const ms = Math.round((Number(n) - 25569) * 86400 * 1000); const d=new Date(ms); return isNaN(d)? null : d; }
        function parseMaybeDate(v){ if (!v) return null; if (typeof v==='number') return excelDateToJSDate(v); const s=String(v).trim(); const m=s.match(/(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})/); if (m){ const dd=+m[1], mm=+m[2]-1, yy=+m[3]<100?2000+ +m[3]:+m[3]; return new Date(yy,mm,dd); } const d=new Date(s); return isNaN(d)? null : d; }

        document.getElementById('promoTemplateBtn').addEventListener('click', async ()=>{
          const headers = ['ID –∞–∫—Ü–∏–∏','–ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫—Ü–∏–∏','–¢–∏–ø','–£—Å–ª–æ–≤–∏–µ','–®—Ç—Ä–∏—Ö–∫–æ–¥—ã —Ç–æ–≤–∞—Ä–æ–≤','–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–∂–¥–æ–≥–æ','–°–∫–∏–¥–∫–∞ %','–ê–∫—Ç–∏–≤–Ω–∞ (–¥–∞/–Ω–µ—Ç)','–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞','–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è','–û–±–ª–æ–∂–∫–∞ (URL)'];
          // –ü—Ä–∏–º–µ—Ä—ã –∏–∑ ¬´–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –ü–†–û–ú–û¬ª
          const exampleRows = [
            ['PR-001', '–ì–æ—Ä—è—á–∏–π –∫–æ—Ñ–µ ‚Äî –∫—É–ø–∏ 2 –∏ –ø–æ–ª—É—á–∏ —Å–∫–∏–¥–∫—É', '–∫—É–ø–∏_–ø–æ–ª—É—á–∏', '', '4601234567890', '2', '10', '–¥–∞', '2025-01-01', '2025-01-31', 'https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?w=800&q=80'],
            ['PR-002', '–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ —Å–∫–∏–¥–∫–∏ ‚Äî –Ω–∞–±–æ—Ä', '–Ω–∞–±–æ—Ä', '', '4601234567890;4600987654321', '1;2', '7', '–¥–∞', '2025-02-01', '2025-02-28', 'https://images.unsplash.com/photo-1557683316-973673baf926?w=800&q=80']
          ];
          try {
            await downloadExcelTemplate(headers, '–ü–†–û–ú–û', 'template_promos', exampleRows);
          } catch (e){
            console.error('promoTemplateBtn error', e);
            Utils.showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω –ü–†–û–ú–û (Excel).', 'error');
          }
        });
        document.getElementById('promoImportBtn').addEventListener('click', ()=>{
          const input=document.createElement('input'); input.type='file'; input.accept='.xlsx,.xls';
          input.onchange = async ()=>{
            const file=input.files[0];
            if(!file) return;
            promoSpinner.classList.remove('hidden');
            try{
              const json = await readExcelToJson(file);
              let imported = 0;

              // –•–µ–ª–ø–µ—Ä: –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –ø–æ –∏–º–µ–Ω–∏ (–±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞/–ø—Ä–æ–±–µ–ª–æ–≤)
              const cellBy = (row, name) => {
                const target = String(name||'').trim().toLowerCase();
                const key = Object.keys(row||{}).find(k => String(k||'').trim().toLowerCase() === target);
                return key ? row[key] : row[name];
              };

              for(const row of json){
                const id=String(row['ID –∞–∫—Ü–∏–∏']||row['ID']||'').trim() || Utils.generateId('promo');
                const name=row['–ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫—Ü–∏–∏']||row['–ù–∞–∑–≤–∞–Ω–∏–µ']||'';
                const type=String(row['–¢–∏–ø']||'').toLowerCase();

                // –®—Ç—Ä–∏—Ö–∫–æ–¥—ã –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤)
                const itemsRaw=String(row['–®—Ç—Ä–∏—Ö–∫–æ–¥—ã —Ç–æ–≤–∞—Ä–æ–≤']||row['–®—Ç—Ä–∏—Ö–∫–æ–¥—ã']||row['–®—Ç—Ä–∏—Ö–∫–æ–¥']||'').trim();
                const qtyRaw=String(row['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–∂–¥–æ–≥–æ']||row['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ']||'').trim();
                const barcodes=itemsRaw? itemsRaw.split(/[;,]/).map(s=>s.trim()).filter(Boolean):[];
                const qtys=qtyRaw? qtyRaw.split(/[;,]/).map(s=>Number(String(s).trim().replace(',','.')||'0')):[];
                const items=barcodes.map((barcode,idx)=>({ barcode, requiredQty: Number(qtys[idx]||1) }));

                // –ß–∏—Å–ª–æ–≤—ã–µ/—Å—Ç—Ä–æ–∫–æ–≤—ã–µ –ø–æ–ª—è
                const discountPercent=Number(String(row['–°–∫–∏–¥–∫–∞ %']||row['–°–∫–∏–¥–∫–∞']||0).toString().replace(',','.')||0);
                const active = String(row['–ê–∫—Ç–∏–≤–Ω–∞ (–¥–∞/–Ω–µ—Ç)']||row['–ê–∫—Ç–∏–≤–Ω–∞']||'–¥–∞').toLowerCase().includes('–¥–∞');

                // –î–∞—Ç—ã: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤ Excel (—á–∏—Å–ª–æ), —Å—Ç—Ä–æ–∫ (–¥–¥.–º–º.–≥–≥–≥–≥ / ISO), —è—á–µ–µ–∫ —Ç–∏–ø–∞ General/Date
                const startRaw = cellBy(row, '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞');
                const endRaw = cellBy(row, '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è');
                const startDate = parseMaybeDate(startRaw);
                const endDate = parseMaybeDate(endRaw);

                if (!items.length || !type){ continue; }
                await Storage.put('promos', {
                  id,
                  name,
                  type,
                  items,
                  discountPercent,
                  active,
                  startDate: startDate ? startDate.toISOString().slice(0,10) : null,
                  endDate: endDate ? endDate.toISOString().slice(0,10) : null
                });
                imported++;
              }
              // –ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ ‚Äî —Å—á–∏—Ç–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫—Ü–∏–∏ (–Ω–∞ —Å–µ–≥–æ–¥–Ω—è)
              const all = await Storage.getAll('promos').catch(()=>[]);
              const activeNow = PromoEngine.getActive(all).length;
              Utils.showToast(`–ü–†–û–ú–û –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${imported}. –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ–π—á–∞—Å: ${activeNow}`, 'success');
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫ –Ω–∞ –ø–ª–∏—Ç–∫–µ
              await refreshPromoCount();
            } catch(e){
              console.error('promoImportBtn error', e);
              Utils.showToast(String(e?.message||'–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –ü–†–û–ú–û') + '. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ .xlsx –∏–ª–∏ .xls –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å —à–∞–±–ª–æ–Ω–æ–º.', 'error');
            } finally {
              promoSpinner.classList.add('hidden');
            }
          };
          input.click();
        });

        document.getElementById('promoExportBtn').addEventListener('click', async ()=>{
          try {
            const ok = await requireXLSX();
            if (!ok) return;
            const list = await Storage.getAll('promos').catch(()=>[]);
            const headers = ['ID –∞–∫—Ü–∏–∏','–ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫—Ü–∏–∏','–¢–∏–ø','–£—Å–ª–æ–≤–∏–µ','–®—Ç—Ä–∏—Ö–∫–æ–¥—ã —Ç–æ–≤–∞—Ä–æ–≤','–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–∂–¥–æ–≥–æ','–°–∫–∏–¥–∫–∞ %','–ê–∫—Ç–∏–≤–Ω–∞ (–¥–∞/–Ω–µ—Ç)','–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞','–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è'];
            const rows = list.map(p=>[
              p.id||'', p.name||'', p.type||'', '', (p.items||[]).map(i=>i.barcode||i.sku||'').join(';'), (p.items||[]).map(i=>i.requiredQty).join(';'), p.discountPercent||0, p.active!==false?'–¥–∞':'–Ω–µ—Ç', p.startDate||'', p.endDate||''
            ]);
            const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '–ü–†–û–ú–û');
            Utils.saveWorkbookXLSX(wb, 'promos.xlsx');
            Utils.showToast('–≠–∫—Å–ø–æ—Ä—Ç –ü–†–û–ú–û –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
          } catch(e){
            console.error('promoExportBtn error', e);
            Utils.showToast('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –ü–†–û–ú–û', 'error');
          }
        });

        document.getElementById('promoClearBtn').addEventListener('click', async ()=>{
          const ok = await Utils.showModal('–û—á–∏—Å—Ç–∫–∞ –ü–†–û–ú–û', '–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∞–∫—Ü–∏–∏?', [
            {label:'–û—Ç–º–µ–Ω–∞', value:false, class:'border px-3 py-1.5 rounded-lg hover:bg-gray-50'},
            {label:'–û—á–∏—Å—Ç–∏—Ç—å', value:true, class:'bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg'}
          ]);
          if(!ok) return;
          await Storage.clearStore('promos');
          Utils.showToast('–ü–†–û–ú–û –æ—á–∏—â–µ–Ω–æ', 'info');
          await refreshPromoCount();
        });
        document.getElementById('promoHelpBtn').addEventListener('click', async ()=>{
          const c=document.createElement('div');
          c.innerHTML = `
            <div class="text-sm space-y-3">
              <div class="fw-semibold">–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –ü–†–û–ú–û</div>
              <div>
                –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –¥–≤–∞ —Ç–∏–ø–∞ –∞–∫—Ü–∏–π:
                <ul class="list-disc pl-5 mt-1">
                  <li><b>–∫—É–ø–∏_–ø–æ–ª—É—á–∏</b> ‚Äî –∫—É–ø–∏ N —à—Ç—É–∫ –æ–¥–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ (–ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É) ‚Üí —Å–∫–∏–¥–∫–∞ X% –Ω–∞ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä</li>
                  <li><b>–Ω–∞–±–æ—Ä</b> ‚Äî –∫—É–ø–∏ –Ω–∞–±–æ—Ä —Ç–æ–≤–∞—Ä–æ–≤ (–ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞–º) ‚Üí —Å–∫–∏–¥–∫–∞ X% –Ω–∞ –∫–∞–∂–¥—ã–π —Ç–æ–≤–∞—Ä –Ω–∞–±–æ—Ä–∞</li>
                </ul>
              </div>

              <div class="rounded border bg-gray-50 p-2">
                <div class="fw-semibold mb-1">–®–∞–±–ª–æ–Ω Excel (–∫–æ–ª–æ–Ω–∫–∏):</div>
                <div>ID –∞–∫—Ü–∏–∏ | –ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫—Ü–∏–∏ | –¢–∏–ø | –£—Å–ª–æ–≤–∏–µ | <b>–®—Ç—Ä–∏—Ö–∫–æ–¥—ã —Ç–æ–≤–∞—Ä–æ–≤</b> | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–∂–¥–æ–≥–æ | –°–∫–∏–¥–∫–∞ % | –ê–∫—Ç–∏–≤–Ω–∞ (–¥–∞/–Ω–µ—Ç) | –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ | –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</div>
              </div>

              <div class="rounded border p-2">
                <div class="fw-semibold mb-1">–ü—Ä–∏–º–µ—Ä 1 ‚Äî ¬´–∫—É–ø–∏_–ø–æ–ª—É—á–∏¬ª</div>
                <div class="text-muted">–°–∫–∏–¥–∫–∞ 10% –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ 2 —à—Ç. –æ–¥–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞</div>
                <pre class="bg-gray-50 p-2 mt-2 overflow-auto"><code>
ID –∞–∫—Ü–∏–∏           PR-001
–ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫—Ü–∏–∏     –ö—É–ø–∏ 2 ‚Äî —Å–∫–∏–¥–∫–∞ 10%
–¢–∏–ø                –∫—É–ø–∏_–ø–æ–ª—É—á–∏
–£—Å–ª–æ–≤–∏–µ            -
–®—Ç—Ä–∏—Ö–∫–æ–¥—ã —Ç–æ–≤–∞—Ä–æ–≤  4601234567890
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–∂–¥–æ–≥–æ 2
–°–∫–∏–¥–∫–∞ %           10
–ê–∫—Ç–∏–≤–Ω–∞ (–¥–∞/–Ω–µ—Ç)   –¥–∞
–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞        2025-01-01
–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è     2025-01-31
                </code></pre>
              </div>

              <div class="rounded border p-2">
                <div class="fw-semibold mb-1">–ü—Ä–∏–º–µ—Ä 2 ‚Äî ¬´–Ω–∞–±–æ—Ä¬ª (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä–æ–≤)</div>
                <div class="text-muted">–°–∫–∏–¥–∫–∞ 7% –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –Ω–∞–±–æ—Ä–∞ –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤</div>
                <pre class="bg-gray-50 p-2 mt-2 overflow-auto"><code>
ID –∞–∫—Ü–∏–∏           PR-002
–ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫—Ü–∏–∏     –ù–∞–±–æ—Ä ‚Äî —Å–∫–∏–¥–∫–∞ 7%
–¢–∏–ø                –Ω–∞–±–æ—Ä
–£—Å–ª–æ–≤–∏–µ            -
–®—Ç—Ä–∏—Ö–∫–æ–¥—ã —Ç–æ–≤–∞—Ä–æ–≤  4601234567890;4600987654321;4699999999999
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–∂–¥–æ–≥–æ 1;2;1
–°–∫–∏–¥–∫–∞ %           7
–ê–∫—Ç–∏–≤–Ω–∞ (–¥–∞/–Ω–µ—Ç)   –¥–∞
–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞        2025-02-01
–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è     2025-02-28
                </code></pre>
                <div class="text-xs text-gray-500 mt-1">
                  –ö–æ–ª–æ–Ω–∫–∏ ¬´–®—Ç—Ä–∏—Ö–∫–æ–¥—ã —Ç–æ–≤–∞—Ä–æ–≤¬ª –∏ ¬´–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–∂–¥–æ–≥–æ¬ª –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏ —Å–ø–∏—Å–∫–∞–º–∏ —á–µ—Ä–µ–∑ ¬´;¬ª. 
                  –ù–∞–ø—Ä–∏–º–µ—Ä, —Ç—Ä–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ –∏ —Ç—Ä–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞: <code>460...;460...;469...</code> –∏ <code>1;2;1</code>.
                </div>
              </div>

              <div class="rounded border bg-gray-50 p-2">
                <div class="fw-semibold mb-1">–ü—Ä–æ–≤–µ—Ä–∫–∞</div>
                <div>
                  –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω—É ‚Äî –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —É—Å–ª–æ–≤–∏–π —Å–∫–∏–¥–∫–∞ –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. 
                  –í –∫–∞—Ç–∞–ª–æ–≥–µ —Ç–æ–≤–∞—Ä—ã –∞–∫—Ü–∏–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è –±–µ–π–¥–∂–µ–º ¬´üî• –ê–ö–¶–ò–Ø¬ª, –∞ –Ω–∞–¥ –∫–∞—Ç–∞–ª–æ–≥–æ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞—Ä—É—Å–µ–ª—å –∞–∫—Ü–∏–π; –∫–ª–∏–∫ –ø–æ –±–∞–Ω–Ω–µ—Ä—É –æ—Ç—Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–æ–≤–∞—Ä—ã —ç—Ç–æ–π –∞–∫—Ü–∏–∏.
                </div>
              </div>
            </div>`;
          await Utils.showModal('–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ü–†–û–ú–û', c, [{label:'–ü–æ–Ω—è—Ç–Ω–æ'}]);
        });

        // --- –ú–∞—Ä—à—Ä—É—Ç—ã (Routes) ---
        const routesSpinner = document.getElementById('routesSpinner');
        const routesProgWrap = document.getElementById('routesProgressWrap');
        const routesProg = document.getElementById('routesProgress');
        const updateRoutesProgress = (p)=>{ routesProgWrap.classList.remove('hidden'); routesProg.style.width = Math.min(100, Math.max(0, p)) + '%'; if (p>=100) setTimeout(()=>routesProgWrap.classList.add('hidden'), 600); };

        /**
         * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç email.
         * @param {any} v
         * @returns {string}
         */
        function normalizeEmail(v){ return String(v ?? '').trim().toLowerCase(); }

        /**
         * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1..5.
         * @param {any} v
         * @returns {number}
         */
        function normalizePriority(v){
          const n = Number(String(v ?? '').toString().replace(',','.'));
          if (!isFinite(n)) return 3;
          return Utils.clamp(Math.round(n), 1, 5);
        }

        /**
         * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏: 1..7 (–ü–Ω..–í—Å).
         * @param {any} v
         * @returns {number|null}
         */
        function normalizeDayOfWeek(v){
          const n = Number(String(v ?? '').trim().replace(',','.'));
          if (!isFinite(n)) return null;
          const x = Math.round(n);
          if (x < 1 || x > 7) return null;
          return x;
        }

        /**
         * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –Ω–µ–¥–µ–ª—å–Ω—ã–π –∫–æ–¥: 1 | 2.1 | 2.2 | 4.1..4.4
         * @param {any} v
         * @returns {string}
         */
        function normalizeWeekCode(v){
          return Scheduler.normalizeWeekCode(v);
        }

        /**
         * Legacy: –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–Ω—è (1/0, –¥–∞/–Ω–µ—Ç) –≤ boolean.
         * @param {any} v
         * @returns {boolean}
         */
        function parseLegacyDayVal(v){
          const s = String(v ?? '').trim().toLowerCase();
          return s === '1' || s === '–¥–∞' || s === 'true' || s === 'yes' || s === 'y' || s === 'x';
        }

        /**
         * –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Å—Ç—Ä–æ–∫–∏ Excel –≤ –∑–∞–ø–∏—Å—å –º–∞—Ä—à—Ä—É—Ç–∞ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–π –∏ —Å—Ç–∞—Ä—ã–π —à–∞–±–ª–æ–Ω).
         * –ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω:
         * - –ö–æ–¥ —Ç–æ—á–∫–∏
         * - –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (1..7)
         * - –û–ø–µ—Ä–∞—Ç–æ—Ä (email)
         * - –ß–∞—Å—Ç–æ—Ç–∞ (1 / 2.1 / 2.2 / 4.1..4.4)
         * - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (1..5)
         *
         * –°—Ç–∞—Ä—ã–π —à–∞–±–ª–æ–Ω (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å):
         * - –ö–æ–¥ —Ç–æ—á–∫–∏
         * - –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫..–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ (1/0)
         * - –û–ø–µ—Ä–∞—Ç–æ—Ä (email)
         * - –ß–∞—Å—Ç–æ—Ç–∞ (–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ/—Ä–∞–∑ –≤ 2 –Ω–µ–¥–µ–ª–∏/—Ä–∞–∑ –≤ –º–µ—Å—è—Ü)
         * - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
         *
         * @param {Object} row
         * @returns {Object|null}
         */
        function rowToRoute(row){
          const outletCode = String(row['–ö–æ–¥ —Ç–æ—á–∫–∏'] ?? row['–ö–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞'] ?? row['–ö–æ–¥'] ?? '').trim();
          if (!outletCode) return null;

          // new format (single day)
          const dayOfWeek = normalizeDayOfWeek(row['–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏'] ?? row['–î–µ–Ω—å'] ?? row['DayOfWeek']);
          const op = normalizeEmail(row['–û–ø–µ—Ä–∞—Ç–æ—Ä (email)'] ?? row['–û–ø–µ—Ä–∞—Ç–æ—Ä'] ?? row['operatorEmail'] ?? '');
          const freq = normalizeWeekCode(row['–ß–∞—Å—Ç–æ—Ç–∞'] ?? row['–¶–∏–∫–ª'] ?? row['frequency'] ?? '1');
          const priority = normalizePriority(row['–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'] ?? 3);

          if (dayOfWeek){
            return {
              outletCode,
              dayOfWeek,
              operatorEmail: op,
              frequency: freq,
              priority,
              lastVisitDate: null,
              nextPlannedDate: null,
              updatedAt: Date.now()
            };
          }

          // legacy format: days columns
          const schedule = {
            mon: parseLegacyDayVal(row['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫']),
            tue: parseLegacyDayVal(row['–í—Ç–æ—Ä–Ω–∏–∫']),
            wed: parseLegacyDayVal(row['–°—Ä–µ–¥–∞']),
            thu: parseLegacyDayVal(row['–ß–µ—Ç–≤–µ—Ä–≥']),
            fri: parseLegacyDayVal(row['–ü—è—Ç–Ω–∏—Ü–∞']),
            sat: parseLegacyDayVal(row['–°—É–±–±–æ—Ç–∞']),
            sun: parseLegacyDayVal(row['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'])
          };
          // Convert legacy schedule -> daysOfWeek array if possible
          const daysOfWeekArr = [];
          if (schedule.mon) daysOfWeekArr.push(1);
          if (schedule.tue) daysOfWeekArr.push(2);
          if (schedule.wed) daysOfWeekArr.push(3);
          if (schedule.thu) daysOfWeekArr.push(4);
          if (schedule.fri) daysOfWeekArr.push(5);
          if (schedule.sat) daysOfWeekArr.push(6);
          if (schedule.sun) daysOfWeekArr.push(7);

          return {
            outletCode,
            daysOfWeek: daysOfWeekArr,
            // keep schedule for backwards compatibility display, but scheduler will prefer dayOfWeek/daysOfWeek
            schedule,
            operatorEmail: op,
            // map text frequency to new code
            frequency: Scheduler.normalizeWeekCode(row['–ß–∞—Å—Ç–æ—Ç–∞'] ?? '1'),
            priority,
            lastVisitDate: null,
            nextPlannedDate: null,
            updatedAt: Date.now()
          };
        }

        /**
         * –≠–∫—Å–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç–∞ –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è Excel (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç).
         * @param {Object} r
         * @returns {Array<any>}
         */
        function routeToRowsNew(r){
          const base = {
            outletCode: r.outletCode || '',
            operatorEmail: r.operatorEmail || '',
            frequency: Scheduler.normalizeWeekCode(r.frequency || '1'),
            priority: normalizePriority(r.priority || 3)
          };
          // One route can contain multiple days (daysOfWeek), export as separate rows.
          const days = (r.dayOfWeek ? [Number(r.dayOfWeek)] : (Array.isArray(r.daysOfWeek) ? r.daysOfWeek.map(Number) : []))
            .filter(n=>n>=1 && n<=7);
          if (!days.length) return [[base.outletCode, '', base.operatorEmail, base.frequency, base.priority]];
          return days.map(dow => [base.outletCode, dow, base.operatorEmail, base.frequency, base.priority]);
        }

        // –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω –º–∞—Ä—à—Ä—É—Ç–æ–≤ (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç + –ø—Ä–∏–º–µ—Ä)
        document.getElementById('routesTemplateBtn')?.addEventListener('click', async ()=>{
          const headers = ['–ö–æ–¥ —Ç–æ—á–∫–∏','–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏','–û–ø–µ—Ä–∞—Ç–æ—Ä (email)','–ß–∞—Å—Ç–æ—Ç–∞','–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'];
          const example = ['OUT-001', 1, 'operator@bigtelesales.local', '1', 1];
          try {
            await downloadExcelTemplate(headers, '–ú–∞—Ä—à—Ä—É—Ç—ã', 'template_routes', [example]);
          } catch(e){
            console.error('routesTemplateBtn error', e);
            Utils.showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω –º–∞—Ä—à—Ä—É—Ç–æ–≤ (Excel).', 'error');
          }
        });

        // –ò–º–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç–æ–≤
        document.getElementById('routesImportBtn')?.addEventListener('click', ()=>{
          const input = document.createElement('input'); input.type='file'; input.accept='.xlsx,.xls';
          input.onchange = async ()=>{
            const file = input.files?.[0];
            if (!file) return;
            routesSpinner?.classList.remove('hidden');
            updateRoutesProgress(0);
            try {
              const json = await readExcelToJson(file);
              let imported = 0;
              let idx = 0;
              const total = json.length || 1;
              for (const row of json){
                idx++;
                const route = rowToRoute(row);
                if (!route) { updateRoutesProgress(Math.round(idx/total*100)); continue; }

                // If route.daysOfWeek provided (legacy schedule), store as one record per outletCode (merged)
                if (Array.isArray(route.daysOfWeek) && route.daysOfWeek.length){
                  // Merge with existing record
                  const existing = await Storage.get('routes', route.outletCode).catch(()=>null);
                  const mergedDays = new Set([...(existing?.daysOfWeek||[]), ...(route.daysOfWeek||[])]);
                  const merged = {
                    ...(existing||{}),
                    ...route,
                    daysOfWeek: Array.from(mergedDays).sort((a,b)=>a-b),
                    updatedAt: Date.now()
                  };
                  delete merged.dayOfWeek;
                  await Storage.put('routes', merged);
                } else {
                  // New format: single dayOfWeek.
                  // Store multiple days per outlet in one record by merging into daysOfWeek array.
                  const existing = await Storage.get('routes', route.outletCode).catch(()=>null);
                  const mergedDays = new Set([...(existing?.daysOfWeek||[]), ...(existing?.dayOfWeek?[existing.dayOfWeek]:[]), route.dayOfWeek]);
                  const merged = {
                    ...(existing||{}),
                    outletCode: route.outletCode,
                    daysOfWeek: Array.from(mergedDays).filter(Boolean).map(Number).sort((a,b)=>a-b),
                    operatorEmail: route.operatorEmail,
                    frequency: route.frequency,
                    priority: route.priority,
                    lastVisitDate: existing?.lastVisitDate ?? null,
                    nextPlannedDate: existing?.nextPlannedDate ?? null,
                    updatedAt: Date.now()
                  };
                  delete merged.dayOfWeek;
                  await Storage.put('routes', merged);
                }

                imported++;
                updateRoutesProgress(Math.round(idx/total*100));
              }
              Utils.showToast(`–ú–∞—Ä—à—Ä—É—Ç—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã: ${imported}`, 'success');
              try {
                await window.Notifications?.createNotification?.({
                  type: window.Notifications?.NOTIFICATION_TYPES?.ROUTE_UPDATED || 'route_updated',
                  title: '–ú–∞—Ä—à—Ä—É—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã',
                  message: `–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –º–∞—Ä—à—Ä—É—Ç–æ–≤: ${imported}`,
                  actionUrl: 'televisits'
                });
              } catch(_){ }
              await refreshAdminCounts();
              try { await Scheduler.recalculatePlannedVisits(7); } catch(_){ }
            } catch(e){
              console.error('routesImportBtn error', e);
              Utils.showToast(String(e?.message||'–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤') + '. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ .xlsx –∏–ª–∏ .xls –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å —à–∞–±–ª–æ–Ω–æ–º.', 'error');
            } finally {
              routesSpinner?.classList.add('hidden');
              setTimeout(()=>updateRoutesProgress(100), 80);
            }
          };
          input.click();
        });

        // –≠–∫—Å–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç–æ–≤ (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç)
        document.getElementById('routesExportBtn')?.addEventListener('click', async ()=>{
          const headers = ['–ö–æ–¥ —Ç–æ—á–∫–∏','–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏','–û–ø–µ—Ä–∞—Ç–æ—Ä (email)','–ß–∞—Å—Ç–æ—Ç–∞','–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç'];
          try {
            const ok = await requireXLSX();
            if (!ok) return;
            const routes = await Storage.getAll('routes').catch(()=>[]);
            const rows = (routes||[]).flatMap(routeToRowsNew);
            const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '–ú–∞—Ä—à—Ä—É—Ç—ã');
            Utils.saveWorkbookXLSX(wb, 'routes.xlsx');
            Utils.showToast('–≠–∫—Å–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
          } catch(e){
            console.error('routesExportBtn error', e);
            Utils.showToast('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤', 'error');
          }
        });

        // –û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã
        document.getElementById('routesClearBtn')?.addEventListener('click', async ()=>{
          const ok = await Utils.showModal('–û—á–∏—Å—Ç–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤', '–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–∞—Ä—à—Ä—É—Ç—ã?', [
            {label:'–û—Ç–º–µ–Ω–∞', value:false, class:'border px-3 py-1.5 rounded-lg hover:bg-gray-50'},
            {label:'–û—á–∏—Å—Ç–∏—Ç—å', value:true, class:'bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg'}
          ]);
          if (!ok) return;
          await Storage.clearStore('routes');
          await refreshAdminCounts();
          Utils.showToast('–ú–∞—Ä—à—Ä—É—Ç—ã –æ—á–∏—â–µ–Ω—ã', 'info');
        });

        /**
         * –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤–∏–∑–∏—Ç–æ–≤: –æ—á–∏—â–∞–µ—Ç store visits –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞–Ω–æ–≤—ã–µ –≤–∏–∑–∏—Ç—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.
         * –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤ –¢–µ–ª–µ–≤–∏–∑–∏—Ç–∞—Ö —Å—Ä–∞–∑—É —É–≤–∏–¥–µ—Ç—å —Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –ø–æ –º–∞—Ä—à—Ä—É—Ç–∞–º.
         */
        document.getElementById('routesClearVisitsBtn')?.addEventListener('click', async ()=>{
          const ok = await Utils.showModal('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤–∏–∑–∏—Ç–æ–≤',
            '–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –≤–∏–∑–∏—Ç—ã (–∏—Å—Ç–æ—Ä–∏—é –∑–≤–æ–Ω–∫–æ–≤) –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ ¬´–¢–µ–ª–µ–≤–∏–∑–∏—Ç—ã¬ª? –ë—É–¥–µ—Ç –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω –ø–ª–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –ø–æ –º–∞—Ä—à—Ä—É—Ç–∞–º.',
            [
              {label:'–û—Ç–º–µ–Ω–∞', value:false, class:'border px-3 py-1.5 rounded-lg hover:bg-gray-50'},
              {label:'–û—á–∏—Å—Ç–∏—Ç—å', value:true, class:'bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg'}
            ]
          );
          if (!ok) return;
          try {
            await Storage.clearStore('visits');
            // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –ø–ª–∞–Ω–æ–≤—ã–µ –≤–∏–∑–∏—Ç—ã –Ω–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å (—Å —É—á–µ—Ç–æ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
            try { await Scheduler.generatePlannedVisits(new Date()); } catch(_){ }
            // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
            try { AnalyticsPrecalc.invalidate(); } catch(_){ }
            Utils.showToast('–ò—Å—Ç–æ—Ä–∏—è –≤–∏–∑–∏—Ç–æ–≤ –æ—á–∏—â–µ–Ω–∞. –ü–ª–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω.', 'success');
          } catch(e){
            console.error('routesClearVisitsBtn error', e);
            Utils.showToast('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –≤–∏–∑–∏—Ç–æ–≤', 'error');
          }
        });

        // –ü—Ä–æ—Å–º–æ—Ç—Ä –º–∞—Ä—à—Ä—É—Ç–æ–≤ (–Ω–æ–≤–∞—è –º–æ–¥–µ–ª—å)
        document.getElementById('routesViewBtn')?.addEventListener('click', async ()=>{
          const [routes, outlets] = await Promise.all([
            Storage.getAll('routes').catch(()=>[]),
            Storage.getAll('outlets').catch(()=>[])
          ]);
          const outletsByCode = new Map((outlets||[]).map(o=>[o.code, o]));

          const c = document.createElement('div');
          c.innerHTML = `
            <div class="space-y-3">
              <div class="flex flex-wrap gap-2 items-center">
                <div class="flex items-center gap-2 flex-1 min-w-[220px]">
                  <span>üîç</span>
                  <input id="rtSearch" class="border rounded-lg px-3 py-1.5 w-full" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É/–Ω–∞–∑–≤–∞–Ω–∏—é/–æ–ø–µ—Ä–∞—Ç–æ—Ä—É" />
                </div>
                <select id="rtOp" class="border rounded-lg px-3 py-1.5 text-sm">
                  <option value="">–í—Å–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã</option>
                </select>
                <select id="rtDay" class="border rounded-lg px-3 py-1.5 text-sm">
                  <option value="">–í—Å–µ –¥–Ω–∏</option>
                  <option value="1">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option>
                  <option value="2">–í—Ç–æ—Ä–Ω–∏–∫</option>
                  <option value="3">–°—Ä–µ–¥–∞</option>
                  <option value="4">–ß–µ—Ç–≤–µ—Ä–≥</option>
                  <option value="5">–ü—è—Ç–Ω–∏—Ü–∞</option>
                  <option value="6">–°—É–±–±–æ—Ç–∞</option>
                  <option value="7">–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</option>
                </select>
                <select id="rtFreq" class="border rounded-lg px-3 py-1.5 text-sm">
                  <option value="">–í—Å–µ —Ü–∏–∫–ª—ã</option>
                  <option value="1">1 (–∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é)</option>
                  <option value="2.1">2.1 (–Ω–µ—á–µ—Ç–Ω—ã–µ –Ω–µ–¥–µ–ª–∏)</option>
                  <option value="2.2">2.2 (—á–µ—Ç–Ω—ã–µ –Ω–µ–¥–µ–ª–∏)</option>
                  <option value="4.1">4.1 (1-—è –Ω–µ–¥–µ–ª—è 4-–Ω–µ–¥. —Ü–∏–∫–ª–∞)</option>
                  <option value="4.2">4.2 (2-—è –Ω–µ–¥–µ–ª—è 4-–Ω–µ–¥. —Ü–∏–∫–ª–∞)</option>
                  <option value="4.3">4.3 (3-—è –Ω–µ–¥–µ–ª—è 4-–Ω–µ–¥. —Ü–∏–∫–ª–∞)</option>
                  <option value="4.4">4.4 (4-—è –Ω–µ–¥–µ–ª—è 4-–Ω–µ–¥. —Ü–∏–∫–ª–∞)</option>
                </select>
              </div>
              <div class="overflow-auto border rounded-lg">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="text-left text-gray-500">
                      <th class="py-2 px-2">–ö–æ–¥</th>
                      <th class="py-2 px-2">–¢–æ—á–∫–∞</th>
                      <th class="py-2 px-2">–î–Ω–∏ (1..7)</th>
                      <th class="py-2 px-2">–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
                      <th class="py-2 px-2">–¶–∏–∫–ª</th>
                      <th class="py-2 px-2">–ü—Ä–∏–æ—Ä.</th>
                      <th class="py-2 px-2">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                  </thead>
                  <tbody id="rtBody"></tbody>
                </table>
              </div>
              <div class="text-xs text-gray-500">–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏: 1=–ü–Ω ‚Ä¶ 7=–í—Å. –¶–∏–∫–ª: 1 / 2.1 / 2.2 / 4.1..4.4 (ISO-–Ω–µ–¥–µ–ª–∏)</div>
            </div>
          `;

          // –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
          const opSel = c.querySelector('#rtOp');
          const uniqOps = Array.from(new Set((routes||[]).map(r=>String(r.operatorEmail||'').trim()).filter(Boolean))).sort();
          uniqOps.forEach(op=>{ const o=document.createElement('option'); o.value=op; o.textContent=op; opSel.appendChild(o); });

          const body = c.querySelector('#rtBody');
          const inp = c.querySelector('#rtSearch');
          const daySel = c.querySelector('#rtDay');
          const freqSel = c.querySelector('#rtFreq');

          const render = ()=>{
            const q = String(inp.value||'').toLowerCase().trim();
            const op = opSel.value;
            const day = daySel.value;
            const freq = freqSel.value;
            const list = (routes||[])
              .filter(r=> !op || String(r.operatorEmail||'')===op)
              .filter(r=> !freq || Scheduler.normalizeWeekCode(r.frequency||'1') === Scheduler.normalizeWeekCode(freq))
              .filter(r=>{
                if (!day) return true;
                const d = Number(day);
                const days = (r.dayOfWeek ? [Number(r.dayOfWeek)] : (Array.isArray(r.daysOfWeek) ? r.daysOfWeek.map(Number) : []));
                return days.includes(d);
              })
              .filter(r=>{
                if (!q) return true;
                const outlet = outletsByCode.get(r.outletCode) || {};
                const hay = [r.outletCode, outlet.name, outlet.address, r.operatorEmail, r.frequency].map(x=>String(x||'').toLowerCase()).join(' ');
                return hay.includes(q);
              })
              .sort((a,b)=> Number(a.priority||9)-Number(b.priority||9) || String(a.outletCode||'').localeCompare(String(b.outletCode||'')));

            body.innerHTML='';
            list.forEach(r=>{
              const outlet = outletsByCode.get(r.outletCode) || {};
              const days = (r.dayOfWeek ? [Number(r.dayOfWeek)] : (Array.isArray(r.daysOfWeek) ? r.daysOfWeek.map(Number) : []))
                .filter(n=>n>=1 && n<=7)
                .sort((a,b)=>a-b);
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td class="py-2 px-2">${r.outletCode}</td>
                <td class="py-2 px-2">${outlet.name||''}</td>
                <td class="py-2 px-2">${days.length? days.join(', ') : '‚Äî'}</td>
                <td class="py-2 px-2">${r.operatorEmail||''}</td>
                <td class="py-2 px-2">${Scheduler.normalizeWeekCode(r.frequency||'1')}</td>
                <td class="py-2 px-2">${r.priority||''}</td>
                <td class="py-2 px-2">
                  <button data-del="${r.outletCode}" class="text-sm text-red-600 hover:text-red-700">–£–¥–∞–ª–∏—Ç—å</button>
                </td>
              `;
              body.appendChild(tr);
            });
          };

          inp.addEventListener('input', Utils.debounce(render, 200));
          opSel.addEventListener('change', render);
          daySel.addEventListener('change', render);
          freqSel.addEventListener('change', render);
          body.addEventListener('click', async (e)=>{
            const btn = e.target.closest('button[data-del]');
            if (!btn) return;
            const code = btn.getAttribute('data-del');
            const ok = await Utils.showModal('–£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞', `–£–¥–∞–ª–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –¥–ª—è —Ç–æ—á–∫–∏ ${code}?`, [
              {label:'–û—Ç–º–µ–Ω–∞', value:false, class:'border px-3 py-1.5 rounded-lg hover:bg-gray-50'},
              {label:'–£–¥–∞–ª–∏—Ç—å', value:true, class:'bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg'}
            ]);
            if (!ok) return;
            await Storage.del('routes', code);
            const idx = (routes||[]).findIndex(r=>String(r.outletCode)===String(code));
            if (idx>=0) routes.splice(idx,1);
            await refreshAdminCounts();
            render();
          });

          render();
          await Utils.showModal('üìã –ú–∞—Ä—à—Ä—É—Ç—ã', c, [{label:'–ó–∞–∫—Ä—ã—Ç—å', value:false}]);
        });

        // --- –ú–∞—Ç–µ—Ä–∏–∞–ª—ã —Ç–∞–±–ª–∏—Ü–∞ ---
        const matTbody = document.getElementById('materialsTableBody');
        async function renderMaterials(){
          const rec = await Storage.get('settings', 'materials');
          const items = rec?.value || [];
          matTbody.innerHTML='';
          if (!items.length){ matTbody.innerHTML = `<tr><td class="py-2 pr-2 text-gray-500" colspan="4">–ù–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</td></tr>`; return; }
          items.forEach((m, idx)=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="py-2 pr-2">${m.name||('–§–∞–π–ª '+(idx+1))}</td>
              <td class="py-2 pr-2">${m.size? Utils.humanFileSize(m.size): '‚Äî'}</td>
              <td class="py-2 pr-2">${m.createdAt? Utils.formatDate(m.createdAt, 'dd.MM.yyyy'):'‚Äî'}</td>
              <td class="py-2 pr-2">
                <a href="${m.url}" target="_blank" class="text-sm text-indigo-600 hover:text-indigo-700">–û—Ç–∫—Ä—ã—Ç—å</a>
                <button class="ml-2 text-sm text-red-600 hover:text-red-700" data-action="del" data-idx="${idx}">–£–¥–∞–ª–∏—Ç—å</button>
              </td>`;
            matTbody.appendChild(tr);
          });
        }
        await renderMaterials();
        document.getElementById('addFileBtn').addEventListener('click', ()=> document.getElementById('addFileInput').click());
        document.getElementById('addFileInput').addEventListener('change', async (e)=>{
          const f = e.target.files[0]; if (!f) return;
          const url = await fileToDataURL(f);
          const rec = await Storage.get('settings','materials') || { key:'materials', value: [] };
          rec.value.push({ name: f.name, url, size: f.size, createdAt: Date.now() }); await Storage.put('settings', rec);
          try {
            await window.Notifications?.createNotification?.({
              type: window.Notifications?.NOTIFICATION_TYPES?.NEW_MATERIAL || 'new_material',
              title: '–ù–æ–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª',
              message: `–î–æ–±–∞–≤–ª–µ–Ω —Ñ–∞–π–ª: ${f.name}`,
              actionUrl: 'admin'
            });
          } catch(_){ }
          Utils.showToast('–§–∞–π–ª –¥–æ–±–∞–≤–ª–µ–Ω', 'success'); await renderMaterials();
        });
        matTbody.addEventListener('click', async (e)=>{
          const btn = e.target.closest('button[data-action="del"]'); if (!btn) return; const idx = Number(btn.getAttribute('data-idx'));
          const rec = await Storage.get('settings','materials'); if (!rec) return; rec.value.splice(idx,1); await Storage.put('settings', rec); await renderMaterials();
        });

        // Backup UI (Admin)
        try { await window.Backup?.initAdminUI?.(); } catch(e){ console.warn('Backup init failed', e); }
      }

      return { analytics, televisits, catalog, orders, admin };
    })();

    // Wiring pages to router
    Router.onBeforeNavigate(({ from, to }) => {
      // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã/—Ä–µ—Å—É—Ä—Å—ã —Å—Ç—Ä–∞–Ω–∏—Ü –ø—Ä–∏ —É—Ö–æ–¥–µ
      if (from === 'televisits'){
        try { if (window.__tvInterval) { clearInterval(window.__tvInterval); window.__tvInterval = null; } } catch(_){ }
      }
      if (from === 'catalog'){
        // best-effort: –¥–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥—É –æ—á–∏—Å—Ç–∏—Ç—å IntersectionObserver
        try { window.__btsCatalogCleanup?.(); } catch(_){ }
      }
    });

    Router.onAfterNavigate(async ({ page, params }) => {
      try {
        let handled = false;
        // –ü—ã—Ç–∞–µ–º—Å—è –ª–µ–Ω–∏–≤–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥—É–ª—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã (js/pages/<page>.js)
        try {
          const mod = await import(`./js/pages/${page}.js`);
          const fn = (mod && (mod.default || mod[page])) || null;
          if (typeof fn === 'function') {
            await fn(params || {});
            handled = true;
          }
        } catch(_){ /* fallback –Ω–∏–∂–µ */ }

        // Fallback: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä, –µ—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
        if (!handled && Pages[page]) await Pages[page](params||{});
      } catch (e){ console.error(e); Utils.showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã', 'error'); }
    });

    // Start app
    window.addEventListener('DOMContentLoaded', () => { App.start(); });
  </script>
</body>
</html>
